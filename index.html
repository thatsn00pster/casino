<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Casino - Fun Arcade</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #8b5cf6;
            --bg-dark: #0b0e14;
            --bg-panel: #161b26;
            --border: #2a3042;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #000;
            color: #b1bad3;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, #eee, transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent),
                radial-gradient(circle at 50% 50%, rgba(139,92,246,0.08) 0%, transparent 50%),
                linear-gradient(135deg, #0f0720 0%, #000 100%);
            background-repeat: repeat, repeat, repeat, repeat, repeat, no-repeat, no-repeat;
            background-size: 200px 200px, 300px 300px, 400px 400px, 350px 350px, 250px 250px, 100% 100%, 100% 100%;
            animation: stars 120s linear infinite;
            position: relative;
            overflow-x: hidden;
        }
        
        @keyframes stars {
            from { background-position: 0 0, 0 0, 0 0, 0 0, 0 0, 0 0, 0 0; }
            to { background-position: 200px 200px, 300px 300px, 400px 400px, 350px 350px, 250px 250px, 0 0, 0 0; }
        }
        
        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 70%, rgba(139,92,246,0.15), transparent 40%),
                        radial-gradient(circle at 80% 20%, rgba(34,211,238,0.12), transparent 50%);
            pointer-events: none;
            animation: nebula 25s ease-in-out infinite alternate;
        }
        
        @keyframes nebula {
            0% { opacity: 0.4; transform: scale(1) rotate(0deg); }
            100% { opacity: 0.7; transform: scale(1.1) rotate(5deg); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0b0e14;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2a3042;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #3a4259;
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            transition: all 0.18s;
            font-weight: 600;
            border: 1px solid #8b5cf6;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 0 20px rgba(139,92,246,0.35);
        }
        
        /* Game Card */
        .game-card {
            transition: all 0.28s;
            background: linear-gradient(145deg, #161b26, #11141c);
            border: 1px solid var(--border);
        }
        
        .game-card:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: #8b5cf6;
            box-shadow: 0 0 25px rgba(110,86,207,0.25);
        }
        
        /* Mines Grid */
        .mines-grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .mine-tile-modern {
            aspect-ratio: 1;
            background: #1f2937;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all .18s;
            box-shadow: 0 4px 0 #111827;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid rgba(255,255,255,0.03);
        }
        
        .mine-tile-modern.revealed {
            transform: translateY(4px);
            box-shadow: none;
            cursor: default;
        }
        
        .mine-tile-modern.gem {
            background: #064e3b;
            border: 2px solid #10b981;
        }
        
        .mine-tile-modern.mine {
            background: #7f1d1d;
            border: 2px solid #ef4444;
        }
        
        /* Plinko Styles */
        .plinko-board {
            position: relative;
            width: 100%;
            height: 600px;
            background: linear-gradient(135deg, #1a237e, #0d0f25);
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #3949ab;
        }
        
        .plinko-pegs-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 100px;
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 4px;
            padding: 20px;
        }
        
        .plinko-peg {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at 30% 30%, #ffeb3b, #f57f17);
            border-radius: 50%;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
        }
        
        .plinko-ball {
            position: absolute;
            width: 24px;
            height: 24px;
            background: radial-gradient(circle at 30% 30%, #ff5252, #d32f2f);
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 0 15px rgba(255, 82, 82, 0.7);
            transition: transform 0.1s linear;
        }
        
        .plinko-slots {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .plinko-slot {
            width: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        
        /* Towers Game */
        .towers-game {
            background: linear-gradient(135deg, #1b5e20, #0a2e0a);
            border-radius: 20px;
            padding: 30px;
            border: 3px solid #4caf50;
            position: relative;
            min-height: 500px;
        }
        
        .tower-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .tower-block {
            width: 80px;
            height: 40px;
            background: linear-gradient(135deg, #795548, #5d4037);
            border-radius: 5px;
            border: 2px solid #3e2723;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #3e2723;
        }
        
        .tower-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3e2723;
        }
        
        .tower-block.selected {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            border-color: #ff9800;
            animation: pulse 1s infinite;
        }
        
        /* Crossy Road Game */
        .crossy-road-game {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
            border-radius: 20px;
            padding: 20px;
            border: 3px solid #2196f3;
            position: relative;
            overflow: hidden;
            min-height: 500px;
        }
        
        .crossy-road-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 2px;
            width: 400px;
            height: 400px;
            margin: 0 auto;
            background: #1e88e5;
            border: 2px solid #1565c0;
        }
        
        .crossy-road-cell {
            background: #64b5f6;
            border: 1px solid #42a5f5;
            position: relative;
        }
        
        .crossy-road-cell.road {
            background: #546e7a;
        }
        
        .crossy-road-cell.grass {
            background: #43a047;
        }
        
        .crossy-road-cell.water {
            background: #0288d1;
        }
        
        .crossy-road-player {
            position: absolute;
            width: 80%;
            height: 80%;
            background: #ff5722;
            border-radius: 50%;
            top: 10%;
            left: 10%;
            z-index: 10;
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.7);
        }
        
        .crossy-road-obstacle {
            position: absolute;
            width: 90%;
            height: 90%;
            background: #f44336;
            top: 5%;
            left: 5%;
            z-index: 5;
            border-radius: 3px;
        }
        
        /* Animations */
        @keyframes bounce-in {
            0% { transform: scale(.9); opacity: 0; }
            60% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        .animate-bounce-in {
            animation: bounce-in .35s cubic-bezier(.175,.885,.32,1.275) forwards;
        }
        
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .animate-slide-up {
            animation: slide-up .28s ease-out forwards;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1e293b;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            border: 2px solid #334155;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
        }
        
        .sound-toggle.muted {
            background: #ef4444;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: #161b26;
            border-radius: 1rem;
            border: 1px solid #2a3042;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease-out;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .toast.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* Win/Loss Notification in Chat */
        .big-win-notification {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        .big-win-notification .username {
            color: #fbbf24;
            font-weight: bold;
            font-size: 16px;
        }
        
        .big-win-notification .amount {
            color: #10b981;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .mines-grid-container {
                gap: 8px;
                max-width: 300px;
            }
            
            .card-container {
                width: 70px;
                height: 100px;
            }
            
            .plinko-board {
                height: 400px;
            }
            
            .crossy-road-grid {
                width: 300px;
                height: 300px;
            }
            
            .tower-block {
                width: 60px;
                height: 30px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Sound Toggle -->
    <div class="sound-toggle" id="soundToggle" onclick="app.toggleSound()">
        <i class="fa-solid fa-volume-high"></i>
    </div>

    <!-- Navbar -->
    <nav class="h-16 bg-[#161b26]/90 backdrop-blur-xl flex items-center justify-between px-4 md:px-6 shadow-xl border-b border-[#2a3042] sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <button class="text-gray-400 hover:text-white md:hidden" onclick="app.toggleSidebar()">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.loadGame('home')">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#8b5cf6] to-[#4c1d95] flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-moon text-white text-sm"></i>
                </div>
                <div class="text-xl md:text-2xl font-bold text-white">
                    Moon<span class="text-[#8b5cf6]">Casino</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="hidden md:flex bg-[#0b0e14] rounded-full px-1 py-1 items-center gap-2 border border-[#2a3042]">
                <div class="bg-[#1e2533] rounded-full px-4 py-1.5 flex items-center gap-2 min-w-[140px] justify-between cursor-pointer hover:bg-[#2a3042]" onclick="app.openDepositModal()">
                    <span class="text-[#8b5cf6] text-xs font-bold">COINS</span>
                    <span class="text-white font-mono font-bold" id="balanceDisplay">500</span>
                </div>
                <button onclick="app.openDepositModal()" class="bg-[#8b5cf6] hover:bg-[#7c3aed] text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg">
                    Wallet
                </button>
            </div>
            <button class="md:hidden text-white bg-[#1e2533] p-2 rounded-lg border border-[#2a3042]" onclick="app.openDepositModal()">
                <i class="fa-solid fa-wallet text-[#8b5cf6]"></i>
            </button>
            <button class="text-gray-400 hover:text-white ml-2" onclick="app.toggleChat()">
                <i class="fa-solid fa-message text-lg"></i>
            </button>
            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-teal-400 flex items-center justify-center text-white font-bold text-xs border-2 border-[#161b26]" id="userAvatar">
                U
            </div>
            <button onclick="app.logout()" class="text-gray-400 hover:text-white ml-2">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </nav>
    
    <!-- Layout -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute md:relative inset-y-0 left-0 z-30 w-64 bg-[#161b26]/90 backdrop-blur-xl border-r border-[#2a3042] transform -translate-x-full md:translate-x-0 flex flex-col transition-transform duration-300">
            <div class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
                <div class="text-xs font-bold text-[#555d70] mb-4 px-2">Casino</div>
                <button onclick="app.loadGame('home')" id="nav-home" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-house w-5"></i> Home
                </button>
                <div class="h-px bg-[#2a3042] my-2 mx-2"></div>
                <button onclick="app.loadGame('mines')" id="nav-mines" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-bomb text-[#f59e0b] w-5"></i> Mines
                </button>
                <button onclick="app.loadGame('blackjack')" id="nav-blackjack" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-diamond text-[#10b981] w-5"></i> Blackjack
                </button>
                <button onclick="app.loadGame('plinko')" id="nav-plinko" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-bullseye text-[#ef4444] w-5"></i> Plinko
                </button>
                <button onclick="app.loadGame('towers')" id="nav-towers" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-layer-group text-[#8b5cf6] w-5"></i> Towers
                </button>
                <button onclick="app.loadGame('crossyroad')" id="nav-crossyroad" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-frog text-[#10b981] w-5"></i> Crossy Road
                </button>
                <button onclick="app.loadGame('activewins')" id="nav-activewins" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-chart-line text-[#f59e0b] w-5"></i> Active Wins
                </button>
                <button onclick="app.loadGame('leaderboard')" id="nav-leaderboard" class="w-full flex items-center gap-4 px-4 py-3 rounded-lg hover:bg-[#2a3042] text-[#b1bad3] hover:text-white">
                    <i class="fa-solid fa-trophy text-[#f59e0b] w-5"></i> Leaderboard
                </button>
            </div>
            <div class="p-4 bg-[#11141c] border-t border-[#2a3042]">
                <div class="flex justify-between text-xs text-[#6b7280] mb-1">
                    <span>Logged in as</span>
                    <span id="loggedUsername" class="text-[#10b981]">Guest</span>
                </div>
                <div class="text-[10px] text-center text-[#555d70] font-mono bg-[#0b0e14] p-1 rounded border border-[#2a3042] truncate">
                    <span id="userIdDisplay">Not logged in</span>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main id="mainContent" class="flex-1 overflow-y-auto p-4 md:p-6"></main>
        
        <!-- Chat -->
        <aside id="chatSidebar" class="hidden md:flex flex-col w-72 bg-[#161b26]/90 backdrop-blur-xl border-l border-[#2a3042]">
            <div class="p-4 border-b border-[#2a3042] flex justify-between items-center bg-[#11141c]/80">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-[#10b981] rounded-full"></div>
                    <span class="text-white font-bold text-sm">Global Chat</span>
                </div>
                <div class="text-xs text-[#6b7280]" id="onlineCount">0 Online</div>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm bg-[#0b0e14]/50"></div>
            <div class="p-3 bg-[#161b26] border-t border-[#2a3042]">
                <form onsubmit="app.sendChatMessage(event)" class="relative">
                    <input type="text" id="chatInput" placeholder="Type a message..." class="w-full bg-[#0b0e14] text-white pl-4 pr-10 py-3 rounded-lg border border-[#2a3042] text-sm">
                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-[#8b5cf6] p-1">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </aside>
    </div>
    
    <!-- Auth Modal -->
    <div id="authModal" class="modal active">
        <div class="modal-content p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-[#8b5cf6] to-[#4c1d95] flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-moon text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Moon Casino</h2>
                <p class="text-[#6b7280]">Please login or sign up to play</p>
            </div>
            
            <div id="loginForm" class="space-y-4">
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Email</label>
                    <input type="email" id="loginEmail" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white" placeholder="Enter your email">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Password</label>
                    <input type="password" id="loginPassword" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white" placeholder="Enter your password">
                </div>
                <button onclick="app.login()" class="w-full btn-primary py-3 rounded-xl font-bold">Login</button>
                <p class="text-center text-[#6b7280] text-sm">
                    Don't have an account? 
                    <button onclick="app.showSignup()" class="text-[#8b5cf6]">Sign up</button>
                </p>
            </div>
            
            <div id="signupForm" class="space-y-4 hidden">
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Username</label>
                    <input type="text" id="signupUsername" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white" placeholder="Choose a username">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Email</label>
                    <input type="email" id="signupEmail" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white" placeholder="Enter your email">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Password</label>
                    <input type="password" id="signupPassword" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white" placeholder="Create a password">
                </div>
                <button onclick="app.signup()" class="w-full btn-primary py-3 rounded-xl font-bold">Sign Up</button>
                <p class="text-center text-[#6b7280] text-sm">
                    Already have an account? 
                    <button onclick="app.showLogin()" class="text-[#8b5cf6]">Login</button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Wallet Modal with Rain Section -->
    <div id="depositModal" class="modal">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Wallet & Rain</h2>
                <button onclick="app.closeDepositModal()" class="text-[#6b7280] hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Balance Display -->
                <div class="bg-gradient-to-r from-[#1e293b] to-[#0f172a] rounded-xl p-4 border border-[#2a3042]">
                    <div class="text-center">
                        <div class="text-gray-400 text-sm mb-2">Your Balance</div>
                        <div class="text-white font-bold text-3xl mb-4" id="modalBalance">500</div>
                        <div class="flex gap-3">
                            <button onclick="app.addCoins(100)" class="flex-1 bg-[#1e293b] hover:bg-[#2a3042] text-white py-2 rounded-lg font-bold text-sm border border-[#2a3042]">
                                +100
                            </button>
                            <button onclick="app.addCoins(500)" class="flex-1 bg-[#1e293b] hover:bg-[#2a3042] text-white py-2 rounded-lg font-bold text-sm border border-[#2a3042]">
                                +500
                            </button>
                            <button onclick="app.addCoins(1000)" class="flex-1 bg-[#1e293b] hover:bg-[#2a3042] text-white py-2 rounded-lg font-bold text-sm border border-[#2a3042]">
                                +1000
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Free Coins Section -->
                <div class="text-center mb-4">
                    <i class="fa-solid fa-gift text-[#8b5cf6] text-5xl mb-4"></i>
                    <h3 class="text-white font-bold text-lg">Free Coins</h3>
                    <p class="text-[#6b7280] text-sm mt-2">Claim 500 free coins every hour</p>
                    <div class="mt-4 p-4 bg-[#11141c] rounded-lg border border-[#2a3042]">
                        <div class="text-white font-bold text-2xl mb-2" id="freeCoinsTimer">00:00:00</div>
                        <button id="claimCoinsBtn" onclick="app.claimFreeCoins()" class="w-full btn-primary py-3 rounded-xl font-bold disabled:opacity-50">
                            Claim 500 Coins
                        </button>
                    </div>
                </div>
                
                <!-- Rain Section -->
                <div class="border-t border-[#2a3042] pt-6">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-cloud-rain text-blue-400 text-xl"></i>
                        <h3 class="text-white font-bold text-lg">Rain System</h3>
                    </div>
                    
                    <div id="rainJoinSection" class="hidden mb-6">
                        <div class="text-center mb-4">
                            <div class="text-blue-300 text-sm mb-2">ACTIVE RAIN</div>
                            <div class="text-white font-bold text-2xl mb-1" id="rainAmount">0</div>
                            <div class="text-gray-400 text-xs">coins to be split</div>
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="text-gray-400 text-xs">Joined</div>
                                <div class="text-white font-bold" id="rainJoinedCount">0</div>
                            </div>
                            <div>
                                <div class="text-gray-400 text-xs">Time Left</div>
                                <div class="text-white font-bold" id="rainTimer">07:00</div>
                            </div>
                        </div>
                        <button onclick="app.joinRain()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 rounded-xl font-bold">
                            Join Rain
                        </button>
                    </div>
                    
                    <div id="rainCreateSection">
                        <div class="mb-4">
                            <label class="text-xs text-gray-400 font-bold mb-2 block">Rain Amount (Min 250)</label>
                            <input type="number" id="rainAmountInput" value="250" min="250" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white">
                        </div>
                        <button onclick="app.createRain()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-bold">
                            Start Rain (7 min)
                        </button>
                    </div>
                </div>
                
                <!-- Send Money -->
                <div class="border-t border-[#2a3042] pt-6">
                    <h3 class="text-white font-bold text-lg mb-4">Send Money</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-[#6b7280] font-bold mb-2 block">Recipient Username</label>
                            <input type="text" id="sendToUsername" placeholder="Enter username" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white">
                        </div>
                        <div>
                            <label class="text-xs text-[#6b7280] font-bold mb-2 block">Amount to Send</label>
                            <input type="number" id="sendAmount" placeholder="0" class="w-full bg-[#0b0e14] border border-[#2a3042] rounded-xl px-4 py-3 text-white">
                        </div>
                        <button onclick="app.sendMoney()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-xl font-bold">
                            Send Money
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Sound Effects - Using .wav files from your sounds folder
        const sounds = {
            card: new Audio('sounds/card.wav'),
            win: new Audio('sounds/win.wav'),
            lose: new Audio('sounds/lose.wav'),
            mine: new Audio('sounds/explosion.wav'),
            gem: new Audio('sounds/win.wav'),
            click: new Audio('sounds/click.wav'),
            rain: new Audio('sounds/rain.wav'),
            coin: new Audio('sounds/coin.wav'),
            plinko: new Audio('sounds/click.wav'),
            tower: new Audio('sounds/click.wav'),
            crossy: new Audio('sounds/click.wav')
        };

        // Set volume for all sounds
        Object.values(sounds).forEach(sound => {
            sound.volume = 0.5;
            sound.preload = 'auto';
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLmhwz-ocTNaZwWchcpWl3N0hJMlsskts",
            authDomain: "nebula-48dbd.firebaseapp.com",
            databaseURL: "https://nebula-48dbd-default-rtdb.firebaseio.com",
            projectId: "nebula-48dbd",
            storageBucket: "nebula-48dbd.firebasestorage.app",
            messagingSenderId: "259199297883",
            appId: "1:259199297883:web:f84fe6b2fc2ca70015d27e",
            measurementId: "G-38CB3Y2T56"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        class GameApp {
            constructor() {
                this.user = null;
                this.balance = 500;
                this.username = '';
                this.userId = '';
                this.activeGame = null;
                this.mainContent = document.getElementById('mainContent');
                this.balanceDisplay = document.getElementById('balanceDisplay');
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOpen = false;
                this.chatSidebar = document.getElementById('chatSidebar');
                this.soundEnabled = true;
                this.minesActive = false;
                this.bjInProgress = false;
                this.lastFreeCoinsClaim = 0;
                this.bigWinThreshold = 1000; // Announce wins over 1000 coins
                
                // Initialize app
                this.init();
            }

            init() {
                this.checkAuth();
                this.initChat();
                this.initRain();
                this.setupFreeCoinsTimer();
                this.listenForBigWins();
                
                // Set default home page
                this.loadGame('home');
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 768 && this.sidebarOpen && 
                        !this.sidebar.contains(e.target) && 
                        !e.target.closest('[onclick*="toggleSidebar"]')) {
                        this.toggleSidebar();
                    }
                });
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                const toggleBtn = document.getElementById('soundToggle');
                const icon = toggleBtn.querySelector('i');
                
                if (this.soundEnabled) {
                    toggleBtn.classList.remove('muted');
                    icon.className = 'fa-solid fa-volume-high';
                } else {
                    toggleBtn.classList.add('muted');
                    icon.className = 'fa-solid fa-volume-xmark';
                }
                
                this.showToast(`Sound ${this.soundEnabled ? 'enabled' : 'muted'}`, this.soundEnabled ? 'success' : 'error');
            }

            playSound(soundName) {
                if (!this.soundEnabled || !sounds[soundName]) return;
                
                try {
                    // Clone the audio to allow overlapping sounds
                    const soundClone = sounds[soundName].cloneNode();
                    soundClone.volume = sounds[soundName].volume;
                    soundClone.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Sound error:', e);
                }
            }

            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                if (this.sidebarOpen) {
                    this.sidebar.classList.remove('-translate-x-full');
                } else {
                    this.sidebar.classList.add('-translate-x-full');
                }
            }

            toggleChat() {
                this.chatSidebar.classList.toggle('hidden');
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.getElementById('toastContainer').appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            updateBalance() {
                if (this.balanceDisplay) {
                    this.balanceDisplay.textContent = this.balance.toLocaleString();
                    
                    // Update modal balance
                    const modalBalance = document.getElementById('modalBalance');
                    if (modalBalance) {
                        modalBalance.textContent = this.balance.toLocaleString();
                    }
                    
                    // Animation effect
                    this.balanceDisplay.classList.add('text-[#10b981]');
                    setTimeout(() => {
                        this.balanceDisplay.classList.remove('text-[#10b981]');
                    }, 300);
                }
                
                // Save to localStorage
                if (this.userId) {
                    localStorage.setItem(`balance_${this.userId}`, this.balance);
                    
                    // Update in Firebase if user is logged in
                    if (this.username) {
                        database.ref('users/' + this.userId + '/balance').set(this.balance);
                    }
                }
            }

            // Auth Functions
            checkAuth() {
                const savedUser = localStorage.getItem('moonCasinoUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        this.userId = user.userId;
                        this.username = user.username;
                        this.balance = parseInt(localStorage.getItem(`balance_${user.userId}`)) || 500;
                        this.updateUI();
                        this.hideAuthModal();
                    } catch (e) {
                        this.showAuthModal();
                    }
                } else {
                    this.showAuthModal();
                }
            }

            showAuthModal() {
                document.getElementById('authModal').classList.add('active');
            }

            hideAuthModal() {
                document.getElementById('authModal').classList.remove('active');
            }

            showSignup() {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
            }

            showLogin() {
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
            }

            async signup() {
                const username = document.getElementById('signupUsername').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;

                if (!username || !email || !password) {
                    this.showToast('Please fill all fields', 'error');
                    return;
                }

                if (username.length < 3) {
                    this.showToast('Username must be at least 3 characters', 'error');
                    return;
                }

                // Check if username exists
                const snapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
                if (snapshot.exists()) {
                    this.showToast('Username already taken', 'error');
                    return;
                }

                // Create user
                const userId = 'user_' + Date.now();
                const userData = {
                    userId,
                    username,
                    email,
                    password: btoa(password), // Simple encoding
                    balance: 500,
                    createdAt: Date.now(),
                    lastFreeCoins: 0,
                    totalWins: 0,
                    totalLosses: 0,
                    biggestWin: 0
                };

                await database.ref('users/' + userId).set(userData);

                // Save locally
                localStorage.setItem('moonCasinoUser', JSON.stringify({ userId, username }));
                localStorage.setItem(`balance_${userId}`, 500);

                this.userId = userId;
                this.username = username;
                this.balance = 500;
                this.lastFreeCoinsClaim = 0;

                this.updateUI();
                this.hideAuthModal();
                this.showToast('Welcome to Moon Casino!', 'success');
                this.updateOnlineStatus();
            }

            async login() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                // Find user by email
                const snapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');

                if (!snapshot.exists()) {
                    this.showToast('User not found', 'error');
                    return;
                }

                let userFound = null;
                snapshot.forEach(child => {
                    const user = child.val();
                    if (atob(user.password) === password) {
                        userFound = user;
                    }
                });

                if (!userFound) {
                    this.showToast('Invalid password', 'error');
                    return;
                }

                // Save locally
                localStorage.setItem('moonCasinoUser', JSON.stringify({
                    userId: userFound.userId,
                    username: userFound.username
                }));
                localStorage.setItem(`balance_${userFound.userId}`, userFound.balance || 500);

                this.userId = userFound.userId;
                this.username = userFound.username;
                this.balance = userFound.balance || 500;
                this.lastFreeCoinsClaim = userFound.lastFreeCoins || 0;

                this.updateUI();
                this.hideAuthModal();
                this.showToast('Welcome back!', 'success');
                this.updateOnlineStatus();
            }

            logout() {
                localStorage.removeItem('moonCasinoUser');
                localStorage.removeItem(`balance_${this.userId}`);
                this.userId = '';
                this.username = '';
                this.balance = 500;
                this.showAuthModal();
                this.updateUI();
                
                // Remove from online users
                if (this.userId) {
                    database.ref('online/' + this.userId).remove();
                }
            }

            updateUI() {
                document.getElementById('loggedUsername').textContent = this.username || 'Guest';
                document.getElementById('userIdDisplay').textContent = this.userId || 'Not logged in';
                document.getElementById('userAvatar').textContent = this.username ? this.username.charAt(0).toUpperCase() : 'U';
                this.updateBalance();
            }

            async updateOnlineStatus() {
                if (!this.userId) return;

                // Set user as online
                await database.ref('online/' + this.userId).set({
                    username: this.username,
                    lastSeen: Date.now()
                });

                // Remove after 2 minutes of inactivity
                setTimeout(() => {
                    database.ref('online/' + this.userId).remove();
                }, 120000);

                // Listen for online users
                database.ref('online').on('value', (snapshot) => {
                    const onlineCount = snapshot.numChildren();
                    document.getElementById('onlineCount').textContent = onlineCount + ' Online';
                });
            }

            // Wallet Functions
            openDepositModal() {
                if (!this.userId) {
                    this.showToast('Please login first', 'error');
                    return;
                }
                document.getElementById('depositModal').classList.add('active');
                this.updateFreeCoinsButton();
                
                // Update modal balance display
                document.getElementById('modalBalance').textContent = this.balance.toLocaleString();
            }

            closeDepositModal() {
                document.getElementById('depositModal').classList.remove('active');
            }

            addCoins(amount) {
                if (!this.userId) {
                    this.showToast('Please login first', 'error');
                    return;
                }
                
                this.balance += amount;
                this.updateBalance();
                this.showToast(`Added ${amount} coins!`, 'success');
                this.playSound('coin');
            }

            setupFreeCoinsTimer() {
                setInterval(() => {
                    this.updateFreeCoinsButton();
                }, 1000);
            }

            updateFreeCoinsButton() {
                const now = Date.now();
                const timeSinceLastClaim = now - this.lastFreeCoinsClaim;
                const oneHour = 3600000;

                const timeLeft = Math.max(0, oneHour - timeSinceLastClaim);
                const hours = Math.floor(timeLeft / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);

                const timerElement = document.getElementById('freeCoinsTimer');
                const claimButton = document.getElementById('claimCoinsBtn');

                if (timerElement) {
                    timerElement.textContent = 
                        `${hours.toString().padStart(2, '0')}:` +
                        `${minutes.toString().padStart(2, '0')}:` +
                        `${seconds.toString().padStart(2, '0')}`;
                }

                if (claimButton) {
                    const canClaim = this.balance < 100 && timeSinceLastClaim >= oneHour;
                    claimButton.disabled = !canClaim;
                    claimButton.textContent = canClaim ? 'Claim 500 Coins' : 'Not Available';
                }
            }

            async claimFreeCoins() {
                if (!this.userId) return;

                const now = Date.now();
                const oneHour = 3600000;

                if (this.balance >= 100) {
                    this.showToast('You must have less than 100 coins to claim', 'error');
                    return;
                }

                if (now - this.lastFreeCoinsClaim < oneHour) {
                    this.showToast('You can only claim once per hour', 'error');
                    return;
                }

                this.balance += 500;
                this.lastFreeCoinsClaim = now;

                // Update in database
                if (this.username) {
                    await database.ref('users/' + this.userId).update({
                        balance: this.balance,
                        lastFreeCoins: now
                    });
                }

                this.updateBalance();
                this.updateFreeCoinsButton();
                this.showToast('500 free coins claimed!', 'success');
                this.playSound('win');

                // Confetti effect
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            async sendMoney() {
                if (!this.userId) return;

                const recipientUsername = document.getElementById('sendToUsername').value.trim();
                const amount = parseFloat(document.getElementById('sendAmount').value);

                if (!recipientUsername || !amount) {
                    this.showToast('Please fill all fields', 'error');
                    return;
                }

                if (amount <= 0) {
                    this.showToast('Amount must be positive', 'error');
                    return;
                }

                if (amount > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                if (recipientUsername === this.username) {
                    this.showToast('Cannot send money to yourself', 'error');
                    return;
                }

                // Find recipient
                const snapshot = await database.ref('users').orderByChild('username').equalTo(recipientUsername).once('value');

                if (!snapshot.exists()) {
                    this.showToast('User not found', 'error');
                    return;
                }

                let recipientId = null;
                let recipient = null;
                snapshot.forEach(child => {
                    recipientId = child.key;
                    recipient = child.val();
                });

                if (!recipientId) {
                    this.showToast('User not found', 'error');
                    return;
                }

                // Update balances
                this.balance -= amount;
                const newRecipientBalance = (recipient.balance || 0) + amount;

                // Update in database
                await database.ref('users/' + this.userId + '/balance').set(this.balance);
                await database.ref('users/' + recipientId + '/balance').set(newRecipientBalance);

                this.updateBalance();
                this.showToast(`Sent ${amount} coins to ${recipientUsername}`, 'success');
                this.playSound('click');

                // Clear form
                document.getElementById('sendToUsername').value = '';
                document.getElementById('sendAmount').value = '';

                // Add transaction record
                const transaction = {
                    from: this.username,
                    to: recipientUsername,
                    amount: amount,
                    timestamp: Date.now(),
                    type: 'transfer'
                };

                await database.ref('transactions').push(transaction);

                // Add chat message
                this.addChatMessage('System', `${this.username} sent ${amount} coins to ${recipientUsername}!`, 'text-[#10b981]');
            }

            // Chat Functions
            initChat() {
                // Load chat messages
                database.ref('chat').limitToLast(50).on('value', (snapshot) => {
                    const messages = document.getElementById('chatMessages');
                    messages.innerHTML = '';

                    snapshot.forEach(child => {
                        const msg = child.val();
                        this.addChatMessage(msg.username, msg.message, msg.userId === this.userId ? 'text-[#8b5cf6]' : 'text-white', false);
                    });
                });
            }

            addChatMessage(user, msg, color = 'text-white', saveToDB = true) {
                const messages = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = `flex gap-2 ${color}`;
                div.innerHTML = `<span class="font-bold">${user}:</span> <span>${msg}</span>`;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;

                if (saveToDB && this.userId) {
                    database.ref('chat').push({
                        username: user,
                        message: msg,
                        userId: this.userId,
                        timestamp: Date.now()
                    });
                }
            }

            addBigWinNotification(username, amount, game) {
                const messages = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = 'big-win-notification';
                div.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <i class="fa-solid fa-trophy text-yellow-400"></i>
                        <div class="username">${username}</div>
                        <i class="fa-solid fa-trophy text-yellow-400"></i>
                    </div>
                    <div class="amount">${amount.toLocaleString()} coins</div>
                    <div class="text-gray-300 text-sm mt-1">won in ${game}!</div>
                `;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            sendChatMessage(e) {
                e.preventDefault();
                if (!this.userId) {
                    this.showToast('Please login to chat', 'error');
                    return;
                }

                const input = document.getElementById('chatInput');
                if (input && input.value.trim()) {
                    const msg = input.value.trim();
                    this.addChatMessage(this.username, msg, 'text-[#8b5cf6]');
                    input.value = '';
                }
            }

            // Big Win Announcements
            async recordWin(amount, game) {
                if (!this.userId || amount <= 0) return;

                // Update user stats
                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                const updates = {
                    totalWins: (user.totalWins || 0) + 1,
                    biggestWin: Math.max(user.biggestWin || 0, amount)
                };

                await userRef.update(updates);

                // Record transaction
                const transaction = {
                    userId: this.userId,
                    username: this.username,
                    amount: amount,
                    type: 'win',
                    game: game,
                    timestamp: Date.now()
                };

                await database.ref('transactions').push(transaction);

                // Announce big win in chat
                if (amount >= this.bigWinThreshold) {
                    this.addBigWinNotification(this.username, amount, game);
                    
                    // Also save as system message
                    this.addChatMessage('System', 
                        ` ${this.username} just won ${amount.toLocaleString()} coins in ${game}! `, 
                        'text-yellow-400', true);
                }
            }

            async recordLoss(amount, game) {
                if (!this.userId || amount <= 0) return;

                // Update user stats
                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                const updates = {
                    totalLosses: (user.totalLosses || 0) + 1
                };

                await userRef.update(updates);

                // Record transaction
                const transaction = {
                    userId: this.userId,
                    username: this.username,
                    amount: amount,
                    type: 'loss',
                    game: game,
                    timestamp: Date.now()
                };

                await database.ref('transactions').push(transaction);
            }

            listenForBigWins() {
                // Listen for big wins from other users
                database.ref('transactions').orderByChild('timestamp').limitToLast(10).on('child_added', (snapshot) => {
                    const transaction = snapshot.val();
                    
                    // Check if it's a big win from another user
                    if (transaction.type === 'win' && 
                        transaction.amount >= this.bigWinThreshold && 
                        transaction.userId !== this.userId) {
                        
                        // Add to chat with slight delay to avoid duplicate messages
                        setTimeout(() => {
                            this.addBigWinNotification(transaction.username, transaction.amount, transaction.game);
                        }, 1000);
                    }
                });
            }

            // Game Loading
            loadGame(gameName) {
                if (window.innerWidth < 768) {
                    this.toggleSidebar();
                }

                // Update active nav
                document.querySelectorAll('#sidebar button').forEach(b => {
                    b.classList.remove('bg-[#2a3042]', 'text-white');
                });
                const navBtn = document.getElementById(`nav-${gameName}`);
                if (navBtn) navBtn.classList.add('bg-[#2a3042]', 'text-white');

                this.activeGame = gameName;
                this.mainContent.innerHTML = '';
                this.mainContent.scrollTop = 0;

                switch (gameName) {
                    case 'home':
                        this.renderHome();
                        break;
                    case 'mines':
                        this.renderMines();
                        break;
                    case 'blackjack':
                        this.renderBlackjack();
                        break;
                    case 'plinko':
                        this.renderPlinko();
                        break;
                    case 'towers':
                        this.renderTowers();
                        break;
                    case 'crossyroad':
                        this.renderCrossyRoad();
                        break;
                    case 'activewins':
                        this.renderActiveWins();
                        break;
                    case 'leaderboard':
                        this.renderLeaderboard();
                        break;
                    default:
                        this.renderHome();
                }
            }

            renderHome() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto space-y-8 animate-slide-up">
                        <div class="rounded-2xl bg-gradient-to-r from-[#4c1d95] to-[#2e1065] p-8 md:p-12 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-96 h-96 bg-[#8b5cf6] rounded-full mix-blend-overlay filter blur-[100px] opacity-30"></div>
                            <div class="relative z-10">
                                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 border border-white/20 text-xs font-bold text-white mb-4">
                                    <span class="w-2 h-2 bg-[#10b981] rounded-full"></span> LIVE CASINO
                                </div>
                                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4">Welcome, <span class="text-[#a78bfa]">${this.username || 'Guest'}</span>!</h1>
                                <p class="text-[#d8b4fe] text-lg max-w-xl mb-8">The ultimate crypto gambling simulation. Experience fair gaming with zero risk.</p>
                                <div class="flex flex-wrap gap-4">
                                    <button onclick="app.loadGame('plinko')" class="btn-primary px-8 py-3.5 rounded-xl font-bold text-lg">
                                        <i class="fa-solid fa-bullseye mr-2"></i> Play Plinko
                                    </button>
                                    <button onclick="app.openDepositModal()" class="bg-[#1f2937] hover:bg-[#374151] text-white px-8 py-3.5 rounded-xl font-bold text-lg border border-[#374151]">
                                        Claim Free Coins
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-gamepad text-[#8b5cf6]"></i> Featured Games
                        </h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${this.getGameCard('mines', 'Mines', 'fa-bomb', 'from-[#451a03] to-[#2a1205]', 'Reveal gems, avoid bombs')}
                            ${this.getGameCard('blackjack', 'Blackjack', 'fa-diamond', 'from-[#064e3b] to-[#022c22]', 'Classic 21 vs Dealer')}
                            ${this.getGameCard('plinko', 'Plinko', 'fa-bullseye', 'from-[#1a237e] to-[#0d0f25]', 'Drop balls for big wins')}
                            ${this.getGameCard('towers', 'Towers', 'fa-layer-group', 'from-[#1b5e20] to-[#0a2e0a]', 'Build towers, win rewards')}
                            ${this.getGameCard('crossyroad', 'Crossy Road', 'fa-frog', 'from-[#1976d2] to-[#0d47a1]', 'Navigate obstacles')}
                            ${this.getGameCard('activewins', 'Active Wins', 'fa-chart-line', 'from-[#7c2d12] to-[#431407]', 'Live win tracker')}
                        </div>
                    </div>
                `;
            }

            getGameCard(id, name, icon, gradient, desc) {
                return `
                    <div onclick="app.loadGame('${id}')" class="game-card cursor-pointer rounded-xl overflow-hidden group relative h-48">
                        <div class="absolute inset-0 bg-gradient-to-br ${gradient} opacity-80 transition-opacity group-hover:opacity-100"></div>
                        <div class="absolute inset-0 p-6 flex flex-col justify-between z-10">
                            <div class="flex justify-between items-start">
                                <div class="bg-black/20 p-3 rounded-xl">
                                    <i class="fa-solid ${icon} text-2xl text-white"></i>
                                </div>
                                <i class="fa-solid fa-arrow-right text-white/50 -translate-x-2 opacity-0 group-hover:opacity-100 group-hover:translate-x-0 transition-all"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-1">${name}</h3>
                                <p class="text-white/60 text-xs">${desc}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // MINES GAME
            renderMines() {
                this.mainContent.innerHTML = `
                    <div class="max-w-4xl mx-auto flex flex-col md:flex-row gap-8 min-h-[600px] items-start animate-bounce-in">
                        <div class="w-full md:w-80 bg-[#161b26] p-6 rounded-2xl border border-[#2a3042] sticky top-6">
                            <div class="mb-6">
                                <label class="text-xs text-[#6b7280] font-bold mb-2 block">Bet Amount</label>
                                <div class="flex bg-[#0b0e14] rounded-lg border border-[#2a3042]">
                                    <div class="pl-4 py-3 text-[#6b7280] font-bold">$</div>
                                    <input type="number" id="minesBetInput" value="10" min="1" max="${this.balance}" class="w-full bg-transparent text-white px-2 font-bold outline-none">
                                    <div class="flex pr-1">
                                        <button onclick="document.getElementById('minesBetInput').value = Math.min(${this.balance}, document.getElementById('minesBetInput').value * 2)" class="px-3 text-xs font-bold text-[#6b7280]">2x</button>
                                        <button onclick="document.getElementById('minesBetInput').value = Math.max(1, document.getElementById('minesBetInput').value / 2)" class="px-3 text-xs font-bold text-[#6b7280]"></button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-8">
                                <label class="text-xs text-[#6b7280] font-bold mb-2 block">Mines (1-24)</label>
                                <div class="grid grid-cols-5 gap-2">
                                    ${[1,3,5,10,24].map(n => `
                                        <button onclick="app.setMinesCount(${n})" class="bg-[#0b0e14] border border-[#2a3042] text-[#b1bad3] rounded-lg py-2 font-bold text-sm ${n===3?'border-[#8b5cf6] text-white':''}" data-val="${n}">${n}</button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="minesCountInput" value="3">
                            </div>
                            <div class="bg-[#0b0e14] rounded-xl p-4 mb-6 border border-[#2a3042] flex justify-between items-center">
                                <div>
                                    <div class="text-[10px] text-[#6b7280]">Next Tile</div>
                                    <div class="text-[#10b981] font-bold text-xl" id="minesNextMult">1.13x</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-[#6b7280]">Total Profit</div>
                                    <div class="text-white font-bold text-xl" id="minesProfit">0</div>
                                </div>
                            </div>
                            <button id="minesBtn" onclick="app.playMines()" class="w-full btn-primary py-4 rounded-xl font-bold text-lg">Bet</button>
                        </div>
                        <div class="flex-1 w-full bg-[#161b26] rounded-2xl p-8 border border-[#2a3042] flex items-center justify-center relative overflow-hidden">
                            <div class="mines-grid-container" id="minesGrid">
                                ${Array(25).fill(0).map((_,i)=>`
                                    <div id="tile-${i}" onclick="app.clickMineTile(${i})" class="mine-tile-modern"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                this.minesActive = false;
                this.setMinesCount(3);
            }

            setMinesCount(n) {
                if (this.minesActive) return;
                document.getElementById('minesCountInput').value = n;
                document.querySelectorAll('.mine-opt-btn').forEach(b => {
                    b.classList.remove('border-[#8b5cf6]', 'text-white');
                    if (parseInt(b.dataset.val) === n) b.classList.add('border-[#8b5cf6]', 'text-white');
                });
                this.updateMinesNextMult();
            }

            updateMinesNextMult() {
                if (!this.minesActive) {
                    const m = parseInt(document.getElementById('minesCountInput').value);
                    const mult = this.calculateMinesMultiplier(m, 1);
                    document.getElementById('minesNextMult').textContent = mult.toFixed(2) + 'x';
                    return;
                }
                const m = this.minesCount;
                const r = this.minesRevealedCount + 1;
                const mult = this.calculateMinesMultiplier(m, r);
                document.getElementById('minesNextMult').textContent = mult.toFixed(2) + 'x';
            }

            calculateMinesMultiplier(mines, revealed) {
                let multiplier = 1.0;
                for (let i = 0; i < revealed; i++) multiplier *= (25 - i) / (25 - mines - i);
                return multiplier;
            }

            playMines() {
                if (!this.userId) {
                    this.showToast('Please login to play', 'error');
                    return;
                }

                if (this.minesActive) {
                    this.cashOutMines();
                    return;
                }

                const betInput = document.getElementById('minesBetInput');
                const bet = parseFloat(betInput.value);
                const mines = parseInt(document.getElementById('minesCountInput').value);

                if (isNaN(bet) || bet <= 0) return;
                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                this.playSound('click');
                this.balance -= bet;
                this.updateBalance();

                this.minesBet = bet;
                this.minesCount = mines;
                this.minesActive = true;
                this.minesRevealedCount = 0;
                this.minesGrid = Array(25).fill('safe');

                let placed = 0;
                while (placed < mines) {
                    const idx = Math.floor(Math.random() * 25);
                    if (this.minesGrid[idx] === 'safe') {
                        this.minesGrid[idx] = 'mine';
                        placed++;
                    }
                }

                const btn = document.getElementById('minesBtn');
                btn.innerHTML = 'Cash Out <span id="minesCashoutVal" class="ml-2 bg-white/20 px-2 rounded text-sm">0</span>';
                btn.className = 'w-full bg-[#10b981] text-white py-4 rounded-xl font-bold text-lg';

                document.querySelectorAll('.mine-tile-modern').forEach(el => {
                    el.className = 'mine-tile-modern';
                    el.innerHTML = '';
                });

                this.updateMinesNextMult();
                document.getElementById('minesProfit').textContent = '0';
            }

            clickMineTile(idx) {
                if (!this.minesActive) return;
                const tile = document.getElementById(`tile-${idx}`);
                if (tile.classList.contains('revealed')) return;

                tile.classList.add('revealed');

                if (this.minesGrid[idx] === 'mine') {
                    tile.classList.add('mine');
                    tile.innerHTML = '<i class="fa-solid fa-bomb text-white text-3xl"></i>';
                    this.playSound('mine');
                    this.recordLoss(this.minesBet, 'Mines');
                    this.endMines(false, idx);
                } else {
                    tile.classList.add('gem');
                    tile.innerHTML = '<i class="fa-solid fa-gem text-[#10b981] text-2xl"></i>';
                    this.playSound('gem');
                    this.minesRevealedCount++;

                    const currentMult = this.calculateMinesMultiplier(this.minesCount, this.minesRevealedCount);
                    const currentWin = this.minesBet * currentMult;
                    document.getElementById('minesProfit').textContent = `${(currentWin - this.minesBet).toFixed(2)}`;

                    const cv = document.getElementById('minesCashoutVal');
                    if (cv) cv.textContent = `${currentWin.toFixed(2)}`;

                    this.updateMinesNextMult();

                    if (this.minesRevealedCount === (25 - this.minesCount)) {
                        this.cashOutMines();
                    }
                }
            }

            endMines(win, hitIdx) {
                this.minesActive = false;
                const btn = document.getElementById('minesBtn');
                if (btn) {
                    btn.innerText = 'Bet';
                    btn.className = 'w-full btn-primary py-4 rounded-xl font-bold text-lg';
                }

                this.minesGrid.forEach((type, idx) => {
                    const tile = document.getElementById(`tile-${idx}`);
                    if (!tile.classList.contains('revealed')) {
                        tile.classList.add('revealed');
                        if (type === 'mine') {
                            tile.innerHTML = '<i class="fa-solid fa-bomb text-white text-xl opacity-50"></i>';
                            tile.classList.add('mine-hidden');
                        } else {
                            tile.innerHTML = '<i class="fa-solid fa-gem text-white/10 text-xl"></i>';
                            tile.classList.add('safe-hidden');
                        }
                    }
                });

                if (!win) {
                    this.showToast('Boom! You hit a mine', 'error');
                }
            }

            cashOutMines() {
                const mult = this.calculateMinesMultiplier(this.minesCount, this.minesRevealedCount);
                const win = this.minesBet * mult;
                this.balance += win;
                this.updateBalance();
                this.playSound('win');
                this.showToast(`Cashed out ${win.toFixed(2)} coins`, 'success');
                this.recordWin(win - this.minesBet, 'Mines');
                this.endMines(true, -1);
            }

            // PLINKO GAME
            renderPlinko() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto animate-slide-up">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-white mb-2">Plinko</h2>
                            <p class="text-gray-400">Drop the ball and watch it bounce to big wins!</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2">
                                <div class="plinko-board" id="plinkoBoard">
                                    <div class="plinko-pegs-container" id="plinkoPegs"></div>
                                    <div class="plinko-slots" id="plinkoSlots"></div>
                                </div>
                            </div>
                            
                            <div class="bg-[#161b26] p-6 rounded-2xl border border-[#2a3042]">
                                <div class="mb-6">
                                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Bet Amount</label>
                                    <div class="flex bg-[#0b0e14] rounded-lg border border-[#2a3042]">
                                        <div class="pl-4 py-3 text-[#6b7280] font-bold">$</div>
                                        <input type="number" id="plinkoBet" value="10" min="1" max="${this.balance}" class="w-full bg-transparent text-white px-2 font-bold outline-none">
                                        <div class="flex pr-1">
                                            <button onclick="document.getElementById('plinkoBet').value = Math.min(${this.balance}, document.getElementById('plinkoBet').value * 2)" class="px-3 text-xs font-bold text-[#6b7280]">2x</button>
                                            <button onclick="document.getElementById('plinkoBet').value = Math.max(1, document.getElementById('plinkoBet').value / 2)" class="px-3 text-xs font-bold text-[#6b7280]"></button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Risk Level</label>
                                    <div class="grid grid-cols-3 gap-2 mb-4">
                                        <button onclick="app.setPlinkoRisk('low')" class="bg-[#0b0e14] border border-[#2a3042] text-[#10b981] rounded-lg py-2 font-bold text-sm">Low</button>
                                        <button onclick="app.setPlinkoRisk('medium')" class="bg-[#0b0e14] border border-[#8b5cf6] text-white rounded-lg py-2 font-bold text-sm">Medium</button>
                                        <button onclick="app.setPlinkoRisk('high')" class="bg-[#0b0e14] border border-[#2a3042] text-[#ef4444] rounded-lg py-2 font-bold text-sm">High</button>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-gray-400 text-sm">Multiplier Range</div>
                                        <div class="text-white font-bold text-xl" id="plinkoMultiplierRange">1.1x - 5x</div>
                                    </div>
                                </div>
                                
                                <div class="bg-[#0b0e14] rounded-xl p-4 mb-6 border border-[#2a3042]">
                                    <div class="text-center">
                                        <div class="text-[10px] text-[#6b7280]">Last Win</div>
                                        <div class="text-white font-bold text-xl" id="plinkoLastWin">0</div>
                                    </div>
                                </div>
                                
                                <button onclick="app.playPlinko()" class="w-full btn-primary py-4 rounded-xl font-bold text-lg">Drop Ball</button>
                            </div>
                        </div>
                    </div>
                `;
                
                this.initPlinkoBoard();
                this.setPlinkoRisk('medium');
            }

            initPlinkoBoard() {
                const pegsContainer = document.getElementById('plinkoPegs');
                const slotsContainer = document.getElementById('plinkoSlots');
                
                // Create pegs
                for (let row = 0; row < 12; row++) {
                    for (let col = 0; col < 15; col++) {
                        const peg = document.createElement('div');
                        peg.className = 'plinko-peg';
                        pegsContainer.appendChild(peg);
                    }
                }
                
                // Create slots with multipliers
                const multipliers = [0.2, 0.5, 1, 2, 5, 2, 1, 0.5, 0.2];
                const colors = ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#10b981', '#0ea5e9', '#8b5cf6', '#ec4899'];
                
                for (let i = 0; i < 9; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'plinko-slot';
                    slot.style.borderTopColor = colors[i];
                    slot.textContent = multipliers[i] + 'x';
                    slot.dataset.multiplier = multipliers[i];
                    slotsContainer.appendChild(slot);
                }
            }

            setPlinkoRisk(risk) {
                this.plinkoRisk = risk;
                let minMult, maxMult;
                
                switch(risk) {
                    case 'low':
                        minMult = 1.1;
                        maxMult = 3;
                        break;
                    case 'medium':
                        minMult = 0.5;
                        maxMult = 5;
                        break;
                    case 'high':
                        minMult = 0.2;
                        maxMult = 10;
                        break;
                }
                
                document.getElementById('plinkoMultiplierRange').textContent = `${minMult}x - ${maxMult}x`;
            }

            async playPlinko() {
                if (!this.userId) {
                    this.showToast('Please login to play', 'error');
                    return;
                }

                const bet = parseFloat(document.getElementById('plinkoBet').value);
                if (isNaN(bet) || bet <= 0) return;
                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                this.playSound('plinko');
                this.balance -= bet;
                this.updateBalance();

                // Create ball
                const board = document.getElementById('plinkoBoard');
                const ball = document.createElement('div');
                ball.className = 'plinko-ball';
                ball.style.left = '50%';
                ball.style.top = '20px';
                ball.style.transform = 'translateX(-50%)';
                board.appendChild(ball);

                // Animate ball falling
                let x = 50; // percentage
                let y = 20;
                const gravity = 0.5;
                let velocityY = 0;
                let velocityX = (Math.random() - 0.5) * 2;

                const animate = () => {
                    velocityY += gravity;
                    y += velocityY;
                    x += velocityX;

                    // Bounce off walls
                    if (x < 5) {
                        x = 5;
                        velocityX = Math.abs(velocityX) * 0.8;
                    } else if (x > 95) {
                        x = 95;
                        velocityX = -Math.abs(velocityX) * 0.8;
                    }

                    // Bounce off bottom
                    if (y > board.clientHeight - 120) {
                        y = board.clientHeight - 120;
                        velocityY = -Math.abs(velocityY) * 0.7;
                        velocityX *= 0.9;
                        
                        // If slow enough, stop
                        if (Math.abs(velocityY) < 1 && Math.abs(velocityX) < 0.5) {
                            ball.remove();
                            this.calculatePlinkoWin(bet, x);
                            return;
                        }
                    }

                    ball.style.left = x + '%';
                    ball.style.top = y + 'px';

                    requestAnimationFrame(animate);
                };

                animate();
            }

            calculatePlinkoWin(bet, finalX) {
                // Determine which slot based on final position
                const slotIndex = Math.floor((finalX / 100) * 9);
                const slots = document.querySelectorAll('.plinko-slot');
                const multiplier = parseFloat(slots[slotIndex].dataset.multiplier);
                
                const win = bet * multiplier;
                this.balance += win;
                this.updateBalance();
                
                document.getElementById('plinkoLastWin').textContent = win.toFixed(2);
                
                if (win > bet) {
                    this.showToast(`Won ${win.toFixed(2)} coins! (${multiplier}x)`, 'success');
                    this.recordWin(win - bet, 'Plinko');
                } else {
                    this.showToast(`Lost ${(bet - win).toFixed(2)} coins`, 'error');
                    this.recordLoss(bet - win, 'Plinko');
                }
            }

            // TOWERS GAME
            renderTowers() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto animate-slide-up">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-white mb-2">Towers</h2>
                            <p class="text-gray-400">Build towers and avoid the bomb to win big!</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2">
                                <div class="towers-game">
                                    <div id="towersGrid" class="flex flex-col items-center">
                                        ${Array(8).fill(0).map((_, row) => `
                                            <div class="tower-row">
                                                ${Array(5).fill(0).map((_, col) => `
                                                    <div id="tower-${row}-${col}" onclick="app.selectTowerBlock(${row}, ${col})" class="tower-block">
                                                        ${row === 7 ? '1' : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-[#161b26] p-6 rounded-2xl border border-[#2a3042]">
                                <div class="mb-6">
                                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Bet Amount</label>
                                    <div class="flex bg-[#0b0e14] rounded-lg border border-[#2a3042]">
                                        <div class="pl-4 py-3 text-[#6b7280] font-bold">$</div>
                                        <input type="number" id="towersBet" value="10" min="1" max="${this.balance}" class="w-full bg-transparent text-white px-2 font-bold outline-none">
                                        <div class="flex pr-1">
                                            <button onclick="document.getElementById('towersBet').value = Math.min(${this.balance}, document.getElementById('towersBet').value * 2)" class="px-3 text-xs font-bold text-[#6b7280]">2x</button>
                                            <button onclick="document.getElementById('towersBet').value = Math.max(1, document.getElementById('towersBet').value / 2)" class="px-3 text-xs font-bold text-[#6b7280]"></button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Tower Height</label>
                                    <div class="text-center mb-4">
                                        <div class="text-white font-bold text-3xl" id="towerHeight">0/8</div>
                                        <div class="text-gray-400 text-sm">Blocks placed</div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="app.setTowersHeight(4)" class="bg-[#0b0e14] border border-[#2a3042] text-[#10b981] rounded-lg py-2 font-bold text-sm">4 Blocks</button>
                                        <button onclick="app.setTowersHeight(6)" class="bg-[#0b0e14] border border-[#8b5cf6] text-white rounded-lg py-2 font-bold text-sm">6 Blocks</button>
                                        <button onclick="app.setTowersHeight(8)" class="bg-[#0b0e14] border border-[#2a3042] text-[#ef4444] rounded-lg py-2 font-bold text-sm">8 Blocks</button>
                                    </div>
                                </div>
                                
                                <div class="bg-[#0b0e14] rounded-xl p-4 mb-6 border border-[#2a3042]">
                                    <div class="flex justify-between">
                                        <div>
                                            <div class="text-[10px] text-[#6b7280]">Multiplier</div>
                                            <div class="text-white font-bold text-xl" id="towersMultiplier">1.00x</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-[10px] text-[#6b7280]">Potential Win</div>
                                            <div class="text-white font-bold text-xl" id="towersPotentialWin">0</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button id="towersBtn" onclick="app.playTowers()" class="w-full btn-primary py-4 rounded-xl font-bold text-lg">Start Game</button>
                            </div>
                        </div>
                    </div>
                `;
                
                this.towersActive = false;
                this.towerHeight = 6;
                this.towerBlocksPlaced = 0;
                this.setTowersHeight(6);
            }

            setTowersHeight(height) {
                this.towerHeight = height;
                document.getElementById('towerHeight').textContent = `0/${height}`;
                
                // Calculate multiplier
                const multiplier = 1 + (height * 0.5);
                document.getElementById('towersMultiplier').textContent = multiplier.toFixed(2) + 'x';
                
                const bet = parseFloat(document.getElementById('towersBet').value) || 10;
                document.getElementById('towersPotentialWin').textContent = (bet * multiplier).toFixed(2);
            }

            playTowers() {
                if (!this.userId) {
                    this.showToast('Please login to play', 'error');
                    return;
                }

                if (this.towersActive) {
                    // Game in progress, cash out
                    this.cashOutTowers();
                    return;
                }

                const bet = parseFloat(document.getElementById('towersBet').value);
                if (isNaN(bet) || bet <= 0) return;
                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                this.playSound('tower');
                this.balance -= bet;
                this.updateBalance();

                this.towersActive = true;
                this.towersBet = bet;
                this.towerBlocksPlaced = 0;
                this.towerBombPosition = Math.floor(Math.random() * 5);

                // Reset grid
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 5; col++) {
                        const block = document.getElementById(`tower-${row}-${col}`);
                        block.className = 'tower-block';
                        block.textContent = row === 7 ? '1' : '';
                        block.onclick = () => this.selectTowerBlock(row, col);
                    }
                }

                document.getElementById('towersBtn').textContent = 'Cash Out';
                document.getElementById('towersBtn').className = 'w-full bg-[#10b981] text-white py-4 rounded-xl font-bold text-lg';
            }

            selectTowerBlock(row, col) {
                if (!this.towersActive) return;

                const block = document.getElementById(`tower-${row}-${col}`);
                if (block.classList.contains('selected')) return;

                block.classList.add('selected');
                this.towerBlocksPlaced++;
                document.getElementById('towerHeight').textContent = `${this.towerBlocksPlaced}/${this.towerHeight}`;

                this.playSound('click');

                // Check if bomb
                if (this.towerBlocksPlaced === this.towerHeight) {
                    // Reached target height - win
                    this.cashOutTowers();
                } else if (col === this.towerBombPosition && row === (7 - this.towerBlocksPlaced + 1)) {
                    // Hit bomb
                    block.innerHTML = '<i class="fa-solid fa-bomb text-white"></i>';
                    block.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    this.playSound('mine');
                    this.endTowers(false);
                    this.recordLoss(this.towersBet, 'Towers');
                }
            }

            endTowers(win) {
                this.towersActive = false;
                document.getElementById('towersBtn').textContent = 'Start Game';
                document.getElementById('towersBtn').className = 'w-full btn-primary py-4 rounded-xl font-bold text-lg';

                if (!win) {
                    this.showToast('Boom! You hit the bomb!', 'error');
                }
            }

            cashOutTowers() {
                if (!this.towersActive) return;

                const multiplier = 1 + (this.towerHeight * 0.5);
                const win = this.towersBet * multiplier;
                this.balance += win;
                this.updateBalance();
                this.playSound('win');
                this.showToast(`Won ${win.toFixed(2)} coins! (${multiplier.toFixed(2)}x)`, 'success');
                this.recordWin(win - this.towersBet, 'Towers');
                this.endTowers(true);
            }

            // CROSSY ROAD GAME
            renderCrossyRoad() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto animate-slide-up">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-white mb-2">Crossy Road</h2>
                            <p class="text-gray-400">Navigate through obstacles to reach the other side!</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2">
                                <div class="crossy-road-game">
                                    <div class="crossy-road-grid" id="crossyRoadGrid">
                                        ${Array(100).fill(0).map((_, i) => {
                                            const row = Math.floor(i / 10);
                                            const col = i % 10;
                                            let className = 'crossy-road-cell';
                                            
                                            // Create pattern: roads, grass, water
                                            if (row === 0 || row === 9) {
                                                className += ' grass';
                                            } else if (row >= 1 && row <= 3) {
                                                className += ' road';
                                            } else if (row >= 4 && row <= 6) {
                                                className += ' water';
                                            } else {
                                                className += ' grass';
                                            }
                                            
                                            return `<div id="cell-${row}-${col}" class="${className}"></div>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-[#161b26] p-6 rounded-2xl border border-[#2a3042]">
                                <div class="mb-6">
                                    <label class="text-xs text-[#6b7280] font-bold mb-2 block">Bet Amount</label>
                                    <div class="flex bg-[#0b0e14] rounded-lg border border-[#2a3042]">
                                        <div class="pl-4 py-3 text-[#6b7280] font-bold">$</div>
                                        <input type="number" id="crossyBet" value="10" min="1" max="${this.balance}" class="w-full bg-transparent text-white px-2 font-bold outline-none">
                                        <div class="flex pr-1">
                                            <button onclick="document.getElementById('crossyBet').value = Math.min(${this.balance}, document.getElementById('crossyBet').value * 2)" class="px-3 text-xs font-bold text-[#6b7280]">2x</button>
                                            <button onclick="document.getElementById('crossyBet').value = Math.max(1, document.getElementById('crossyBet').value / 2)" class="px-3 text-xs font-bold text-[#6b7280]"></button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <div class="text-center mb-4">
                                        <div class="text-white font-bold text-3xl" id="crossyScore">0</div>
                                        <div class="text-gray-400 text-sm">Steps taken</div>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2 mb-4">
                                        <button onclick="app.moveCrossy('up')" class="bg-[#0b0e14] border border-[#2a3042] text-white rounded-lg py-3 font-bold text-sm">
                                            <i class="fa-solid fa-arrow-up"></i>
                                        </button>
                                        <button onclick="app.moveCrossy('left')" class="bg-[#0b0e14] border border-[#2a3042] text-white rounded-lg py-3 font-bold text-sm">
                                            <i class="fa-solid fa-arrow-left"></i>
                                        </button>
                                        <button onclick="app.moveCrossy('down')" class="bg-[#0b0e14] border border-[#2a3042] text-white rounded-lg py-3 font-bold text-sm">
                                            <i class="fa-solid fa-arrow-down"></i>
                                        </button>
                                        <button onclick="app.moveCrossy('right')" class="bg-[#0b0e14] border border-[#2a3042] text-white rounded-lg py-3 font-bold text-sm">
                                            <i class="fa-solid fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="bg-[#0b0e14] rounded-xl p-4 mb-6 border border-[#2a3042]">
                                    <div class="flex justify-between">
                                        <div>
                                            <div class="text-[10px] text-[#6b7280]">Multiplier</div>
                                            <div class="text-white font-bold text-xl" id="crossyMultiplier">1.00x</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-[10px] text-[#6b7280]">Potential Win</div>
                                            <div class="text-white font-bold text-xl" id="crossyPotentialWin">0</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="app.startCrossyRoad()" class="w-full btn-primary py-4 rounded-xl font-bold text-lg">Start Game</button>
                            </div>
                        </div>
                    </div>
                `;
                
                this.initCrossyRoad();
            }

            initCrossyRoad() {
                this.crossyActive = false;
                this.crossyScore = 0;
                this.crossyPlayerPos = { row: 9, col: 4 }; // Start at bottom middle
                this.crossyObstacles = [];
                
                // Initialize obstacles on roads
                for (let row = 1; row <= 3; row++) {
                    for (let col = 0; col < 10; col++) {
                        if (Math.random() > 0.7) {
                            this.crossyObstacles.push({ row, col });
                        }
                    }
                }
                
                this.renderCrossyBoard();
            }

            renderCrossyBoard() {
                const grid = document.getElementById('crossyRoadGrid');
                
                // Clear previous player and obstacles
                document.querySelectorAll('.crossy-road-player, .crossy-road-obstacle').forEach(el => el.remove());
                
                // Add obstacles
                this.crossyObstacles.forEach(obs => {
                    const cell = document.getElementById(`cell-${obs.row}-${obs.col}`);
                    if (cell) {
                        const obstacle = document.createElement('div');
                        obstacle.className = 'crossy-road-obstacle';
                        cell.appendChild(obstacle);
                    }
                });
                
                // Add player
                const playerCell = document.getElementById(`cell-${this.crossyPlayerPos.row}-${this.crossyPlayerPos.col}`);
                if (playerCell) {
                    const player = document.createElement('div');
                    player.className = 'crossy-road-player';
                    playerCell.appendChild(player);
                }
            }

            startCrossyRoad() {
                if (!this.userId) {
                    this.showToast('Please login to play', 'error');
                    return;
                }

                const bet = parseFloat(document.getElementById('crossyBet').value);
                if (isNaN(bet) || bet <= 0) return;
                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                this.playSound('crossy');
                this.balance -= bet;
                this.updateBalance();

                this.crossyActive = true;
                this.crossyBet = bet;
                this.crossyScore = 0;
                this.crossyPlayerPos = { row: 9, col: 4 };
                
                document.getElementById('crossyScore').textContent = '0';
                document.getElementById('crossyMultiplier').textContent = '1.00x';
                document.getElementById('crossyPotentialWin').textContent = bet.toFixed(2);
                
                this.initCrossyRoad();
            }

            moveCrossy(direction) {
                if (!this.crossyActive) return;

                this.playSound('click');

                let newRow = this.crossyPlayerPos.row;
                let newCol = this.crossyPlayerPos.col;

                switch(direction) {
                    case 'up': newRow--; break;
                    case 'down': newRow++; break;
                    case 'left': newCol--; break;
                    case 'right': newCol++; break;
                }

                // Check bounds
                if (newRow < 0 || newRow > 9 || newCol < 0 || newCol > 9) {
                    return;
                }

                // Check for obstacle collision
                const hasObstacle = this.crossyObstacles.some(obs => obs.row === newRow && obs.col === newCol);
                if (hasObstacle) {
                    this.playSound('lose');
                    this.showToast('Hit an obstacle!', 'error');
                    this.recordLoss(this.crossyBet, 'Crossy Road');
                    this.crossyActive = false;
                    return;
                }

                // Update position and score
                this.crossyPlayerPos = { row: newRow, col: newCol };
                this.crossyScore++;

                // Update display
                document.getElementById('crossyScore').textContent = this.crossyScore;
                const multiplier = 1 + (this.crossyScore * 0.1);
                document.getElementById('crossyMultiplier').textContent = multiplier.toFixed(2) + 'x';
                document.getElementById('crossyPotentialWin').textContent = (this.crossyBet * multiplier).toFixed(2);

                this.renderCrossyBoard();

                // Check for win (reached top)
                if (newRow === 0) {
                    this.winCrossyRoad();
                }
            }

            winCrossyRoad() {
                const multiplier = 1 + (this.crossyScore * 0.1);
                const win = this.crossyBet * multiplier;
                this.balance += win;
                this.updateBalance();
                this.playSound('win');
                this.showToast(`Crossed safely! Won ${win.toFixed(2)} coins! (${multiplier.toFixed(2)}x)`, 'success');
                this.recordWin(win - this.crossyBet, 'Crossy Road');
                this.crossyActive = false;
                
                // Confetti celebration
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            // ACTIVE WINS/LOSSES PAGE
            async renderActiveWins() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto animate-slide-up">
                        <div class="bg-gradient-to-r from-[#1e293b] to-[#0f172a] rounded-2xl border border-[#2a3042] p-8">
                            <div class="flex items-center gap-3 mb-8">
                                <i class="fa-solid fa-chart-line text-[#10b981] text-3xl"></i>
                                <h2 class="text-3xl font-bold text-white">Live Wins & Losses</h2>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="bg-[#0f172a] rounded-xl p-6 border border-[#2a3042]">
                                    <div class="text-center">
                                        <div class="text-gray-400 text-sm mb-2">Today's Total Wins</div>
                                        <div class="text-[#10b981] font-bold text-3xl" id="todayWins">0</div>
                                    </div>
                                </div>
                                <div class="bg-[#0f172a] rounded-xl p-6 border border-[#2a3042]">
                                    <div class="text-center">
                                        <div class="text-gray-400 text-sm mb-2">Today's Total Losses</div>
                                        <div class="text-[#ef4444] font-bold text-3xl" id="todayLosses">0</div>
                                    </div>
                                </div>
                                <div class="bg-[#0f172a] rounded-xl p-6 border border-[#2a3042]">
                                    <div class="text-center">
                                        <div class="text-gray-400 text-sm mb-2">Biggest Win Today</div>
                                        <div class="text-[#f59e0b] font-bold text-3xl" id="biggestWin">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-8">
                                <h3 class="text-xl font-bold text-white mb-4">Recent Activity</h3>
                                <div id="recentActivity" class="space-y-3 max-h-[400px] overflow-y-auto">
                                    <div class="text-center py-12">
                                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#8b5cf6] mx-auto mb-4"></div>
                                        <p class="text-gray-400">Loading recent activity...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                await this.loadActiveWins();
            }

            async loadActiveWins() {
                // Get today's start timestamp
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStart = today.getTime();

                // Get transactions from today
                const snapshot = await database.ref('transactions')
                    .orderByChild('timestamp')
                    .startAt(todayStart)
                    .once('value');

                const transactions = [];
                let totalWins = 0;
                let totalLosses = 0;
                let biggestWin = 0;

                snapshot.forEach(child => {
                    const transaction = child.val();
                    transactions.push(transaction);
                    
                    if (transaction.type === 'win') {
                        totalWins += transaction.amount;
                        if (transaction.amount > biggestWin) {
                            biggestWin = transaction.amount;
                        }
                    } else if (transaction.type === 'loss') {
                        totalLosses += transaction.amount;
                    }
                });

                // Update stats
                document.getElementById('todayWins').textContent = totalWins.toLocaleString();
                document.getElementById('todayLosses').textContent = totalLosses.toLocaleString();
                document.getElementById('biggestWin').textContent = biggestWin.toLocaleString();

                // Display recent activity
                const recentActivity = document.getElementById('recentActivity');
                recentActivity.innerHTML = '';

                transactions.sort((a, b) => b.timestamp - a.timestamp).slice(0, 20).forEach(transaction => {
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-4 rounded-lg border ${
                        transaction.type === 'win' ? 'border-[#10b981] bg-[#064e3b]/20' : 'border-[#ef4444] bg-[#7f1d1d]/20'
                    }`;
                    
                    const time = new Date(transaction.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${
                                transaction.type === 'win' ? 'bg-[#10b981]/20 text-[#10b981]' : 'bg-[#ef4444]/20 text-[#ef4444]'
                            }">
                                <i class="fa-solid ${transaction.type === 'win' ? 'fa-trophy' : 'fa-bomb'}"></i>
                            </div>
                            <div>
                                <div class="text-white font-bold">${transaction.username}</div>
                                <div class="text-gray-400 text-sm">${transaction.game}  ${time}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-white font-bold text-xl ${
                                transaction.type === 'win' ? 'text-[#10b981]' : 'text-[#ef4444]'
                            }">
                                ${transaction.type === 'win' ? '+' : '-'}${transaction.amount.toLocaleString()}
                            </div>
                            <div class="text-gray-400 text-sm">coins</div>
                        </div>
                    `;
                    
                    recentActivity.appendChild(div);
                });

                if (transactions.length === 0) {
                    recentActivity.innerHTML = '<div class="text-center py-12 text-gray-400">No activity yet today</div>';
                }
            }

            // BLACKJACK GAME (simplified for brevity - you already have this)
            renderBlackjack() {
                // Your existing blackjack code here
                this.mainContent.innerHTML = `
                    <div class="max-w-4xl mx-auto flex flex-col gap-6 h-full animate-slide-up">
                        <div class="relative flex-1 bg-[#064e3b] rounded-[3rem] border-[8px] border-[#3f2c22] p-8 flex flex-col items-center justify-center overflow-hidden">
                            <div class="absolute top-8 text-white/20 font-black text-5xl tracking-[1em] select-none">BLACKJACK</div>
                            <div class="w-full max-w-2xl z-10 flex flex-col h-full justify-between py-8">
                                <div class="flex flex-col items-center">
                                    <div class="mb-2 text-[#a7f3d0] text-xs font-bold flex items-center gap-2">
                                        <i class="fa-solid fa-user-tie"></i> Dealer
                                        <span id="dealerScore" class="bg-black/30 px-2 py-0.5 rounded text-white">0</span>
                                    </div>
                                    <div id="dealerHand" class="flex justify-center h-36 relative gap-2"></div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div id="playerHand" class="flex justify-center h-36 relative gap-2"></div>
                                    <div class="mt-4 text-[#a7f3d0] text-xs font-bold flex items-center gap-2">
                                        <i class="fa-solid fa-user"></i> You
                                        <span id="playerScore" class="bg-black/30 px-2 py-0.5 rounded text-white">0</span>
                                    </div>
                                </div>
                            </div>
                            <div id="bjOverlay" class="absolute inset-0 bg-black/70 hidden z-20 flex-col items-center justify-center">
                                <div id="bjMessage" class="text-7xl font-black text-white mb-8"></div>
                                <div id="bjPayout" class="text-3xl font-bold text-yellow-300 mb-8">+0 coins</div>
                                <button onclick="app.resetBlackjackUI()" class="px-10 py-4 bg-emerald-500 text-white text-xl rounded-full font-bold">Play Again</button>
                            </div>
                        </div>
                        <div class="bg-[#161b26] p-6 rounded-2xl border border-[#2a3042] flex flex-col md:flex-row justify-between items-center gap-6">
                            <div class="flex items-center gap-3 bg-[#0b0e14] px-4 py-3 rounded-xl border border-[#2a3042]">
                                <span class="text-gray-400 font-bold text-sm">BET</span>
                                <input type="number" id="bjBetInput" value="50" min="1" max="${this.balance}" class="bg-transparent text-white font-bold text-xl w-24 outline-none">
                            </div>
                            <div class="flex gap-4">
                                <button id="btnDeal" onclick="app.bjDeal()" class="px-16 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-black text-xl rounded-xl">DEAL</button>
                                <div id="bjActions" class="hidden flex gap-4">
                                    <button id="btnHit" onclick="app.bjHit()" class="px-10 py-4 bg-gray-700 text-white font-bold text-xl rounded-xl">HIT</button>
                                    <button id="btnStand" onclick="app.bjStand()" class="px-10 py-4 bg-emerald-600 text-white font-black text-xl rounded-xl">STAND</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.bjInProgress = false;
                this.bjSettled = false;
                this.bjStandCalled = false;
            }

            // LEADERBOARD
            async renderLeaderboard() {
                this.mainContent.innerHTML = `
                    <div class="max-w-4xl mx-auto animate-slide-up">
                        <div class="bg-gradient-to-r from-[#1e293b] to-[#0f172a] rounded-2xl border border-[#2a3042] p-8">
                            <div class="flex items-center gap-3 mb-8">
                                <i class="fa-solid fa-trophy text-yellow-400 text-3xl"></i>
                                <h2 class="text-3xl font-bold text-white">Top Players</h2>
                            </div>
                            
                            <div id="leaderboardContent" class="space-y-4">
                                <div class="text-center py-12">
                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#8b5cf6] mx-auto mb-4"></div>
                                    <p class="text-gray-400">Loading leaderboard...</p>
                                </div>
                            </div>
                            
                            <div class="mt-12 p-6 bg-[#0f172a] rounded-xl border border-[#2a3042]">
                                <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-user text-[#8b5cf6]"></i>
                                    Your Position
                                </h3>
                                <div id="userPosition" class="text-center py-4">
                                    <div class="text-gray-400">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                await this.loadLeaderboard();
            }

            async loadLeaderboard() {
                const snapshot = await database.ref('users').once('value');
                const users = [];

                snapshot.forEach(child => {
                    const user = child.val();
                    users.push({
                        username: user.username,
                        balance: user.balance || 0,
                        userId: user.userId,
                        totalWins: user.totalWins || 0,
                        biggestWin: user.biggestWin || 0
                    });
                });

                // Sort by balance
                users.sort((a, b) => b.balance - a.balance);

                // Display top 10
                const leaderboardContent = document.getElementById('leaderboardContent');
                leaderboardContent.innerHTML = '';

                const medals = ['', '', ''];

                users.slice(0, 10).forEach((user, index) => {
                    const medal = medals[index] || '';
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    div.innerHTML = `
                        <div class="flex items-center gap-4 w-full">
                            <div class="text-3xl font-bold">${medal}</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-lg">${user.username}</div>
                                <div class="text-gray-400 text-sm">Wins: ${user.totalWins} | Biggest: ${user.biggestWin || 0}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[#10b981] font-bold text-xl">${user.balance.toLocaleString()}</div>
                                <div class="text-gray-400 text-xs">coins</div>
                            </div>
                        </div>
                    `;
                    leaderboardContent.appendChild(div);
                });

                // Find user position
                const userPosition = users.findIndex(u => u.userId === this.userId);
                const userPositionDiv = document.getElementById('userPosition');

                if (userPosition !== -1) {
                    userPositionDiv.innerHTML = `
                        <div class="flex justify-between items-center p-4 bg-[#1e293b] rounded-lg">
                            <div class="text-left">
                                <div class="text-white font-bold">${this.username}</div>
                                <div class="text-gray-400 text-sm">You</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-white">#${userPosition + 1}</div>
                                <div class="text-gray-400 text-xs">Rank</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[#10b981] font-bold">${this.balance.toLocaleString()}</div>
                                <div class="text-gray-400 text-xs">coins</div>
                            </div>
                        </div>
                    `;
                } else {
                    userPositionDiv.innerHTML = '<div class="text-gray-400">Not ranked</div>';
                }
            }

            // RAIN SYSTEM (now in wallet modal)
            initRain() {
                // Listen for active rains
                database.ref('activeRain').on('value', (snapshot) => {
                    const rain = snapshot.val();
                    if (rain && rain.active) {
                        this.rainActive = true;
                        this.currentRain = rain;
                        this.showRainPanel(rain);
                    } else {
                        this.rainActive = false;
                        this.hideRainPanel();
                    }
                });
            }

            showRainPanel(rain) {
                document.getElementById('rainCreateSection').classList.add('hidden');
                document.getElementById('rainJoinSection').classList.remove('hidden');

                document.getElementById('rainAmount').textContent = rain.amount;
                document.getElementById('rainJoinedCount').textContent = Object.keys(rain.participants || {}).length;

                this.startRainTimer(rain.endTime);
            }

            hideRainPanel() {
                document.getElementById('rainJoinSection').classList.add('hidden');
                document.getElementById('rainCreateSection').classList.remove('hidden');
            }

            startRainTimer(endTime) {
                const timerElement = document.getElementById('rainTimer');
                const updateTimer = () => {
                    const now = Date.now();
                    const timeLeft = Math.max(0, endTime - now);
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);

                    timerElement.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    if (timeLeft <= 0) {
                        clearInterval(this.rainTimerInterval);
                        timerElement.textContent = '00:00';
                    }
                };

                updateTimer();
                this.rainTimerInterval = setInterval(updateTimer, 1000);
            }

            async createRain() {
                if (!this.userId) {
                    this.showToast('Please login to create rain', 'error');
                    return;
                }

                const amount = parseInt(document.getElementById('rainAmountInput').value);
                if (amount < 250) {
                    this.showToast('Minimum rain amount is 250 coins', 'error');
                    return;
                }

                if (amount > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                // Check if rain already active
                if (this.rainActive) {
                    this.showToast('A rain is already active', 'error');
                    return;
                }

                // Deduct amount
                this.balance -= amount;
                this.updateBalance();

                // Create rain
                const rainId = 'rain_' + Date.now();
                const endTime = Date.now() + (7 * 60 * 1000); // 7 minutes

                const rainData = {
                    id: rainId,
                    hostId: this.userId,
                    hostUsername: this.username,
                    amount: amount,
                    participants: {},
                    endTime: endTime,
                    active: true,
                    createdAt: Date.now()
                };

                await database.ref('activeRain').set(rainData);

                this.showToast(`Rain started with ${amount} coins!`, 'success');
                this.playSound('rain');

                // Add to chat
                this.addChatMessage('System', 
                    `${this.username} started a rain with ${amount} coins! Join in the next 7 minutes!`, 
                    'text-[#38bdf8]');
            }

            async joinRain() {
                if (!this.userId) {
                    this.showToast('Please login to join rain', 'error');
                    return;
                }

                if (this.rainJoined) {
                    this.showToast('You already joined this rain', 'error');
                    return;
                }

                if (!this.rainActive || !this.currentRain) {
                    this.showToast('No active rain', 'error');
                    return;
                }

                // Add user to participants
                await database.ref(`activeRain/participants/${this.userId}`).set({
                    username: this.username,
                    joinedAt: Date.now()
                });

                this.rainJoined = true;
                this.showToast('Joined the rain! Wait for it to end.', 'success');
            }
        }

        // Initialize the app
        const app = new GameApp();
    </script>
</body>
</html>
