<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Casino - Premium Crypto Casino</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #8b5cf6;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0b0e14;
            --bg-panel: #161b26;
            --border: #2a3042;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #000;
            color: #b1bad3;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, #eee, transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent),
                radial-gradient(circle at 50% 50%, rgba(139,92,246,0.08) 0%, transparent 50%),
                linear-gradient(135deg, #0f0720 0%, #000 100%);
            background-repeat: repeat, repeat, repeat, repeat, repeat, no-repeat, no-repeat;
            background-size: 200px 200px, 300px 300px, 400px 400px, 350px 350px, 250px 250px, 100% 100%, 100% 100%;
            animation: stars 120s linear infinite;
            position: relative;
            overflow-x: hidden;
        }
        
        @keyframes stars {
            from { background-position: 0 0, 0 0, 0 0, 0 0, 0 0, 0 0, 0 0; }
            to { background-position: 200px 200px, 300px 300px, 400px 400px, 350px 350px, 250px 250px, 0 0, 0 0; }
        }
        
        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 70%, rgba(139,92,246,0.15), transparent 40%),
                        radial-gradient(circle at 80% 20%, rgba(34,211,238,0.12), transparent 50%);
            pointer-events: none;
            animation: nebula 25s ease-in-out infinite alternate;
        }
        
        @keyframes nebula {
            0% { opacity: 0.4; transform: scale(1) rotate(0deg); }
            100% { opacity: 0.7; transform: scale(1.1) rotate(5deg); }
        }
        
        /* Enhanced Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(2deg); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.6); }
        }
        
        @keyframes slide-in-right {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slide-in-left {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes scale-in {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes card-deal {
            0% { transform: translateY(-100px) rotate(-10deg) scale(0.5); opacity: 0; }
            60% { transform: translateY(10px) rotate(2deg) scale(1.05); opacity: 1; }
            100% { transform: translateY(0) rotate(0) scale(1); opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        @keyframes fade-in-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(11, 14, 20, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #8b5cf6, #10b981);
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #7c3aed, #059669);
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            border: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 40px rgba(139,92,246,0.4);
        }
        
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.7s;
        }
        
        .btn-primary:hover::after {
            left: 100%;
        }
        
        /* Game Card */
        .game-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #161b26, #11141c);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #8b5cf6, #10b981, #8b5cf6);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }
        
        .game-card:hover {
            transform: translateY(-10px) scale(1.03);
            border-color: #8b5cf6;
            box-shadow: 0 25px 50px -12px rgba(110,86,207,0.4);
        }
        
        /* Mines Grid - FIXED */
        .mines-grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            user-select: none;
            padding: 10px;
            min-height: 400px;
            align-items: center;
        }
        
        .mine-tile-modern {
            aspect-ratio: 1;
            background: linear-gradient(145deg, #1f2937, #111827);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 0 #0f172a;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            touch-action: none;
            min-width: 60px;
            min-height: 60px;
        }
        
        @media (max-width: 768px) {
            .mine-tile-modern {
                min-width: 50px;
                min-height: 50px;
            }
        }
        
        .mine-tile-modern:hover:not(.revealed),
        .mine-tile-modern.hover-effect:not(.revealed) {
            transform: translateY(-3px);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.2);
        }
        
        .mine-tile-modern.revealed {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #0f172a;
            cursor: default;
        }
        
        .mine-tile-modern.gem {
            background: linear-gradient(145deg, #065f46, #064e3b);
            border: 2px solid #10b981;
            animation: pulse-glow 2s infinite;
        }
        
        .mine-tile-modern.mine {
            background: linear-gradient(145deg, #7f1d1d, #450a0a);
            border: 2px solid #ef4444;
            animation: shake 0.5s;
        }
        
        /* Blackjack Cards - FIXED to prevent scaling */
        .card-container {
            width: 100px;
            height: 146px;
            perspective: 1200px;
            margin: 0 8px;
            flex-shrink: 0; /* Prevent scaling */
        }
        
        @media (max-width: 768px) {
            .card-container {
                width: 70px;
                height: 102px;
            }
        }
        
        .game-card-item {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.8), 0 0 40px rgba(0,0,0,0.5), inset 0 2px 0 rgba(255,255,255,0.2);
        }
        
        .game-card-item.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face, .card-back {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            border-radius: 16px;
            overflow: hidden;
            background: #fdfdfd;
            border: 3px solid #1e293b;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px 8px;
            font-weight: 900;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .card-back {
            background: linear-gradient(135deg, #1e40af, #1e3a8a);
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-back::before {
            content: 'â—†';
            font-size: 80px;
            color: rgba(255,255,255,0.3);
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
            animation: float 3s ease-in-out infinite;
        }
        
        .card-face .text-red-500 {
            color: #ef4444 !important;
        }
        
        .card-face > div:first-child,
        .card-face > div:last-child {
            font-size: 16px;
            line-height: 1;
            letter-spacing: -1px;
        }
        
        .card-face .card-value {
            font-size: 56px;
            align-self: center;
            margin-top: -15px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .card-face::before {
            content: '';
            position: absolute;
            inset: 5px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255,255,255,0.5), transparent 60%);
            pointer-events: none;
        }
        
        /* Sound Toggle */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #1e293b;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 26px;
            cursor: pointer;
            z-index: 1000;
            border: 2px solid #334155;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: bounce 2s infinite;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 15px 35px rgba(56, 189, 248, 0.5);
            background: linear-gradient(135deg, #1e293b, #0f172a);
        }
        
        .sound-toggle.muted {
            background: #ef4444;
            animation: none;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease-out;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #161b26;
            border-radius: 20px;
            border: 1px solid #2a3042;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
            max-width: 420px;
            width: 100%;
            animation: scale-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; backdrop-filter: blur(0); }
            to { opacity: 1; backdrop-filter: blur(10px); }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 20px 28px;
            background: #1e293b;
            border-radius: 16px;
            border: 1px solid #334155;
            color: white;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            transform: translateX(100px) scale(0.8);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .toast.show {
            transform: translateX(0) scale(1);
            opacity: 1;
        }
        
        .toast.success {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), #1e293b);
        }
        
        .toast.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), #1e293b);
        }
        
        .toast.warning {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), #1e293b);
        }
        
        /* Win/Loss Notification */
        .big-win-notification {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            text-align: center;
            animation: pulse-glow 1.5s infinite, scale-in 0.3s ease-out;
        }
        
        .big-win-notification .username {
            color: #fbbf24;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .big-win-notification .amount {
            color: #10b981;
            font-weight: bold;
            font-size: 24px;
            text-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
            margin: 8px 0;
        }
        
        /* Stats Cards */
        .stats-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            border-color: #8b5cf6;
            box-shadow: 0 15px 30px rgba(139, 92, 246, 0.2);
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #10b981);
        }
        
        /* Leaderboard Item */
        .leaderboard-item {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            transition: all 0.3s;
            animation: fade-in-up 0.3s ease-out;
        }
        
        .leaderboard-item:hover {
            transform: translateX(5px);
            border-color: #8b5cf6;
            background: linear-gradient(135deg, rgba(44, 58, 83, 0.8), rgba(25, 35, 58, 0.8));
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .mines-grid-container {
                gap: 10px;
                max-width: 400px;
                min-height: 350px;
            }
            
            .sound-toggle {
                width: 50px;
                height: 50px;
                font-size: 22px;
                bottom: 15px;
                left: 15px;
            }
            
            .modal-content {
                width: 100%;
                padding: 20px;
            }
        }
        
        /* Loading Animation */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-radius: 50%;
            border-top-color: #8b5cf6;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #2a3042;
            padding-bottom: 10px;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            color: #b1bad3;
            background: rgba(30, 41, 59, 0.5);
        }
        
        .tab-btn.active {
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            border-bottom: 3px solid #8b5cf6;
        }
        
        /* Blackjack Table - FIXED to prevent scaling */
        .blackjack-table {
            background: linear-gradient(135deg, #064e3b, #022c22);
            border-radius: 20px;
            border: 6px solid #3f2c22;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            padding: 15px;
            min-height: 500px;
            max-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .blackjack-table {
                padding: 10px;
                min-height: 450px;
                max-height: 450px;
            }
        }
        
        .blackjack-table::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.05) 1px, transparent 1px),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
        }
        
        /* Game Controls */
        .game-controls {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 16px;
            border: 1px solid #334155;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        
        /* Live Wins Panel */
        .live-wins-panel {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .live-win-item {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            animation: slide-in-right 0.3s ease-out;
        }
        
        /* Chat adjustments */
        #chatSidebar {
            flex-shrink: 0;
            width: 320px;
            height: calc(100vh - 64px);
            position: sticky;
            top: 64px;
        }
        
        @media (max-width: 1024px) {
            #chatSidebar {
                width: 280px;
            }
        }
        
        #chatMessages {
            height: calc(100vh - 180px);
            overflow-y: auto;
        }
        
        /* Mines drag selection */
        .mine-selection-line {
            position: absolute;
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Blackjack fixed height containers */
        .blackjack-fixed-container {
            max-height: 500px;
            overflow: visible;
            display: flex;
            flex-direction: column;
        }
        
        /* Game Hand Containers - FIXED to prevent scaling */
        .hand-container {
            min-height: 160px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            overflow: visible;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .hand-container {
                min-height: 120px;
            }
        }
        
        /* Status Text */
        .status-text {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .status-text {
                font-size: 1rem;
            }
        }
        
        /* Game Container */
        .game-container {
            padding: 1rem;
            min-height: calc(100vh - 200px);
            overflow: visible;
        }

        /* Add this to your existing CSS */
        #mainContent {
            flex: 1;
            min-height: calc(100vh - 64px);
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .game-container {
            flex: 1;
            min-height: calc(100vh - 180px);
            overflow: visible;
        }

        /* Fix for the body and layout containers */
        body.min-h-screen.flex.flex-col {
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
        }

        .flex-1.overflow-y-auto {
            height: calc(100vh - 64px);
            overflow: visible;
        }

        /* Ensure all game pages have proper height */
        .max-w-5xl.mx-auto.flex.flex-col.md\:flex-row.gap-6.min-h-\[600px\].items-start.game-container {
            min-height: calc(100vh - 200px);
            overflow: visible;
        }

        .max-w-6xl.mx-auto.flex.flex-col.gap-6 {
            min-height: calc(100vh - 180px);
            overflow: visible;
        }

        /* Adjust chat sidebar height */
        #chatSidebar {
            height: calc(100vh - 64px);
        }
        
        /* Rain Panel */
        .rain-panel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            animation: pulse-glow 2s infinite;
        }
        
        /* Admin Panel */
        .admin-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }
        
        .admin-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 15px 30px rgba(139, 92, 246, 0.2);
        }
        
        .admin-card h3 {
            color: #8b5cf6;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Scrollable Content */
        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Responsive adjustments for games */
        @media (max-width: 768px) {
            .mines-grid-container {
                gap: 8px;
                padding: 5px;
                min-height: 300px;
            }
            
            .mine-tile-modern {
                min-width: 45px;
                min-height: 45px;
                font-size: 12px;
            }
            
            .blackjack-table {
                min-height: 400px;
                max-height: 400px;
            }
            
            .game-controls {
                padding: 15px;
            }
            
            .hand-container {
                gap: 5px;
            }
        }
        
        /* Rain active indicator */
        .rain-active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2));
            border: 2px solid rgba(59, 130, 246, 0.7);
        }
        
        /* Rock Paper Scissors Styles */
        .rps-container {
            background: linear-gradient(135deg, #161b26, #11141c);
            border-radius: 20px;
            border: 1px solid #2a3042;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .rps-choice {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .rps-choice {
                width: 100px;
                height: 100px;
            }
        }
        
        .rps-choice:hover:not(.selected):not(.disabled) {
            transform: translateY(-10px) scale(1.1);
            border-color: #8b5cf6;
            box-shadow: 0 15px 30px rgba(139, 92, 246, 0.3);
        }
        
        .rps-choice.selected {
            transform: scale(1.1);
            border-color: #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
            animation: pulse 1s infinite;
        }
        
        .rps-choice.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .rps-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .rps-icon {
                font-size: 36px;
            }
        }
        
        .rps-choice.rock .rps-icon {
            color: #9ca3af;
        }
        
        .rps-choice.paper .rps-icon {
            color: #3b82f6;
        }
        
        .rps-choice.scissors .rps-icon {
            color: #ef4444;
        }
        
        .rps-vs-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .rps-player-choice, .rps-opponent-choice {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid #2a3042;
        }
        
        .rps-player-choice {
            top: 0;
            left: 0;
            border-color: #8b5cf6;
        }
        
        .rps-opponent-choice {
            bottom: 0;
            right: 0;
            border-color: #ef4444;
        }
        
        .rps-vs-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #8b5cf6, #ef4444);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        
        .game-lobby-item {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .game-lobby-item:hover {
            transform: translateX(5px);
            border-color: #8b5cf6;
            background: linear-gradient(135deg, rgba(44, 58, 83, 0.8), rgba(25, 35, 58, 0.8));
        }
        
        .game-lobby-item.active {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(139, 92, 246, 0.05));
        }
        
        .countdown-timer {
            font-size: 48px;
            font-weight: bold;
            color: #f59e0b;
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
            animation: pulse 1s infinite;
        }
        
        .rps-result {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            animation: scale-in 0.5s ease-out;
        }
        
        .rps-result.win {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
            color: #10b981;
            border: 2px solid #10b981;
        }
        
        .rps-result.loss {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
            color: #ef4444;
            border: 2px solid #ef4444;
        }
        
        .rps-result.tie {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
            color: #f59e0b;
            border: 2px solid #f59e0b;
        }
        
        .chat-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        /* Prevent scaling of game containers */
        .no-scale {
            transform: none !important;
            scale: 1 !important;
        }
        
        /* Fixed layout for games */
        .fixed-game-layout {
            display: flex;
            flex-direction: column;
            min-height: 600px;
            max-height: 600px;
            overflow: visible;
        }
        
        @media (max-width: 768px) {
            .fixed-game-layout {
                min-height: 500px;
                max-height: 500px;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Sound Toggle -->
    <div class="sound-toggle" id="soundToggle" onclick="app.toggleSound()">
        <i class="fa-solid fa-volume-high"></i>
    </div>

    <!-- Navbar -->
    <nav class="h-16 bg-[#161b26]/95 backdrop-blur-xl flex items-center justify-between px-4 md:px-8 shadow-2xl border-b border-[#2a3042] sticky top-0 z-40">
        <div class="flex items-center gap-4">
            <button class="text-gray-400 hover:text-white md:hidden transition-all duration-300 hover:scale-110" onclick="app.toggleSidebar()">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <div class="flex items-center gap-3 cursor-pointer group" onclick="app.loadGame('home')">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#8b5cf6] to-[#4c1d95] flex items-center justify-center shadow-lg relative overflow-hidden">
                    <i class="fa-solid fa-moon text-white text-lg relative z-10"></i>
                    <div class="absolute inset-0 bg-white/10"></div>
                </div>
                <div class="text-2xl md:text-3xl font-bold text-white tracking-tight">
                    Moon<span class="text-[#8b5cf6]">Casino</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- Rain Indicator -->
            <div id="rainIndicator" class="hidden md:flex items-center gap-2 bg-gradient-to-r from-blue-500/20 to-blue-600/20 rounded-full px-3 py-1 border border-blue-500/30 cursor-pointer hover:border-blue-400 transition-all duration-300" onclick="app.joinRain()">
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                <span class="text-blue-300 text-xs font-bold tracking-wider">RAIN ACTIVE!</span>
            </div>
            
            <!-- Live Wins Indicator -->
            <div class="hidden md:flex items-center gap-2 bg-gradient-to-r from-[#0b0e14] to-[#1e2533] rounded-full px-3 py-1 border border-[#2a3042]">
                <div class="w-2 h-2 bg-[#10b981] rounded-full animate-pulse"></div>
                <span class="text-[#10b981] text-xs font-bold tracking-wider">LIVE WINS</span>
            </div>
            
            <div class="hidden md:flex bg-gradient-to-r from-[#0b0e14] to-[#1e2533] rounded-full px-2 py-1 items-center gap-3 border border-[#2a3042] shadow-lg">
                <div class="bg-gradient-to-r from-[#1e293b] to-[#0f172a] rounded-full px-5 py-2.5 flex items-center gap-3 min-w-[160px] justify-between cursor-pointer hover:from-[#2a3042] hover:to-[#1e293b] transition-all duration-300 group" onclick="app.openDepositModal()">
                    <span class="text-[#8b5cf6] text-sm font-bold tracking-wider">COINS</span>
                    <span class="text-white font-mono font-bold text-lg tracking-wider" id="balanceDisplay">500</span>
                    <i class="fa-solid fa-coins text-yellow-400 opacity-0 group-hover:opacity-100 transition-all duration-300"></i>
                </div>
                <button onclick="app.openDepositModal()" class="bg-gradient-to-r from-[#8b5cf6] to-[#7c3aed] hover:from-[#7c3aed] hover:to-[#6d28d9] text-white px-6 py-2.5 rounded-full text-sm font-bold shadow-lg shadow-purple-900/30 transition-all duration-300 hover:scale-105">
                    <i class="fa-solid fa-wallet mr-2"></i> Wallet
                </button>
            </div>
            <button class="md:hidden text-white bg-gradient-to-r from-[#1e293b] to-[#0f172a] p-2.5 rounded-xl border border-[#2a3042] shadow-lg hover:scale-110 transition-all duration-300" onclick="app.openDepositModal()">
                <i class="fa-solid fa-wallet text-[#8b5cf6] text-lg"></i>
            </button>
            <button class="text-gray-400 hover:text-white ml-2 transition-all duration-300 hover:scale-110" onclick="app.toggleChat()">
                <i class="fa-solid fa-message text-xl"></i>
            </button>
            <div class="w-9 h-9 rounded-full bg-gradient-to-r from-blue-500 to-teal-400 flex items-center justify-center text-white font-bold text-sm border-2 border-[#161b26] shadow-lg hover:scale-110 transition-all duration-300 cursor-pointer" id="userAvatar">
                U
            </div>
            <button onclick="app.logout()" class="text-gray-400 hover:text-white ml-2 transition-all duration-300 hover:scale-110">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </nav>
    
    <!-- Layout -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute md:relative inset-y-0 left-0 z-30 w-64 bg-[#161b26]/95 backdrop-blur-xl border-r border-[#2a3042] transform -translate-x-full md:translate-x-0 flex flex-col transition-transform duration-500 ease-out shadow-2xl md:shadow-none">
            <div class="flex-1 overflow-y-auto py-8 px-5 space-y-2">
                <div class="text-xs font-bold text-[#8b5cf6] mb-6 px-3 tracking-wider uppercase">Premium Games</div>
                <button onclick="app.loadGame('home')" id="nav-home" class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl hover:bg-gradient-to-r hover:from-[#2a3042] hover:to-[#1e293b] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group">
                    <i class="fa-solid fa-house w-5 text-center group-hover:text-[#8b5cf6] transition-all duration-300"></i> 
                    <span>Home</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <div class="h-px bg-gradient-to-r from-transparent via-[#2a3042] to-transparent my-3 mx-3"></div>
                <button onclick="app.loadGame('mines')" id="nav-mines" class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl hover:bg-gradient-to-r hover:from-[#2a3042] hover:to-[#1e293b] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group">
                    <i class="fa-solid fa-bomb text-[#f59e0b] w-5 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span>Mines</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <button onclick="app.loadGame('blackjack')" id="nav-blackjack" class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl hover:bg-gradient-to-r hover:from-[#2a3042] hover:to-[#1e293b] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group">
                    <i class="fa-solid fa-diamond text-[#10b981] w-5 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span>Blackjack</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <button onclick="app.loadGame('rps')" id="nav-rps" class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl hover:bg-gradient-to-r hover:from-[#2a3042] hover:to-[#1e293b] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group">
                    <i class="fa-solid fa-hand-back-fist text-[#8b5cf6] w-5 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span>Rock Paper Scissors</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <button onclick="app.loadGame('leaderboard')" id="nav-leaderboard" class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl hover:bg-gradient-to-r hover:from-[#2a3042] hover:to-[#1e293b] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group">
                    <i class="fa-solid fa-trophy text-[#f59e0b] w-5 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span>Leaderboard</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <button onclick="app.loadGame('admin')" id="nav-admin" class="w-full flex items-center gap-4 px-5 py-3.5 rounded-xl hover:bg-gradient-to-r hover:from-[#2a3042] hover:to-[#1e293b] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group">
                    <i class="fa-solid fa-shield text-[#ef4444] w-5 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span>Admin</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
            </div>
            <div class="p-5 bg-gradient-to-t from-[#11141c] to-transparent border-t border-[#2a3042]">
                <div class="flex justify-between text-xs text-[#6b7280] mb-2">
                    <span>Logged in as</span>
                    <span id="loggedUsername" class="text-[#10b981] font-bold">Guest</span>
                </div>
                <div class="text-[11px] text-center text-[#555d70] font-mono bg-gradient-to-r from-[#0b0e14] to-[#1e293b] p-2.5 rounded-lg border border-[#2a3042] truncate shadow-inner">
                    <span id="userIdDisplay">Not logged in</span>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main id="mainContent" class="flex-1 overflow-y-auto p-4 md:p-6"></main>
        
        <!-- Chat -->
        <aside id="chatSidebar" class="hidden md:flex flex-col w-80 bg-[#161b26]/95 backdrop-blur-xl border-l border-[#2a3042] shadow-2xl">
            <div class="p-5 border-b border-[#2a3042] flex justify-between items-center bg-gradient-to-r from-[#11141c] to-transparent">
                <div class="flex items-center gap-3">
                    <div class="w-3 h-3 bg-[#10b981] rounded-full animate-pulse"></div>
                    <span class="text-white font-bold text-sm tracking-wider">Global Chat</span>
                </div>
                <div class="text-xs text-[#6b7280] bg-[#0b0e14] px-3 py-1.5 rounded-full border border-[#2a3042]" id="onlineCount">0 Online</div>
            </div>
            <!-- Rain Panel in Chat -->
            <div id="rainPanel" class="rain-panel mx-4 mt-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-cloud-rain text-blue-400"></i>
                        <span class="text-white font-bold">Rain Active!</span>
                    </div>
                    <div id="rainTimer" class="text-blue-300 font-bold text-sm">10:00</div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-blue-300 text-sm">Prize Pool:</div>
                        <div id="rainAmount" class="text-white font-bold text-lg">0 coins</div>
                    </div>
                    <button onclick="app.joinRain()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all duration-300">
                        Join Rain!
                    </button>
                </div>
                <div id="rainParticipants" class="text-blue-300 text-xs mt-2">0 participants</div>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-5 space-y-4 text-sm bg-gradient-to-b from-[#0b0e14]/50 to-transparent"></div>
            <div class="p-4 bg-gradient-to-t from-[#161b26] to-transparent border-t border-[#2a3042]">
                <form onsubmit="app.sendChatMessage(event)" class="relative">
                    <input type="text" id="chatInput" placeholder="Type a message..." class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] text-white pl-5 pr-12 py-3.5 rounded-xl border border-[#2a3042] text-sm focus:outline-none focus:border-[#8b5cf6] transition-all duration-300">
                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-[#8b5cf6] hover:text-white p-2 transition-all duration-300 hover:scale-110">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </aside>
    </div>
    
    <!-- Auth Modal -->
    <div id="authModal" class="modal active">
        <div class="modal-content p-8">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-[#8b5cf6] to-[#4c1d95] flex items-center justify-center mx-auto mb-6 relative overflow-hidden">
                    <i class="fa-solid fa-moon text-white text-3xl relative z-10"></i>
                    <div class="absolute inset-0 bg-white/20"></div>
                </div>
                <h2 class="text-3xl font-bold text-white mb-3">Moon Casino</h2>
                <p class="text-[#6b7280]">Please login or sign up to play</p>
            </div>
            
            <div id="loginForm" class="space-y-5">
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block tracking-wider">Email</label>
                    <input type="email" id="loginEmail" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3.5 text-white focus:outline-none focus:border-[#8b5cf6] transition-all duration-300" placeholder="Enter your email">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block tracking-wider">Password</label>
                    <input type="password" id="loginPassword" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3.5 text-white focus:outline-none focus:border-[#8b5cf6] transition-all duration-300" placeholder="Enter your password">
                </div>
                <button onclick="app.login()" class="w-full btn-primary py-3.5 rounded-xl font-bold text-lg tracking-wider">Login</button>
                <p class="text-center text-[#6b7280] text-sm">
                    Don't have an account? 
                    <button onclick="app.showSignup()" class="text-[#8b5cf6] hover:text-[#7c3aed] transition-all duration-300 font-bold">Sign up</button>
                </p>
            </div>
            
            <div id="signupForm" class="space-y-5 hidden">
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block tracking-wider">Username</label>
                    <input type="text" id="signupUsername" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3.5 text-white focus:outline-none focus:border-[#8b5cf6] transition-all duration-300" placeholder="Choose a username">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block tracking-wider">Email</label>
                    <input type="email" id="signupEmail" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3.5 text-white focus:outline-none focus:border-[#8b5cf6] transition-all duration-300" placeholder="Enter your email">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-2 block tracking-wider">Password</label>
                    <input type="password" id="signupPassword" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3.5 text-white focus:outline-none focus:border-[#8b5cf6] transition-all duration-300" placeholder="Create a password">
                </div>
                <button onclick="app.signup()" class="w-full btn-primary py-3.5 rounded-xl font-bold text-lg tracking-wider">Sign Up</button>
                <p class="text-center text-[#6b7280] text-sm">
                    Already have an account? 
                    <button onclick="app.showLogin()" class="text-[#8b5cf6] hover:text-[#7c3aed] transition-all duration-300 font-bold">Login</button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Wallet Modal -->
    <div id="depositModal" class="modal">
        <div class="modal-content p-6 md:p-8">
            <div class="flex justify-between items-center mb-6 md:mb-8">
                <h2 class="text-xl md:text-2xl font-bold text-white">Wallet</h2>
                <button onclick="app.closeDepositModal()" class="text-[#6b7280] hover:text-white transition-all duration-300 hover:scale-110">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-6 md:space-y-8">
                <!-- Balance Display -->
                <div class="bg-gradient-to-r from-[#1e293b] to-[#0f172a] rounded-2xl p-4 md:p-6 border border-[#2a3042] relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-24 h-24 md:w-32 md:h-32 bg-[#8b5cf6] rounded-full -mr-8 md:-mr-16 -mt-8 md:-mt-16 opacity-10"></div>
                    <div class="relative z-10">
                        <div class="text-center mb-2">
                            <div class="text-gray-400 text-sm mb-2 tracking-wider">Your Balance</div>
                            <div class="text-white font-bold text-3xl md:text-4xl mb-4 md:mb-6" id="modalBalance">500</div>
                            <div class="text-gray-500 text-xs">Play games to earn more coins!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Free Coins Section -->
                <div class="text-center">
                    <i class="fa-solid fa-gift text-[#8b5cf6] text-4xl md:text-5xl mb-4"></i>
                    <h3 class="text-white font-bold text-lg md:text-xl mb-2">Free Coins</h3>
                    <p class="text-[#6b7280] text-sm mb-6">Claim 500 free coins when balance is under 100</p>
                    <div class="bg-gradient-to-r from-[#11141c] to-[#0b0e14] rounded-2xl p-4 md:p-6 border border-[#2a3042]">
                        <div class="text-white font-bold text-2xl md:text-3xl mb-4" id="freeCoinsTimer">Claim Now!</div>
                        <button id="claimCoinsBtn" onclick="app.claimFreeCoins()" class="w-full btn-primary py-3 md:py-4 rounded-xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300">
                            Claim 500 Coins
                        </button>
                    </div>
                </div>
                
                <!-- Send Money Section -->
                <div class="border-t border-[#2a3042] pt-6 md:pt-8">
                    <h3 class="text-white font-bold text-lg md:text-xl mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-money-bill-transfer text-[#10b981]"></i>
                        Send Money
                    </h3>
                    <div class="space-y-4 md:space-y-5">
                        <div>
                            <label class="text-xs text-[#6b7280] font-bold mb-3 block tracking-wider">Recipient Username</label>
                            <input type="text" id="sendToUsername" placeholder="Enter username" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-4 md:px-5 py-3 md:py-3.5 text-white focus:outline-none focus:border-[#10b981] transition-all duration-300">
                        </div>
                        <div>
                            <label class="text-xs text-[#6b7280] font-bold mb-3 block tracking-wider">Amount to Send</label>
                            <input type="number" id="sendAmount" placeholder="0" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-4 md:px-5 py-3 md:py-3.5 text-white focus:outline-none focus:border-[#10b981] transition-all duration-300">
                        </div>
                        <button onclick="app.sendMoney()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white py-3 md:py-4 rounded-xl font-bold text-lg tracking-wider transition-all duration-300 hover:scale-[1.02]">
                            <i class="fa-solid fa-paper-plane mr-2"></i> Send Money
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Sound Effects
        const sounds = {
            card: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-card-shuffle-2464.mp3'),
            win: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
            lose: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-losing-bleeps-2026.mp3'),
            mine: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-bomb-explosion-in-the-air-2801.mp3'),
            gem: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'),
            click: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3')
        };

        // Set volume for all sounds
        Object.values(sounds).forEach(sound => {
            sound.volume = 0.3;
            sound.preload = 'auto';
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLmhwz-ocTNaZwWchcpWl3N0hJMlsskts",
            authDomain: "nebula-48dbd.firebaseapp.com",
            databaseURL: "https://nebula-48dbd-default-rtdb.firebaseio.com",
            projectId: "nebula-48dbd",
            storageBucket: "nebula-48dbd.firebasestorage.app",
            messagingSenderId: "259199297883",
            appId: "1:259199297883:web:f84fe6b2fc2ca70015d27e",
            measurementId: "G-38CB3Y2T56"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        class GameApp {
            constructor() {
                this.user = null;
                this.balance = 500;
                this.username = '';
                this.userId = '';
                this.activeGame = null;
                this.mainContent = document.getElementById('mainContent');
                this.balanceDisplay = document.getElementById('balanceDisplay');
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOpen = false;
                this.chatSidebar = document.getElementById('chatSidebar');
                this.soundEnabled = true;
                this.minesActive = false;
                this.bjInProgress = false;
                this.lastFreeCoinsClaim = 0;
                this.bigWinThreshold = 1000;
                this.chatLoadedAt = null;
                this.liveWinsInterval = null;
                this.minesDragging = false;
                this.minesDragStartTile = null;
                this.minesSelectedTiles = new Set();
                this.isAdmin = false;
                this.rainActive = false;
                this.rainTimer = null;
                this.rainData = null;
                this.rpsGame = null;
                this.rpsOpponent = null;
                this.rpsChoice = null;
                this.rpsBet = 0;
                this.rpsGameId = null;
                
                // Mines game state
                this.minesBet = 0;
                this.minesCount = 3;
                this.minesRevealedCount = 0;
                this.minesGrid = [];
                
                // Initialize app
                this.init();
            }

            init() {
                this.checkAuth();
                this.initChat();
                this.setupFreeCoinsTimer();
                this.listenForBigWins();
                this.checkRain();
                
                // Set default home page
                this.loadGame('home');
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 768 && this.sidebarOpen && 
                        !this.sidebar.contains(e.target) && 
                        !e.target.closest('[onclick*="toggleSidebar"]')) {
                        this.toggleSidebar();
                    }
                });
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                const toggleBtn = document.getElementById('soundToggle');
                const icon = toggleBtn.querySelector('i');
                
                if (this.soundEnabled) {
                    toggleBtn.classList.remove('muted');
                    icon.className = 'fa-solid fa-volume-high';
                    this.showToast('Sound enabled', 'success');
                } else {
                    toggleBtn.classList.add('muted');
                    icon.className = 'fa-solid fa-volume-xmark';
                    this.showToast('Sound muted', 'warning');
                }
            }

            playSound(soundName) {
                if (!this.soundEnabled || !sounds[soundName]) return;
                
                try {
                    const soundClone = sounds[soundName].cloneNode();
                    soundClone.volume = sounds[soundName].volume;
                    soundClone.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Sound error:', e);
                }
            }

            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                if (this.sidebarOpen) {
                    this.sidebar.classList.remove('-translate-x-full');
                } else {
                    this.sidebar.classList.add('-translate-x-full');
                }
            }

            toggleChat() {
                this.chatSidebar.classList.toggle('hidden');
                this.playSound('click');
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="flex items-center gap-4">
                        <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'} text-xl"></i>
                        <span class="font-medium">${message}</span>
                    </div>
                `;
                
                document.getElementById('toastContainer').appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            updateBalance() {
                if (this.balanceDisplay) {
                    this.balanceDisplay.textContent = this.balance.toLocaleString();
                    
                    // Update modal balance display
                    const modalBalance = document.getElementById('modalBalance');
                    if (modalBalance) {
                        modalBalance.textContent = this.balance.toLocaleString();
                    }
                    
                    // Animation effect
                    this.balanceDisplay.classList.add('text-[#10b981]', 'scale-110');
                    setTimeout(() => {
                        this.balanceDisplay.classList.remove('text-[#10b981]', 'scale-110');
                    }, 500);
                }
                
                // Save to localStorage
                if (this.userId) {
                    localStorage.setItem(`balance_${this.userId}`, this.balance);
                    
                    // Update in Firebase if user is logged in
                    if (this.username) {
                        database.ref('users/' + this.userId + '/balance').set(this.balance);
                    }
                }
            }

            // Auth Functions
            checkAuth() {
                const savedUser = localStorage.getItem('moonCasinoUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        this.userId = user.userId;
                        this.username = user.username;
                        this.balance = parseInt(localStorage.getItem(`balance_${user.userId}`)) || 500;
                        this.isAdmin = user.isAdmin || false;
                        this.updateUI();
                        this.hideAuthModal();
                    } catch (e) {
                        this.showAuthModal();
                    }
                } else {
                    this.showAuthModal();
                }
            }

            showAuthModal() {
                document.getElementById('authModal').classList.add('active');
            }

            hideAuthModal() {
                document.getElementById('authModal').classList.remove('active');
            }

            showSignup() {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
                this.playSound('click');
            }

            showLogin() {
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                this.playSound('click');
            }

            async signup() {
                const username = document.getElementById('signupUsername').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;

                if (!username || !email || !password) {
                    this.showToast('Please fill all fields', 'error');
                    return;
                }

                if (username.length < 3) {
                    this.showToast('Username must be at least 3 characters', 'error');
                    return;
                }

                // Check if username exists
                const usernameSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
                if (usernameSnapshot.exists()) {
                    this.showToast('Username already taken', 'error');
                    return;
                }

                // Check if email exists
                const emailSnapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
                if (emailSnapshot.exists()) {
                    this.showToast('Email already registered', 'error');
                    return;
                }

                // Create user
                const userId = 'user_' + Date.now();
                const userData = {
                    userId,
                    username,
                    email,
                    password: btoa(password),
                    balance: 500,
                    createdAt: Date.now(),
                    lastFreeCoins: 0,
                    totalWins: 0,
                    totalLosses: 0,
                    biggestWin: 0,
                    wageredToday: 0,
                    wageredWeek: 0,
                    wageredLifetime: 0,
                    wonToday: 0,
                    lastWagered: Date.now(),
                    banned: false,
                    isAdmin: false,
                    rpsWins: 0,
                    rpsLosses: 0,
                    rpsTies: 0
                };

                await database.ref('users/' + userId).set(userData);

                // Save locally
                localStorage.setItem('moonCasinoUser', JSON.stringify({ userId, username, isAdmin: false }));
                localStorage.setItem(`balance_${userId}`, 500);

                this.userId = userId;
                this.username = username;
                this.balance = 500;
                this.lastFreeCoinsClaim = 0;
                this.isAdmin = false;

                this.updateUI();
                this.hideAuthModal();
                this.showToast('Welcome to Moon Casino! You received 500 starting coins!', 'success');
                this.playSound('win');
                this.updateOnlineStatus();
                
                // Confetti for new user
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            async login() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                // Find user by email
                const snapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');

                if (!snapshot.exists()) {
                    this.showToast('User not found', 'error');
                    return;
                }

                let userFound = null;
                snapshot.forEach(child => {
                    const user = child.val();
                    if (atob(user.password) === password) {
                        userFound = user;
                    }
                });

                if (!userFound) {
                    this.showToast('Invalid password', 'error');
                    return;
                }

                if (userFound.banned) {
                    this.showToast('Account is banned', 'error');
                    return;
                }

                // Save locally
                localStorage.setItem('moonCasinoUser', JSON.stringify({
                    userId: userFound.userId,
                    username: userFound.username,
                    isAdmin: userFound.isAdmin || false
                }));
                localStorage.setItem(`balance_${userFound.userId}`, userFound.balance || 500);

                this.userId = userFound.userId;
                this.username = userFound.username;
                this.balance = userFound.balance || 500;
                this.lastFreeCoinsClaim = userFound.lastFreeCoins || 0;
                this.isAdmin = userFound.isAdmin || false;

                this.updateUI();
                this.hideAuthModal();
                this.showToast(`Welcome back ${this.username}!`, 'success');
                this.playSound('win');
                this.updateOnlineStatus();
            }

            logout() {
                // Leave RPS game if in one
                if (this.rpsGameId) {
                    this.leaveRPSGame();
                }
                
                localStorage.removeItem('moonCasinoUser');
                localStorage.removeItem(`balance_${this.userId}`);
                this.userId = '';
                this.username = '';
                this.balance = 500;
                this.isAdmin = false;
                this.rpsGameId = null;
                this.rpsChoice = null;
                this.showAuthModal();
                this.updateUI();
                
                // Remove from online users
                if (this.userId) {
                    database.ref('online/' + this.userId).remove();
                }
                
                this.showToast('Logged out successfully', 'warning');
            }

            updateUI() {
                document.getElementById('loggedUsername').textContent = this.username || 'Guest';
                document.getElementById('userIdDisplay').textContent = this.userId || 'Not logged in';
                document.getElementById('userAvatar').textContent = this.username ? this.username.charAt(0).toUpperCase() : 'U';
                this.updateBalance();
                
                // Hide admin button if not admin
                if (!this.isAdmin) {
                    document.getElementById('nav-admin').classList.add('hidden');
                } else {
                    document.getElementById('nav-admin').classList.remove('hidden');
                }
            }

            async updateOnlineStatus() {
                if (!this.userId) return;

                // Set user as online
                await database.ref('online/' + this.userId).set({
                    username: this.username,
                    lastSeen: Date.now(),
                    game: this.activeGame
                });

                // Remove after 2 minutes of inactivity
                setTimeout(() => {
                    database.ref('online/' + this.userId).remove();
                }, 120000);

                // Listen for online users
                database.ref('online').on('value', (snapshot) => {
                    const onlineCount = snapshot.numChildren();
                    document.getElementById('onlineCount').textContent = onlineCount + ' Online';
                });
            }

            // Wallet Functions
            openDepositModal() {
                if (!this.userId) {
                    this.showToast('Please login first', 'error');
                    return;
                }
                document.getElementById('depositModal').classList.add('active');
                this.updateFreeCoinsButton();
                
                // Update modal balance display
                document.getElementById('modalBalance').textContent = this.balance.toLocaleString();
                this.playSound('click');
            }

            closeDepositModal() {
                document.getElementById('depositModal').classList.remove('active');
                this.playSound('click');
            }

            setupFreeCoinsTimer() {
                setInterval(() => {
                    this.updateFreeCoinsButton();
                }, 1000);
            }

            updateFreeCoinsButton() {
                const now = Date.now();
                const claimButton = document.getElementById('claimCoinsBtn');
                const timerElement = document.getElementById('freeCoinsTimer');

                if (claimButton && timerElement) {
                    // ALWAYS allow claim if balance is under 100
                    const canClaim = this.balance < 100;
                    
                    claimButton.disabled = !canClaim;
                    
                    if (canClaim) {
                        timerElement.textContent = 'Claim Now!';
                        claimButton.textContent = 'Claim 500 Coins';
                        claimButton.className = 'w-full btn-primary py-3 md:py-4 rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02]';
                    } else {
                        timerElement.textContent = 'Balance too high';
                        claimButton.textContent = 'Balance must be under 100';
                        claimButton.className = 'w-full bg-gray-700 text-gray-400 py-3 md:py-4 rounded-xl font-bold text-lg cursor-not-allowed';
                    }
                }
            }

            async claimFreeCoins() {
                if (!this.userId) return;

                if (this.balance >= 100) {
                    this.showToast('You must have less than 100 coins to claim', 'error');
                    return;
                }

                this.balance += 500;
                this.lastFreeCoinsClaim = Date.now();

                // Update in database
                if (this.username) {
                    await database.ref('users/' + this.userId).update({
                        balance: this.balance,
                        lastFreeCoins: this.lastFreeCoinsClaim
                    });
                }

                this.updateBalance();
                this.updateFreeCoinsButton();
                this.showToast('500 free coins claimed!', 'success');
                this.playSound('win');

                // Confetti effect
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            async sendMoney() {
                if (!this.userId) return;

                const recipientUsername = document.getElementById('sendToUsername').value.trim();
                const amount = parseFloat(document.getElementById('sendAmount').value);

                if (!recipientUsername || !amount) {
                    this.showToast('Please fill all fields', 'error');
                    return;
                }

                if (amount <= 0) {
                    this.showToast('Amount must be positive', 'error');
                    return;
                }

                if (amount > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                if (recipientUsername === this.username) {
                    this.showToast('Cannot send money to yourself', 'error');
                    return;
                }

                // Find recipient
                const snapshot = await database.ref('users').orderByChild('username').equalTo(recipientUsername).once('value');

                if (!snapshot.exists()) {
                    this.showToast('User not found', 'error');
                    return;
                }

                let recipientId = null;
                let recipient = null;
                snapshot.forEach(child => {
                    recipientId = child.key;
                    recipient = child.val();
                });

                if (!recipientId) {
                    this.showToast('User not found', 'error');
                    return;
                }

                if (recipient.banned) {
                    this.showToast('Cannot send to banned user', 'error');
                    return;
                }

                // Update balances
                this.balance -= amount;
                const newRecipientBalance = (recipient.balance || 0) + amount;

                // Update in database
                await database.ref('users/' + this.userId + '/balance').set(this.balance);
                await database.ref('users/' + recipientId + '/balance').set(newRecipientBalance);

                this.updateBalance();
                this.showToast(`Sent ${amount} coins to ${recipientUsername}`, 'success');
                this.playSound('click');

                // Clear form
                document.getElementById('sendToUsername').value = '';
                document.getElementById('sendAmount').value = '';

                // Add transaction record
                const transaction = {
                    from: this.username,
                    to: recipientUsername,
                    amount: amount,
                    timestamp: Date.now(),
                    type: 'transfer'
                };

                await database.ref('transactions').push(transaction);

                // Add chat message
                this.addChatMessage('System', `${this.username} sent ${amount} coins to ${recipientUsername}!`, 'text-[#10b981]');
            }

            // Chat Functions
            initChat() {
                this.chatLoadedAt = Date.now();
                
                // Only listen for NEW messages from now on
                database.ref('chat').orderByChild('timestamp').startAt(this.chatLoadedAt).on('child_added', (snapshot) => {
                    const msg = snapshot.val();
                    if (msg.userId !== this.userId) { // Don't show own messages again
                        this.addChatMessage(msg.username, msg.message, 'text-white', false);
                    }
                });
                
                // Clear existing messages on init
                const messages = document.getElementById('chatMessages');
                if (messages) {
                    messages.innerHTML = '';
                }
            }

            addChatMessage(user, msg, color = 'text-white', saveToDB = true) {
                const messages = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = `flex gap-3 ${color}`;
                div.innerHTML = `
                    <span class="font-bold min-w-[80px]">${user}:</span> 
                    <span class="flex-1">${msg}</span>
                `;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;

                if (saveToDB && this.userId) {
                    database.ref('chat').push({
                        username: user,
                        message: msg,
                        userId: this.userId,
                        timestamp: Date.now()
                    });
                }
            }

            addBigWinNotification(username, amount, game) {
                const messages = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = 'big-win-notification';
                div.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <i class="fa-solid fa-trophy text-yellow-400"></i>
                        <div class="username">${username}</div>
                        <i class="fa-solid fa-trophy text-yellow-400"></i>
                    </div>
                    <div class="amount">${amount.toLocaleString()} coins</div>
                    <div class="text-gray-300 text-sm mt-1">won in ${game}!</div>
                `;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            sendChatMessage(e) {
                e.preventDefault();
                if (!this.userId) {
                    this.showToast('Please login to chat', 'error');
                    return;
                }

                const input = document.getElementById('chatInput');
                if (input && input.value.trim()) {
                    const msg = input.value.trim();
                    this.addChatMessage(this.username, msg, 'text-[#8b5cf6]');
                    input.value = '';
                    this.playSound('click');
                }
            }

            // Record Wager
            async recordWager(amount) {
                if (!this.userId || amount <= 0) return;

                const now = Date.now();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const weekAgo = now - (7 * 24 * 60 * 60 * 1000);

                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                let wageredToday = user.wageredToday || 0;
                let wageredWeek = user.wageredWeek || 0;
                
                // Reset today's wager if it's a new day
                if (user.lastWagered && user.lastWagered < today.getTime()) {
                    wageredToday = 0;
                }

                const updates = {
                    wageredToday: wageredToday + amount,
                    wageredWeek: wageredWeek + amount,
                    wageredLifetime: (user.wageredLifetime || 0) + amount,
                    lastWagered: now
                };

                await userRef.update(updates);
            }

            // Record Win/Loss
            async recordWin(amount, game) {
                if (!this.userId || amount <= 0) return;

                // Update user stats
                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let wonToday = user.wonToday || 0;
                
                // Reset today's win if it's a new day
                if (user.lastWin && user.lastWin < today.getTime()) {
                    wonToday = 0;
                }

                const updates = {
                    totalWins: (user.totalWins || 0) + 1,
                    biggestWin: Math.max(user.biggestWin || 0, amount),
                    wonToday: wonToday + amount,
                    lastWin: Date.now()
                };

                await userRef.update(updates);

                // Record transaction
                const transaction = {
                    userId: this.userId,
                    username: this.username,
                    amount: amount,
                    type: 'win',
                    game: game,
                    timestamp: Date.now()
                };

                await database.ref('transactions').push(transaction);

                // Announce big win in chat
                if (amount >= this.bigWinThreshold) {
                    this.addBigWinNotification(this.username, amount, game);
                    
                    // Also save as system message
                    this.addChatMessage('System', 
                        `ðŸŽ‰ ${this.username} just won ${amount.toLocaleString()} coins in ${game}! ðŸŽ‰`, 
                        'text-yellow-400', true);
                }
            }

            async recordLoss(amount, game) {
                if (!this.userId || amount <= 0) return;

                // Update user stats
                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                const updates = {
                    totalLosses: (user.totalLosses || 0) + 1
                };

                await userRef.update(updates);

                // Record transaction
                const transaction = {
                    userId: this.userId,
                    username: this.username,
                    amount: amount,
                    type: 'loss',
                    game: game,
                    timestamp: Date.now()
                };

                await database.ref('transactions').push(transaction);
            }

            listenForBigWins() {
                // Listen for big wins from other users
                database.ref('transactions').orderByChild('timestamp').startAt(Date.now()).on('child_added', (snapshot) => {
                    const transaction = snapshot.val();
                    
                    // Check if it's a big win from another user
                    if (transaction.type === 'win' && 
                        transaction.amount >= this.bigWinThreshold && 
                        transaction.userId !== this.userId) {
                        
                        // Add to chat with slight delay
                        setTimeout(() => {
                            this.addBigWinNotification(transaction.username, transaction.amount, transaction.game);
                        }, 1000);
                    }
                });
            }

            // Rain System
            async checkRain() {
                database.ref('rain').on('value', (snapshot) => {
                    const rainData = snapshot.val();
                    if (rainData && rainData.active) {
                        this.rainActive = true;
                        this.rainData = rainData;
                        this.showRainPanel(rainData);
                    } else {
                        this.rainActive = false;
                        this.hideRainPanel();
                    }
                });
            }

            showRainPanel(rainData) {
                const rainPanel = document.getElementById('rainPanel');
                const rainIndicator = document.getElementById('rainIndicator');
                
                if (rainPanel) {
                    rainPanel.classList.remove('hidden');
                    document.getElementById('rainAmount').textContent = rainData.amount.toLocaleString() + ' coins';
                    document.getElementById('rainParticipants').textContent = rainData.participants ? Object.keys(rainData.participants).length + ' participants' : '0 participants';
                    
                    // Start timer
                    this.startRainTimer(rainData.endTime);
                }
                
                if (rainIndicator) {
                    rainIndicator.classList.remove('hidden');
                }
            }

            hideRainPanel() {
                const rainPanel = document.getElementById('rainPanel');
                const rainIndicator = document.getElementById('rainIndicator');
                
                if (rainPanel) {
                    rainPanel.classList.add('hidden');
                }
                
                if (rainIndicator) {
                    rainIndicator.classList.add('hidden');
                }
                
                if (this.rainTimer) {
                    clearInterval(this.rainTimer);
                }
            }

            startRainTimer(endTime) {
                if (this.rainTimer) {
                    clearInterval(this.rainTimer);
                }

                this.rainTimer = setInterval(() => {
                    const now = Date.now();
                    const timeLeft = Math.max(0, endTime - now);
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);

                    const timerElement = document.getElementById('rainTimer');
                    if (timerElement) {
                        timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }

                    if (timeLeft <= 0) {
                        clearInterval(this.rainTimer);
                    }
                }, 1000);
            }

            async joinRain() {
                if (!this.userId) {
                    this.showToast('Please login to join rain', 'error');
                    return;
                }

                if (!this.rainActive || !this.rainData) {
                    this.showToast('No active rain', 'error');
                    return;
                }

                // Check if already joined
                if (this.rainData.participants && this.rainData.participants[this.userId]) {
                    this.showToast('Already joined rain', 'warning');
                    return;
                }

                // Add user to participants
                await database.ref('rain/participants/' + this.userId).set({
                    username: this.username,
                    joinedAt: Date.now()
                });

                this.showToast('Joined rain!', 'success');
                this.playSound('click');
            }

            // Game Loading
            loadGame(gameName) {
                if (window.innerWidth < 768) {
                    this.toggleSidebar();
                }

                // Update active nav
                document.querySelectorAll('#sidebar button').forEach(b => {
                    b.classList.remove('bg-gradient-to-r', 'from-[#2a3042]', 'to-[#1e293b]', 'text-white');
                });
                const navBtn = document.getElementById(`nav-${gameName}`);
                if (navBtn) {
                    navBtn.classList.add('bg-gradient-to-r', 'from-[#2a3042]', 'to-[#1e293b]', 'text-white');
                }

                this.activeGame = gameName;
                this.mainContent.innerHTML = '';
                this.mainContent.scrollTop = 0;

                switch (gameName) {
                    case 'home':
                        this.renderHome();
                        break;
                    case 'mines':
                        this.renderMines();
                        break;
                    case 'blackjack':
                        this.renderBlackjack();
                        break;
                    case 'rps':
                        this.renderRPS();
                        break;
                    case 'leaderboard':
                        this.renderLeaderboard();
                        break;
                    case 'admin':
                        this.renderAdminPanel();
                        break;
                    default:
                        this.renderHome();
                }
                
                this.playSound('click');
            }

            renderHome() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto space-y-6">
                        <div class="rounded-3xl bg-gradient-to-r from-[#4c1d95] to-[#2e1065] p-6 md:p-8 relative overflow-hidden border border-[#8b5cf6]/30 shadow-2xl">
                            <div class="absolute top-0 right-0 w-96 h-96 bg-[#8b5cf6] rounded-full mix-blend-overlay filter blur-[100px] opacity-30"></div>
                            <div class="relative z-10">
                                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 border border-white/20 backdrop-blur-md text-sm font-bold text-white mb-4 tracking-wider">
                                    <span class="w-2.5 h-2.5 bg-[#10b981] rounded-full animate-pulse"></span> PREMIUM CASINO
                                </div>
                                <h1 class="text-3xl md:text-5xl font-bold text-white mb-4 leading-tight">Welcome, <span class="text-[#a78bfa]">${this.username || 'Guest'}</span>!</h1>
                                <p class="text-[#d8b4fe] text-lg max-w-2xl mb-6">Experience the ultimate crypto casino with fair games, stunning animations, and real-time multiplayer features.</p>
                                <div class="flex flex-wrap gap-4">
                                    <button onclick="app.loadGame('blackjack')" class="btn-primary px-6 md:px-10 py-3 md:py-4 rounded-2xl font-bold text-lg md:text-xl shadow-xl hover:scale-105 transition-all duration-300">
                                        <i class="fa-solid fa-diamond mr-3"></i> Play Blackjack
                                    </button>
                                    <button onclick="app.openDepositModal()" class="bg-gradient-to-r from-[#1f2937] to-[#374151] hover:from-[#374151] hover:to-[#4b5563] text-white px-6 md:px-10 py-3 md:py-4 rounded-2xl font-bold text-lg md:text-xl border border-[#374151] transition-all duration-300 hover:scale-105">
                                        <i class="fa-solid fa-gift mr-3"></i> Free Coins
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Wins Panel -->
                        <div class="live-wins-panel">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-2 h-2 bg-[#10b981] rounded-full animate-pulse"></div>
                                <h3 class="text-white font-bold text-lg">Live Wins</h3>
                            </div>
                            <div id="liveWinsContainer" class="space-y-2">
                                <div class="text-center text-gray-500 py-8">Loading live wins...</div>
                            </div>
                        </div>
                        
                        <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                            <i class="fa-solid fa-gamepad text-[#8b5cf6]"></i> Featured Games
                        </h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-8">
                            ${this.getGameCard('mines', 'Mines', 'fa-bomb', 'from-[#451a03] to-[#2a1205]', 'Reveal gems, avoid bombs', '#f59e0b')}
                            ${this.getGameCard('blackjack', 'Blackjack', 'fa-diamond', 'from-[#064e3b] to-[#022c22]', 'Classic 21 vs Dealer', '#10b981')}
                            ${this.getGameCard('rps', 'Rock Paper Scissors', 'fa-hand-back-fist', 'from-[#1e3a8a] to-[#1e40af]', 'Multiplayer PvP', '#8b5cf6')}
                        </div>
                    </div>
                `;
                
                // Start live wins updates
                this.startLiveWinsUpdates();
            }

            startLiveWinsUpdates() {
                // Clear existing interval
                if (this.liveWinsInterval) {
                    clearInterval(this.liveWinsInterval);
                }
                
                // Load initial wins
                this.loadLiveWins();
                
                // Update every 10 seconds
                this.liveWinsInterval = setInterval(() => {
                    this.loadLiveWins();
                }, 10000);
            }

            async loadLiveWins() {
                try {
                    // Get recent wins from transactions
                    const snapshot = await database.ref('transactions')
                        .orderByChild('timestamp')
                        .limitToLast(10)
                        .once('value');
                    
                    const wins = [];
                    snapshot.forEach(child => {
                        const tx = child.val();
                        if (tx.type === 'win' && tx.amount >= 100) { // Show wins over 100 coins
                            wins.push(tx);
                        }
                    });
                    
                    // Reverse to show newest first
                    wins.reverse();
                    
                    const container = document.getElementById('liveWinsContainer');
                    if (!container) return;
                    
                    if (wins.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8">No recent wins yet</div>';
                        return;
                    }
                    
                    container.innerHTML = wins.map(win => `
                        <div class="live-win-item">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-teal-400 flex items-center justify-center text-white font-bold text-sm">
                                        ${win.username ? win.username.charAt(0).toUpperCase() : 'U'}
                                    </div>
                                    <div>
                                        <div class="text-white font-bold">${win.username}</div>
                                        <div class="text-gray-400 text-xs">${this.timeAgo(win.timestamp)}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[#10b981] font-bold text-lg">+${win.amount.toLocaleString()}</div>
                                    <div class="text-gray-400 text-xs">${win.game}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading live wins:', error);
                }
            }

            timeAgo(timestamp) {
                const seconds = Math.floor((Date.now() - timestamp) / 1000);
                
                if (seconds < 60) return 'just now';
                if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
                if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
                return Math.floor(seconds / 86400) + 'd ago';
            }

            getGameCard(id, name, icon, gradient, desc, color) {
                return `
                    <div onclick="app.loadGame('${id}')" class="game-card cursor-pointer rounded-2xl overflow-hidden group relative h-48">
                        <div class="absolute inset-0 bg-gradient-to-br ${gradient} opacity-90 transition-all duration-500 group-hover:opacity-100"></div>
                        <div class="absolute inset-0 p-6 flex flex-col justify-between z-10">
                            <div class="flex justify-between items-start">
                                <div class="bg-black/30 p-3 rounded-2xl backdrop-blur-sm">
                                    <i class="fa-solid ${icon} text-2xl text-white"></i>
                                </div>
                                <i class="fa-solid fa-arrow-right text-white/50 -translate-x-3 opacity-0 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-500 text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white mb-2">${name}</h3>
                                <p class="text-white/70 text-sm">${desc}</p>
                                <div class="mt-3">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-bold" style="background: ${color}20; color: ${color}">PLAY NOW</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // MINES GAME - FIXED
            renderMines() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-6 min-h-[500px]">
                        <div class="w-full lg:w-1/3 bg-gradient-to-b from-[#161b26] to-[#11141c] p-6 rounded-3xl border border-[#2a3042] shadow-2xl">
                            <div class="mb-6">
                                <label class="text-sm text-[#8b5cf6] font-bold mb-3 block tracking-wider">Bet Amount</label>
                                <div class="flex bg-gradient-to-r from-[#0b0e14] to-[#1e293b] rounded-xl border border-[#2a3042] p-1">
                                    <div class="pl-4 py-3 text-[#8b5cf6] font-bold"><i class="fa-solid fa-coins"></i></div>
                                    <input type="number" id="minesBetInput" value="10" min="1" max="${this.balance}" class="w-full bg-transparent text-white px-4 font-bold text-lg outline-none">
                                    <div class="flex pr-2">
                                        <button onclick="app.adjustMinesBet(0.5)" class="px-4 text-sm font-bold text-[#8b5cf6] hover:text-white transition-all duration-300">Â½</button>
                                        <button onclick="app.adjustMinesBet(2)" class="px-4 text-sm font-bold text-[#8b5cf6] hover:text-white transition-all duration-300">2x</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label class="text-sm text-[#8b5cf6] font-bold mb-3 block tracking-wider">Mines Count</label>
                                <div class="grid grid-cols-5 gap-2">
                                    ${[1,3,5,10,24].map(n => `
                                        <button onclick="app.setMinesCount(${n})" class="bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] text-[#b1bad3] rounded-xl py-2.5 font-bold hover:border-[#8b5cf6] hover:text-white transition-all duration-300 ${n===3?'border-[#8b5cf6] text-white shadow-[0_0_20px_rgba(139,92,246,0.3)]':''}" data-val="${n}">${n}</button>
                                    `).join('')}
                                </div>
                                <input type="hidden" id="minesCountInput" value="3">
                            </div>
                            <div class="bg-gradient-to-r from-[#0b0e14] to-[#1e293b] rounded-2xl p-4 mb-6 border border-[#2a3042] flex justify-between items-center">
                                <div>
                                    <div class="text-xs text-[#6b7280] tracking-wider">Next Tile</div>
                                    <div class="text-[#10b981] font-bold text-xl" id="minesNextMult">1.13x</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-[#6b7280] tracking-wider">Profit</div>
                                    <div class="text-white font-bold text-xl" id="minesProfit">0</div>
                                </div>
                            </div>
                            <button id="minesBtn" onclick="app.playMines()" class="w-full btn-primary py-4 rounded-2xl font-bold text-lg tracking-wider hover:scale-[1.02] transition-all duration-300">
                                <i class="fa-solid fa-play mr-2"></i> Start Game
                            </button>
                        </div>
                        <div class="flex-1 w-full bg-gradient-to-b from-[#161b26] to-[#11141c] rounded-3xl p-6 border border-[#2a3042] shadow-2xl flex items-center justify-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-[#8b5cf6] via-[#10b981] to-[#8b5cf6] animate-shimmer"></div>
                            <div class="mines-grid-container">
                                ${Array(25).fill(0).map((_,i)=>`
                                    <div id="tile-${i}" 
                                         onclick="app.clickMineTile(${i})"
                                         class="mine-tile-modern"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                this.minesActive = false;
                this.setMinesCount(3);
            }

            adjustMinesBet(multiplier) {
                const betInput = document.getElementById('minesBetInput');
                const currentBet = parseFloat(betInput.value) || 10;
                let newBet = currentBet * multiplier;
                newBet = Math.round(newBet);
                newBet = Math.max(1, Math.min(newBet, this.balance));
                betInput.value = newBet;
                this.playSound('click');
            }

            setMinesCount(n) {
                if (this.minesActive) return;
                document.getElementById('minesCountInput').value = n;
                document.querySelectorAll('[data-val]').forEach(b => {
                    b.classList.remove('border-[#8b5cf6]', 'text-white', 'shadow-[0_0_20px_rgba(139,92,246,0.3)]');
                    if (parseInt(b.dataset.val) === n) {
                        b.classList.add('border-[#8b5cf6]', 'text-white', 'shadow-[0_0_20px_rgba(139,92,246,0.3)]');
                    }
                });
                this.updateMinesNextMult();
                this.playSound('click');
            }

            updateMinesNextMult() {
                if (!this.minesActive) {
                    const m = parseInt(document.getElementById('minesCountInput').value);
                    const mult = this.calculateMinesMultiplier(m, 1);
                    document.getElementById('minesNextMult').textContent = mult.toFixed(2) + 'x';
                    return;
                }
                const m = this.minesCount;
                const r = this.minesRevealedCount + 1;
                const mult = this.calculateMinesMultiplier(m, r);
                document.getElementById('minesNextMult').textContent = mult.toFixed(2) + 'x';
            }

            calculateMinesMultiplier(mines, revealed) {
                let multiplier = 1.0;
                for (let i = 0; i < revealed; i++) {
                    multiplier *= (25 - i) / (25 - mines - i);
                }
                return multiplier;
            }

            playMines() {
                if (!this.userId) {
                    this.showToast('Please login to play', 'error');
                    return;
                }

                if (this.minesActive) {
                    this.cashOutMines();
                    return;
                }

                const betInput = document.getElementById('minesBetInput');
                const bet = parseFloat(betInput.value);
                const mines = parseInt(document.getElementById('minesCountInput').value);

                if (isNaN(bet) || bet <= 0) {
                    this.showToast('Please enter a valid bet', 'error');
                    return;
                }

                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                this.playSound('click');
                this.balance -= bet;
                this.updateBalance();
                this.recordWager(bet);

                this.minesBet = bet;
                this.minesCount = mines;
                this.minesActive = true;
                this.minesRevealedCount = 0;
                this.minesGrid = Array(25).fill('safe');

                let placed = 0;
                while (placed < mines) {
                    const idx = Math.floor(Math.random() * 25);
                    if (this.minesGrid[idx] === 'safe') {
                        this.minesGrid[idx] = 'mine';
                        placed++;
                    }
                }

                console.log('Mines placed at positions:', this.minesGrid.map((v, i) => v === 'mine' ? i : -1).filter(i => i !== -1));

                const btn = document.getElementById('minesBtn');
                btn.innerHTML = '<i class="fa-solid fa-money-bill-wave mr-2"></i> Cash Out <span id="minesCashoutVal" class="ml-2 bg-white/20 px-3 py-1 rounded-lg text-sm">0</span>';
                btn.className = 'w-full bg-gradient-to-r from-[#10b981] to-[#059669] text-white py-4 rounded-2xl font-bold text-lg tracking-wider hover:scale-[1.02] transition-all duration-300';

                document.querySelectorAll('.mine-tile-modern').forEach(el => {
                    el.className = 'mine-tile-modern';
                    el.innerHTML = '';
                });

                this.updateMinesNextMult();
                document.getElementById('minesProfit').textContent = '0';
            }

            clickMineTile(idx) {
                if (!this.minesActive) return;
                const tile = document.getElementById(`tile-${idx}`);
                if (tile.classList.contains('revealed')) return;

                tile.classList.add('revealed');

                if (this.minesGrid[idx] === 'mine') {
                    tile.classList.add('mine');
                    tile.innerHTML = '<i class="fa-solid fa-bomb text-white text-3xl animate-bounce"></i>';
                    this.playSound('mine');
                    this.recordLoss(this.minesBet, 'Mines');
                    this.endMines(false, idx);
                } else {
                    tile.classList.add('gem');
                    tile.innerHTML = '<i class="fa-solid fa-gem text-[#10b981] text-2xl animate-pulse"></i>';
                    this.playSound('gem');
                    this.minesRevealedCount++;

                    const currentMult = this.calculateMinesMultiplier(this.minesCount, this.minesRevealedCount);
                    const currentWin = this.minesBet * currentMult;
                    document.getElementById('minesProfit').textContent = `${(currentWin - this.minesBet).toFixed(2)}`;

                    const cv = document.getElementById('minesCashoutVal');
                    if (cv) cv.textContent = `${currentWin.toFixed(2)}`;

                    this.updateMinesNextMult();

                    if (this.minesRevealedCount === (25 - this.minesCount)) {
                        this.cashOutMines();
                    }
                }
            }

            endMines(win, hitIdx) {
                this.minesActive = false;
                
                const btn = document.getElementById('minesBtn');
                if (btn) {
                    btn.innerHTML = '<i class="fa-solid fa-play mr-2"></i> Start Game';
                    btn.className = 'w-full btn-primary py-4 rounded-2xl font-bold text-lg tracking-wider hover:scale-[1.02] transition-all duration-300';
                }

                // Reveal all mines
                this.minesGrid.forEach((type, idx) => {
                    const tile = document.getElementById(`tile-${idx}`);
                    if (!tile.classList.contains('revealed')) {
                        tile.classList.add('revealed');
                        if (type === 'mine') {
                            tile.innerHTML = '<i class="fa-solid fa-bomb text-white text-lg opacity-30"></i>';
                            tile.classList.add('mine-hidden');
                        } else {
                            tile.innerHTML = '<i class="fa-solid fa-gem text-white/10 text-lg"></i>';
                            tile.classList.add('safe-hidden');
                        }
                    }
                });

                if (!win) {
                    this.showToast('Boom! You hit a mine!', 'error');
                }
            }

            cashOutMines() {
                const mult = this.calculateMinesMultiplier(this.minesCount, this.minesRevealedCount);
                const win = this.minesBet * mult;
                this.balance += win;
                this.updateBalance();
                this.playSound('win');
                this.showToast(`Cashed out ${win.toFixed(2)} coins! (${mult.toFixed(2)}x)`, 'success');
                this.recordWin(win - this.minesBet, 'Mines');
                this.endMines(true, -1);
                
                if (win - this.minesBet > 0) {
                    confetti({
                        particleCount: 150,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            }

            // BLACKJACK GAME - FIXED to prevent scaling
            renderBlackjack() {
                this.bjInProgress = false;
                this.bjSettled = false;
                this.bjStandCalled = false;
                this.bjDeck = [];
                this.bjPlayerHand = [];
                this.bjDealerHand = [];

                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto flex flex-col gap-6">
                        <div class="text-center mb-2">
                            <h2 class="text-2xl md:text-3xl font-bold text-white mb-2">Blackjack</h2>
                            <p class="text-gray-400">Beat the dealer without going over 21</p>
                        </div>
                        
                        <div class="blackjack-table">
                            <!-- Dealer Section -->
                            <div class="w-full mb-4 md:mb-8 flex-shrink-0">
                                <div class="flex items-center justify-center gap-3 mb-4">
                                    <i class="fa-solid fa-user-tie text-xl text-[#a7f3d0]"></i>
                                    <div class="text-[#a7f3d0] font-bold tracking-wider">Dealer</div>
                                    <div class="bg-black/40 px-4 py-2 rounded-full text-white font-bold text-lg" id="dealerScore">0</div>
                                </div>
                                <div id="dealerHand" class="hand-container"></div>
                            </div>
                            
                            <!-- Game Status -->
                            <div id="bjStatus" class="text-center my-4 flex-shrink-0">
                                <div class="status-text text-white" id="bjGameStatus">Place your bet and deal!</div>
                            </div>
                            
                            <!-- Player Section -->
                            <div class="w-full mt-4 md:mt-8 flex-shrink-0">
                                <div id="playerHand" class="hand-container mb-4"></div>
                                <div class="flex items-center justify-center gap-3">
                                    <i class="fa-solid fa-user text-xl text-[#a7f3d0]"></i>
                                    <div class="text-[#a7f3d0] font-bold tracking-wider">You</div>
                                    <div class="bg-black/40 px-4 py-2 rounded-full text-white font-bold text-lg" id="playerScore">0</div>
                                </div>
                            </div>
                            
                            <!-- Game Overlay -->
                            <div id="bjOverlay" class="absolute inset-0 bg-black/80 backdrop-blur-sm hidden z-20 flex-col items-center justify-center rounded-2xl">
                                <div id="bjMessage" class="text-2xl md:text-3xl font-black text-white mb-4 text-center"></div>
                                <div id="bjPayout" class="text-lg md:text-xl font-bold text-yellow-300 mb-6"></div>
                                <button onclick="app.resetBlackjackUI()" class="px-6 md:px-8 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white text-lg rounded-2xl font-bold shadow-2xl hover:scale-110 transition-all duration-300">
                                    <i class="fa-solid fa-rotate-right mr-3"></i> Play Again
                                </button>
                            </div>
                        </div>
                        
                        <!-- Game Controls -->
                        <div class="game-controls">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                                <div class="flex items-center gap-4 bg-gradient-to-r from-[#0b0e14] to-[#1e293b] px-4 md:px-6 py-3 rounded-2xl border border-[#2a3042]">
                                    <span class="text-gray-400 font-bold text-sm tracking-wider">BET</span>
                                    <input type="number" id="bjBetInput" value="50" min="1" max="${this.balance}" class="bg-transparent text-white font-bold text-xl w-20 md:w-28 outline-none text-center">
                                    <div class="flex gap-2">
                                        <button onclick="app.adjustBjBet(0.5)" class="text-xs text-[#8b5cf6] font-bold hover:text-white transition-all duration-300 hover:scale-110">Â½</button>
                                        <button onclick="app.adjustBjBet(2)" class="text-xs text-[#8b5cf6] font-bold hover:text-white transition-all duration-300 hover:scale-110">2x</button>
                                    </div>
                                </div>
                                
                                <div class="flex gap-3">
                                    <button id="btnDeal" onclick="app.bjDeal()" class="px-6 md:px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-black text-lg rounded-2xl shadow-2xl hover:scale-105 transition-all duration-300">
                                        <i class="fa-solid fa-play mr-3"></i> DEAL CARDS
                                    </button>
                                    <div id="bjActions" class="hidden flex gap-3">
                                        <button id="btnHit" onclick="app.bjHit()" class="px-4 md:px-6 py-3 bg-gradient-to-r from-gray-700 to-gray-800 text-white font-bold text-lg rounded-2xl shadow-lg hover:scale-105 transition-all duration-300">
                                            <i class="fa-solid fa-plus mr-2"></i> HIT
                                        </button>
                                        <button id="btnStand" onclick="app.bjStand()" class="px-4 md:px-6 py-3 bg-gradient-to-r from-emerald-600 to-green-700 text-white font-black text-lg rounded-2xl shadow-lg hover:scale-105 transition-all duration-300">
                                            <i class="fa-solid fa-hand mr-2"></i> STAND
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            adjustBjBet(multiplier) {
                const betInput = document.getElementById('bjBetInput');
                const currentBet = parseFloat(betInput.value) || 50;
                let newBet = currentBet * multiplier;
                newBet = Math.round(newBet);
                newBet = Math.max(1, Math.min(newBet, this.balance));
                betInput.value = newBet;
                this.playSound('click');
            }

            bjDeal() {
                if (!this.userId) {
                    this.showToast('Please login to play', 'error');
                    return;
                }

                if (this.bjInProgress) return;

                const betInput = document.getElementById('bjBetInput');
                const bet = parseFloat(betInput.value);

                if (isNaN(bet) || bet <= 0) {
                    this.showToast('Please enter a valid bet', 'error');
                    return;
                }

                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                this.playSound('click');
                this.balance -= bet;
                this.updateBalance();
                this.recordWager(bet);
                this.bjBet = bet;

                // Create and shuffle deck
                const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
                const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                let deck = [];

                for (let s of suits) {
                    for (let v of values) {
                        deck.push({
                            suit: s,
                            value: v,
                            color: (s === 'â™¥' || s === 'â™¦') ? 'text-red-500' : 'text-black'
                        });
                    }
                }

                // Shuffle deck
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }

                this.bjDeck = deck;
                this.bjPlayerHand = [];
                this.bjDealerHand = [];

                // Clear hands
                document.getElementById('dealerHand').innerHTML = '';
                document.getElementById('playerHand').innerHTML = '';
                document.getElementById('dealerScore').textContent = '0';
                document.getElementById('playerScore').textContent = '0';
                document.getElementById('bjGameStatus').textContent = 'Game in progress...';

                // Update UI
                document.getElementById('btnDeal').classList.add('hidden');
                document.getElementById('bjActions').classList.remove('hidden');
                document.getElementById('bjActions').classList.add('flex');
                betInput.disabled = true;

                this.bjInProgress = true;
                this.bjSettled = false;
                this.bjStandCalled = false;

                // Deal initial cards with animation delays
                setTimeout(() => {
                    this.bjDealCardToPlayer();
                    this.playSound('card');
                }, 0);

                setTimeout(() => {
                    this.bjDealCardToDealer(true); // First dealer card face down
                    this.playSound('card');
                }, 400);

                setTimeout(() => {
                    this.bjDealCardToPlayer();
                    this.playSound('card');
                }, 800);

                setTimeout(() => {
                    this.bjDealCardToDealer(false); // Second dealer card face up
                    this.playSound('card');
                    
                    // Update scores after all cards are dealt
                    setTimeout(() => {
                        this.bjUpdateScores(true);
                        
                        // Check for blackjack
                        if (this.bjCalculateScore(this.bjPlayerHand) === 21) {
                            this.bjStand();
                        }
                    }, 300);
                }, 1200);
            }

            bjDealCardToPlayer(faceUp = true) {
                if (this.bjDeck.length === 0) return;
                
                const card = this.bjDeck.pop();
                this.bjPlayerHand.push(card);
                
                const handElement = document.getElementById('playerHand');
                const cardElement = this.createCardElement(card, faceUp);
                cardElement.style.animation = 'card-deal 0.5s ease-out forwards';
                handElement.appendChild(cardElement);
            }

            bjDealCardToDealer(faceDown = false) {
                if (this.bjDeck.length === 0) return;
                
                const card = this.bjDeck.pop();
                this.bjDealerHand.push(card);
                
                const handElement = document.getElementById('dealerHand');
                const cardElement = this.createCardElement(card, !faceDown);
                if (faceDown) {
                    cardElement.querySelector('.game-card-item').classList.add('flipped');
                    cardElement.id = 'dealerHiddenCard';
                }
                cardElement.style.animation = 'card-deal 0.5s ease-out forwards';
                handElement.appendChild(cardElement);
            }

            createCardElement(card, faceUp = true) {
                const container = document.createElement('div');
                container.className = 'card-container';
                
                const cardItem = document.createElement('div');
                cardItem.className = `game-card-item ${!faceUp ? 'flipped' : ''}`;
                
                const cardFace = document.createElement('div');
                cardFace.className = 'card-face';
                cardFace.innerHTML = `
                    <div class="text-lg font-bold leading-none ${card.color}">${card.value}<br><span class="text-sm">${card.suit}</span></div>
                    <div class="card-value ${card.color}">${card.suit}</div>
                    <div class="text-lg font-bold leading-none ${card.color} rotate-180">${card.value}<br><span class="text-sm">${card.suit}</span></div>
                `;
                
                const cardBack = document.createElement('div');
                cardBack.className = 'card-back';
                
                cardItem.appendChild(cardFace);
                cardItem.appendChild(cardBack);
                container.appendChild(cardItem);
                
                return container;
            }

            bjCalculateScore(hand) {
                let score = 0;
                let aces = 0;

                hand.forEach(card => {
                    if (['J', 'Q', 'K'].includes(card.value)) {
                        score += 10;
                    } else if (card.value === 'A') {
                        score += 11;
                        aces++;
                    } else {
                        score += parseInt(card.value);
                    }
                });

                // Adjust for aces if over 21
                while (score > 21 && aces > 0) {
                    score -= 10;
                    aces--;
                }

                return score;
            }

            bjUpdateScores(hideDealerScore = false) {
                const playerScore = this.bjCalculateScore(this.bjPlayerHand);
                document.getElementById('playerScore').textContent = playerScore;

                if (hideDealerScore && this.bjDealerHand.length > 0) {
                    // Only show first card's value for dealer
                    const firstCard = this.bjDealerHand[0];
                    let dealerVisibleScore = 0;
                    
                    if (['J', 'Q', 'K'].includes(firstCard.value)) {
                        dealerVisibleScore = 10;
                    } else if (firstCard.value === 'A') {
                        dealerVisibleScore = 11;
                    } else {
                        dealerVisibleScore = parseInt(firstCard.value);
                    }
                    
                    document.getElementById('dealerScore').textContent = dealerVisibleScore;
                } else {
                    const dealerScore = this.bjCalculateScore(this.bjDealerHand);
                    document.getElementById('dealerScore').textContent = dealerScore;
                }
            }

            bjHit() {
                if (!this.bjInProgress || this.bjSettled || this.bjStandCalled) return;

                this.playSound('card');
                this.bjDealCardToPlayer();
                
                setTimeout(() => {
                    this.bjUpdateScores(true);
                    const playerScore = this.bjCalculateScore(this.bjPlayerHand);
                    
                    if (playerScore > 21) {
                        this.bjEnd('BUSTED', 'loss');
                    }
                }, 300);
            }

            bjStand() {
                if (!this.bjInProgress || this.bjSettled || this.bjStandCalled) return;

                this.bjStandCalled = true;
                document.getElementById('bjActions').classList.add('hidden');
                document.getElementById('bjActions').classList.remove('flex');

                // Reveal dealer's hidden card
                const hiddenCard = document.getElementById('dealerHiddenCard');
                if (hiddenCard) {
                    setTimeout(() => {
                        hiddenCard.querySelector('.game-card-item').classList.remove('flipped');
                        this.playSound('card');
                        this.bjUpdateScores(false);
                        this.bjDealerPlay();
                    }, 500);
                }
            }

            bjDealerPlay() {
                const dealerScore = this.bjCalculateScore(this.bjDealerHand);
                
                if (dealerScore >= 17) {
                    setTimeout(() => {
                        this.bjDetermineWinner();
                    }, 1000);
                } else {
                    // Dealer hits
                    setTimeout(() => {
                        this.bjDealCardToDealer(false);
                        this.playSound('card');
                        
                        setTimeout(() => {
                            this.bjUpdateScores(false);
                            this.bjDealerPlay();
                        }, 500);
                    }, 1000);
                }
            }

            bjDetermineWinner() {
                const playerScore = this.bjCalculateScore(this.bjPlayerHand);
                const dealerScore = this.bjCalculateScore(this.bjDealerHand);

                if (playerScore > 21) {
                    this.bjEnd('BUSTED', 'loss');
                } else if (dealerScore > 21) {
                    this.bjEnd('DEALER BUSTED', 'win');
                } else if (playerScore > dealerScore) {
                    this.bjEnd('YOU WIN', 'win');
                } else if (playerScore < dealerScore) {
                    this.bjEnd('DEALER WINS', 'loss');
                } else {
                    this.bjEnd('PUSH', 'push');
                }
            }

            bjEnd(message, result) {
                this.bjSettled = true;
                this.bjInProgress = false;

                const overlay = document.getElementById('bjOverlay');
                const messageEl = document.getElementById('bjMessage');
                const payoutEl = document.getElementById('bjPayout');

                setTimeout(() => {
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                    
                    if (messageEl) {
                        messageEl.textContent = message;
                        
                        switch(result) {
                            case 'win':
                                messageEl.style.color = '#10b981';
                                break;
                            case 'loss':
                                messageEl.style.color = '#ef4444';
                                break;
                            case 'push':
                                messageEl.style.color = '#f59e0b';
                                break;
                        }
                    }

                    let winAmount = 0;
                    
                    switch(result) {
                        case 'win':
                            winAmount = this.bjBet * 2;
                            this.balance += winAmount;
                            this.updateBalance();
                            this.recordWin(this.bjBet, 'Blackjack');
                            if (payoutEl) {
                                payoutEl.textContent = `+${winAmount} coins`;
                                payoutEl.style.color = '#10b981';
                            }
                            this.playSound('win');
                            confetti({
                                particleCount: 150,
                                spread: 70,
                                origin: { y: 0.6 }
                            });
                            break;
                            
                        case 'push':
                            winAmount = this.bjBet;
                            this.balance += winAmount;
                            this.updateBalance();
                            if (payoutEl) {
                                payoutEl.textContent = 'Bet returned';
                                payoutEl.style.color = '#f59e0b';
                            }
                            break;
                            
                        case 'loss':
                            this.recordLoss(this.bjBet, 'Blackjack');
                            if (payoutEl) {
                                payoutEl.textContent = `-${this.bjBet} coins`;
                                payoutEl.style.color = '#ef4444';
                            }
                            this.playSound('lose');
                            break;
                    }

                    document.getElementById('bjGameStatus').textContent = message;
                }, 1000);
            }

            resetBlackjackUI() {
                const overlay = document.getElementById('bjOverlay');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');

                document.getElementById('dealerHand').innerHTML = '';
                document.getElementById('playerHand').innerHTML = '';
                document.getElementById('dealerScore').textContent = '0';
                document.getElementById('playerScore').textContent = '0';
                document.getElementById('bjGameStatus').textContent = 'Place your bet and deal!';

                document.getElementById('btnDeal').classList.remove('hidden');
                document.getElementById('bjActions').classList.add('hidden');
                document.getElementById('bjActions').classList.remove('flex');

                const betInput = document.getElementById('bjBetInput');
                betInput.disabled = false;

                this.bjInProgress = false;
                this.bjSettled = false;
                this.bjStandCalled = false;
                this.playSound('click');
            }

            // ROCK PAPER SCISSORS GAME
            renderRPS() {
                if (!this.userId) {
                    this.mainContent.innerHTML = `
                        <div class="max-w-6xl mx-auto text-center py-12">
                            <i class="fa-solid fa-lock text-6xl text-red-500 mb-6"></i>
                            <h2 class="text-3xl font-bold text-white mb-4">Login Required</h2>
                            <p class="text-gray-400 mb-8">Please login to play Rock Paper Scissors</p>
                            <button onclick="app.showAuthModal()" class="btn-primary px-8 py-3 rounded-xl font-bold text-lg">
                                Login to Play
                            </button>
                        </div>
                    `;
                    return;
                }

                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">Rock Paper Scissors</h2>
                            <p class="text-gray-400">Multiplayer PvP - Challenge other players!</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left Panel: Game Lobby -->
                            <div class="lg:col-span-1">
                                <div class="bg-gradient-to-b from-[#161b26] to-[#11141c] p-6 rounded-3xl border border-[#2a3042] shadow-2xl">
                                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
                                        <i class="fa-solid fa-users"></i> Game Lobby
                                    </h3>
                                    
                                    <div class="mb-6">
                                        <label class="block text-gray-400 text-sm mb-2">Your Bet</label>
                                        <div class="flex bg-gradient-to-r from-[#0b0e14] to-[#1e293b] rounded-xl border border-[#2a3042] p-1">
                                            <div class="pl-4 py-3 text-[#8b5cf6] font-bold"><i class="fa-solid fa-coins"></i></div>
                                            <input type="number" id="rpsBetInput" value="50" min="10" max="${this.balance}" class="w-full bg-transparent text-white px-4 font-bold text-lg outline-none">
                                            <div class="flex pr-2">
                                                <button onclick="app.adjustRPSBet(0.5)" class="px-4 text-sm font-bold text-[#8b5cf6] hover:text-white transition-all duration-300">Â½</button>
                                                <button onclick="app.adjustRPSBet(2)" class="px-4 text-sm font-bold text-[#8b5cf6] hover:text-white transition-all duration-300">2x</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button onclick="app.createRPSGame()" class="w-full btn-primary py-3 mb-4 rounded-xl font-bold text-lg tracking-wider transition-all duration-300">
                                        <i class="fa-solid fa-plus mr-2"></i> Create Game
                                    </button>
                                    
                                    <div class="mb-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-gray-400 text-sm font-bold">Active Games</span>
                                            <span class="text-[#8b5cf6] text-xs" id="refreshGamesBtn" onclick="app.loadRPSGames()" style="cursor: pointer;">
                                                <i class="fa-solid fa-rotate"></i> Refresh
                                            </span>
                                        </div>
                                        <div id="rpsGameList" class="space-y-3 max-h-[400px] overflow-y-auto">
                                            <div class="text-center py-8">
                                                <div class="loading-spinner mx-auto mb-4"></div>
                                                <p class="text-gray-400">Loading games...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Center Panel: Game Area -->
                            <div class="lg:col-span-2">
                                <div class="bg-gradient-to-b from-[#161b26] to-[#11141c] p-6 rounded-3xl border border-[#2a3042] shadow-2xl h-full">
                                    <div id="rpsGameArea">
                                        <div class="text-center py-12">
                                            <i class="fa-solid fa-hand-back-fist text-6xl text-[#8b5cf6] mb-6"></i>
                                            <h3 class="text-2xl font-bold text-white mb-4">Select or Create a Game</h3>
                                            <p class="text-gray-400">Choose a game from the lobby or create your own!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.loadRPSGames();
            }

            adjustRPSBet(multiplier) {
                const betInput = document.getElementById('rpsBetInput');
                const currentBet = parseFloat(betInput.value) || 50;
                let newBet = currentBet * multiplier;
                newBet = Math.round(newBet);
                newBet = Math.max(10, Math.min(newBet, this.balance));
                betInput.value = newBet;
                this.playSound('click');
            }

            async createRPSGame() {
                if (!this.userId) {
                    this.showToast('Please login to create a game', 'error');
                    return;
                }

                const betInput = document.getElementById('rpsBetInput');
                const bet = parseFloat(betInput.value);

                if (isNaN(bet) || bet < 10) {
                    this.showToast('Minimum bet is 10 coins', 'error');
                    return;
                }

                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                // Deduct bet
                this.balance -= bet;
                this.updateBalance();

                const gameId = 'rps_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const gameData = {
                    id: gameId,
                    creator: {
                        userId: this.userId,
                        username: this.username,
                        choice: null,
                        ready: false
                    },
                    opponent: null,
                    bet: bet,
                    status: 'waiting',
                    winner: null,
                    createdAt: Date.now(),
                    lastActivity: Date.now()
                };

                await database.ref('rpsGames/' + gameId).set(gameData);
                
                this.rpsGameId = gameId;
                this.rpsBet = bet;
                this.rpsChoice = null;
                
                this.showToast(`Game created with ${bet} coin bet!`, 'success');
                this.playSound('click');
                
                // Join the game
                this.joinRPSGame(gameId);
                
                // Load updated game list
                this.loadRPSGames();
            }

            async loadRPSGames() {
                const snapshot = await database.ref('rpsGames')
                    .orderByChild('lastActivity')
                    .limitToLast(20)
                    .once('value');
                
                const games = [];
                snapshot.forEach(child => {
                    const game = child.val();
                    if (game.status === 'waiting' && game.creator.userId !== this.userId) {
                        games.push(game);
                    }
                });

                const gameList = document.getElementById('rpsGameList');
                if (!gameList) return;

                if (games.length === 0) {
                    gameList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fa-solid fa-gamepad text-4xl text-gray-600 mb-4"></i>
                            <p class="text-gray-400">No active games found</p>
                        </div>
                    `;
                    return;
                }

                gameList.innerHTML = games.map(game => `
                    <div class="game-lobby-item" onclick="app.joinRPSGame('${game.id}')">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-white font-bold">${game.creator.username}</div>
                                <div class="text-gray-400 text-xs">Bet: ${game.bet} coins</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[#10b981] font-bold">${game.bet} coins</div>
                                <div class="text-gray-400 text-xs">Click to join</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async joinRPSGame(gameId) {
                if (!this.userId) {
                    this.showToast('Please login to join a game', 'error');
                    return;
                }

                const gameRef = database.ref('rpsGames/' + gameId);
                const snapshot = await gameRef.once('value');
                const game = snapshot.val();

                if (!game) {
                    this.showToast('Game not found', 'error');
                    return;
                }

                if (game.status !== 'waiting') {
                    this.showToast('Game is no longer available', 'error');
                    return;
                }

                if (game.creator.userId === this.userId) {
                    // User is creator, just load the game
                    this.rpsGameId = gameId;
                    this.rpsBet = game.bet;
                    this.renderRPSGame(game);
                    this.listenToRPSGame(gameId);
                    return;
                }

                // Check if opponent slot is available
                if (game.opponent) {
                    this.showToast('Game is full', 'error');
                    return;
                }

                const betInput = document.getElementById('rpsBetInput');
                const bet = parseFloat(betInput.value);

                if (bet !== game.bet) {
                    this.showToast(`Bet must be exactly ${game.bet} coins`, 'error');
                    return;
                }

                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                // Deduct bet
                this.balance -= bet;
                this.updateBalance();

                // Join as opponent
                await gameRef.update({
                    opponent: {
                        userId: this.userId,
                        username: this.username,
                        choice: null,
                        ready: false
                    },
                    status: 'active',
                    lastActivity: Date.now()
                });

                this.rpsGameId = gameId;
                this.rpsBet = bet;
                this.rpsChoice = null;
                
                this.showToast(`Joined ${game.creator.username}'s game!`, 'success');
                this.playSound('click');
                
                // Load the game
                this.renderRPSGame({...game, opponent: {
                    userId: this.userId,
                    username: this.username,
                    choice: null,
                    ready: false
                }, status: 'active'});
                
                this.listenToRPSGame(gameId);
                
                // Add chat message
                this.addChatMessage('System', 
                    `${this.username} joined ${game.creator.username}'s RPS game for ${bet} coins!`, 
                    'text-[#8b5cf6]', true);
            }

            async leaveRPSGame() {
                if (!this.rpsGameId) return;

                const gameRef = database.ref('rpsGames/' + this.rpsGameId);
                const snapshot = await gameRef.once('value');
                const game = snapshot.val();

                if (game) {
                    if (game.status === 'waiting' && game.creator.userId === this.userId) {
                        // Creator leaves waiting game - refund and delete
                        this.balance += game.bet;
                        this.updateBalance();
                        await gameRef.remove();
                        this.showToast('Game cancelled', 'warning');
                    } else if (game.status === 'active') {
                        // Player leaves active game
                        if (game.creator.userId === this.userId) {
                            // Creator leaves - opponent wins by default
                            if (game.opponent && game.opponent.userId) {
                                const opponentRef = database.ref('users/' + game.opponent.userId);
                                const opponentSnapshot = await opponentRef.once('value');
                                const opponent = opponentSnapshot.val();
                                
                                const winAmount = game.bet * 2;
                                await opponentRef.update({
                                    balance: (opponent.balance || 0) + winAmount,
                                    rpsWins: (opponent.rpsWins || 0) + 1
                                });
                                
                                // Record win for opponent
                                const transaction = {
                                    userId: game.opponent.userId,
                                    username: game.opponent.username,
                                    amount: winAmount,
                                    type: 'win',
                                    game: 'Rock Paper Scissors',
                                    timestamp: Date.now()
                                };
                                
                                await database.ref('transactions').push(transaction);
                                
                                this.addChatMessage('System',
                                    `${game.opponent.username} wins ${winAmount} coins by forfeit in RPS!`,
                                    'text-[#10b981]', true);
                            }
                        } else if (game.opponent.userId === this.userId) {
                            // Opponent leaves - creator wins by default
                            const creatorRef = database.ref('users/' + game.creator.userId);
                            const creatorSnapshot = await creatorRef.once('value');
                            const creator = creatorSnapshot.val();
                            
                            const winAmount = game.bet * 2;
                            await creatorRef.update({
                                balance: (creator.balance || 0) + winAmount,
                                rpsWins: (creator.rpsWins || 0) + 1
                            });
                            
                            // Record win for creator
                            const transaction = {
                                userId: game.creator.userId,
                                username: game.creator.username,
                                amount: winAmount,
                                type: 'win',
                                game: 'Rock Paper Scissors',
                                timestamp: Date.now()
                            };
                            
                            await database.ref('transactions').push(transaction);
                            
                            this.addChatMessage('System',
                                `${game.creator.username} wins ${winAmount} coins by forfeit in RPS!`,
                                'text-[#10b981]', true);
                        }
                        
                        await gameRef.remove();
                        this.showToast('Left game', 'warning');
                    }
                }

                this.rpsGameId = null;
                this.rpsChoice = null;
                this.rpsBet = 0;
                
                // Reload RPS page
                this.loadGame('rps');
            }

            renderRPSGame(game) {
                const gameArea = document.getElementById('rpsGameArea');
                if (!gameArea) return;

                const isCreator = game.creator.userId === this.userId;
                const opponent = isCreator ? game.opponent : game.creator;
                const myChoice = isCreator ? game.creator.choice : (game.opponent ? game.opponent.choice : null);
                const opponentChoice = opponent ? opponent.choice : null;
                const bothReady = (game.creator.ready && (!game.opponent || game.opponent.ready));

                let statusText = '';
                let statusColor = 'text-gray-400';
                
                if (game.status === 'waiting') {
                    statusText = 'Waiting for opponent...';
                    statusColor = 'text-yellow-400';
                } else if (game.status === 'active') {
                    if (!myChoice) {
                        statusText = 'Choose your move!';
                        statusColor = 'text-blue-400';
                    } else if (!opponentChoice) {
                        statusText = 'Waiting for opponent...';
                        statusColor = 'text-yellow-400';
                    } else {
                        statusText = 'Revealing results...';
                        statusColor = 'text-purple-400';
                    }
                } else if (game.status === 'finished') {
                    if (game.winner === this.userId) {
                        statusText = 'You won!';
                        statusColor = 'text-green-400';
                    } else if (game.winner === 'tie') {
                        statusText = "It's a tie!";
                        statusColor = 'text-yellow-400';
                    } else {
                        statusText = 'You lost!';
                        statusColor = 'text-red-400';
                    }
                }

                gameArea.innerHTML = `
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-white mb-2">Game vs ${opponent ? opponent.username : 'Waiting...'}</h3>
                        <div class="text-lg ${statusColor} font-bold mb-4">${statusText}</div>
                        <div class="bg-gradient-to-r from-[#1e293b] to-[#0f172a] rounded-xl p-4 inline-block border border-[#2a3042]">
                            <div class="text-white font-bold text-xl">Bet: ${game.bet} coins</div>
                            <div class="text-gray-400 text-sm">Winner gets ${game.bet * 2} coins</div>
                        </div>
                    </div>
                    
                    <div class="rps-vs-container mb-8">
                        <div class="rps-player-choice">
                            ${myChoice ? `
                                <div class="rps-icon">
                                    <i class="fa-solid ${this.getRPSIcon(myChoice)}"></i>
                                </div>
                                <div class="text-white text-sm font-bold mt-2">${this.username}</div>
                            ` : `
                                <div class="text-gray-400">You</div>
                            `}
                        </div>
                        
                        <div class="rps-opponent-choice">
                            ${opponentChoice ? `
                                <div class="rps-icon">
                                    <i class="fa-solid ${this.getRPSIcon(opponentChoice)}"></i>
                                </div>
                                <div class="text-white text-sm font-bold mt-2">${opponent ? opponent.username : 'Opponent'}</div>
                            ` : opponent ? `
                                <div class="text-gray-400">${opponent.username}</div>
                            ` : `
                                <div class="text-gray-400">Waiting...</div>
                            `}
                        </div>
                        
                        <div class="rps-vs-text">VS</div>
                    </div>
                    
                    ${game.status === 'finished' ? `
                        <div class="rps-result ${game.winner === this.userId ? 'win' : game.winner === 'tie' ? 'tie' : 'loss'} mb-6">
                            ${game.winner === this.userId ? 'ðŸŽ‰ YOU WIN! ðŸŽ‰' : 
                              game.winner === 'tie' ? 'ðŸ¤ TIE GAME! ðŸ¤' : 'ðŸ˜¢ YOU LOSE! ðŸ˜¢'}
                            <div class="text-lg mt-2">${game.winner === this.userId ? `+${game.bet * 2} coins` : 
                                game.winner === 'tie' ? 'Bet returned' : `-${game.bet} coins`}</div>
                        </div>
                        
                        <button onclick="app.leaveRPSGame()" class="w-full btn-primary py-3 rounded-xl font-bold text-lg">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Back to Lobby
                        </button>
                    ` : `
                        <div class="flex justify-center gap-6 mb-8">
                            ${['rock', 'paper', 'scissors'].map(choice => `
                                <div onclick="app.selectRPSChoice('${choice}')" 
                                     class="rps-choice ${choice} ${myChoice === choice ? 'selected' : ''} ${myChoice ? 'disabled' : ''}">
                                    <div class="rps-icon">
                                        <i class="fa-solid ${this.getRPSIcon(choice)}"></i>
                                    </div>
                                    <div class="text-white text-sm font-bold mt-2">
                                        ${choice.charAt(0).toUpperCase() + choice.slice(1)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${myChoice && !game.creator.ready && isCreator ? `
                            <button onclick="app.confirmRPSChoice()" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-3 rounded-xl font-bold text-lg transition-all duration-300">
                                <i class="fa-solid fa-check mr-2"></i> Confirm Choice
                            </button>
                        ` : myChoice && game.opponent && !game.opponent.ready && !isCreator ? `
                            <button onclick="app.confirmRPSChoice()" class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white py-3 rounded-xl font-bold text-lg transition-all duration-300">
                                <i class="fa-solid fa-check mr-2"></i> Confirm Choice
                            </button>
                        ` : ''}
                        
                        ${bothReady && game.status === 'active' ? `
                            <div class="countdown-timer text-center mb-6" id="rpsCountdown">3</div>
                        ` : ''}
                        
                        <button onclick="app.leaveRPSGame()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white py-3 rounded-xl font-bold text-lg mt-4 transition-all duration-300">
                            <i class="fa-solid fa-sign-out mr-2"></i> Leave Game
                        </button>
                    `}
                `;

                // Start countdown if both are ready
                if (bothReady && game.status === 'active') {
                    this.startRPSCountdown();
                }
            }

            getRPSIcon(choice) {
                switch(choice) {
                    case 'rock': return 'fa-hand-back-fist';
                    case 'paper': return 'fa-hand';
                    case 'scissors': return 'fa-hand-scissors';
                    default: return 'fa-question';
                }
            }

            selectRPSChoice(choice) {
                if (!this.rpsGameId || this.rpsChoice) return;
                
                this.rpsChoice = choice;
                this.playSound('click');
                
                // Update UI
                const gameArea = document.getElementById('rpsGameArea');
                if (gameArea) {
                    document.querySelectorAll('.rps-choice').forEach(el => {
                        el.classList.remove('selected');
                        if (el.classList.contains(choice)) {
                            el.classList.add('selected');
                        }
                    });
                }
            }

            async confirmRPSChoice() {
                if (!this.rpsGameId || !this.rpsChoice) {
                    this.showToast('Please select a choice first', 'error');
                    return;
                }

                const gameRef = database.ref('rpsGames/' + this.rpsGameId);
                const snapshot = await gameRef.once('value');
                const game = snapshot.val();

                if (!game) {
                    this.showToast('Game not found', 'error');
                    return;
                }

                const isCreator = game.creator.userId === this.userId;
                const updatePath = isCreator ? 'creator' : 'opponent';

                await gameRef.update({
                    [updatePath + '.choice']: this.rpsChoice,
                    [updatePath + '.ready']: true,
                    lastActivity: Date.now()
                });

                this.showToast('Choice confirmed!', 'success');
                this.playSound('click');
            }

            startRPSCountdown() {
                let countdown = 3;
                const countdownElement = document.getElementById('rpsCountdown');
                
                if (!countdownElement) return;

                const countdownInterval = setInterval(() => {
                    countdownElement.textContent = countdown;
                    countdown--;
                    
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        this.revealRPSResults();
                    }
                }, 1000);
            }

            async revealRPSResults() {
                if (!this.rpsGameId) return;

                const gameRef = database.ref('rpsGames/' + this.rpsGameId);
                const snapshot = await gameRef.once('value');
                const game = snapshot.val();

                if (!game || !game.creator.choice || !game.opponent || !game.opponent.choice) {
                    return;
                }

                const creatorChoice = game.creator.choice;
                const opponentChoice = game.opponent.choice;
                
                let winner = null;
                
                // Determine winner
                if (creatorChoice === opponentChoice) {
                    winner = 'tie';
                } else if (
                    (creatorChoice === 'rock' && opponentChoice === 'scissors') ||
                    (creatorChoice === 'paper' && opponentChoice === 'rock') ||
                    (creatorChoice === 'scissors' && opponentChoice === 'paper')
                ) {
                    winner = game.creator.userId;
                } else {
                    winner = game.opponent.userId;
                }

                // Update game status
                await gameRef.update({
                    status: 'finished',
                    winner: winner,
                    lastActivity: Date.now()
                });

                // Handle payouts
                if (winner === 'tie') {
                    // Return bets to both players
                    const creatorRef = database.ref('users/' + game.creator.userId);
                    const opponentRef = database.ref('users/' + game.opponent.userId);
                    
                    const creatorSnapshot = await creatorRef.once('value');
                    const opponentSnapshot = await opponentRef.once('value');
                    
                    const creator = creatorSnapshot.val();
                    const opponent = opponentSnapshot.val();
                    
                    await creatorRef.update({
                        balance: (creator.balance || 0) + game.bet,
                        rpsTies: (creator.rpsTies || 0) + 1
                    });
                    
                    await opponentRef.update({
                        balance: (opponent.balance || 0) + game.bet,
                        rpsTies: (opponent.rpsTies || 0) + 1
                    });
                    
                    // Add chat message
                    this.addChatMessage('System',
                        `${game.creator.username} vs ${game.opponent.username}: Tie game in RPS!`,
                        'text-yellow-400', true);
                        
                } else {
                    const winnerId = winner;
                    const loserId = winner === game.creator.userId ? game.opponent.userId : game.creator.userId;
                    const winnerUsername = winner === game.creator.userId ? game.creator.username : game.opponent.username;
                    const loserUsername = winner === game.creator.userId ? game.opponent.username : game.creator.username;
                    
                    const winAmount = game.bet * 2;
                    
                    // Update winner's balance
                    const winnerRef = database.ref('users/' + winnerId);
                    const winnerSnapshot = await winnerRef.once('value');
                    const winnerUser = winnerSnapshot.val();
                    
                    await winnerRef.update({
                        balance: (winnerUser.balance || 0) + winAmount,
                        rpsWins: (winnerUser.rpsWins || 0) + 1
                    });
                    
                    // Update loser's stats
                    const loserRef = database.ref('users/' + loserId);
                    await loserRef.update({
                        rpsLosses: (game.loser?.rpsLosses || 0) + 1
                    });
                    
                    // Record transaction
                    const transaction = {
                        userId: winnerId,
                        username: winnerUsername,
                        amount: winAmount,
                        type: 'win',
                        game: 'Rock Paper Scissors',
                        timestamp: Date.now()
                    };
                    
                    await database.ref('transactions').push(transaction);
                    
                    // Update local balance if user is winner
                    if (winnerId === this.userId) {
                        this.balance += winAmount;
                        this.updateBalance();
                        this.playSound('win');
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    } else {
                        this.playSound('lose');
                    }
                    
                    // Add chat message
                    this.addChatMessage('System',
                        `${winnerUsername} defeated ${loserUsername} and won ${winAmount} coins in RPS!`,
                        'text-[#10b981]', true);
                }

                // Clean up game after 30 seconds
                setTimeout(async () => {
                    await gameRef.remove();
                }, 30000);
            }

            listenToRPSGame(gameId) {
                database.ref('rpsGames/' + gameId).on('value', (snapshot) => {
                    const game = snapshot.val();
                    if (game) {
                        this.renderRPSGame(game);
                    } else {
                        // Game was deleted
                        this.rpsGameId = null;
                        this.rpsChoice = null;
                        this.rpsBet = 0;
                        this.loadGame('rps');
                    }
                });
            }

            // LEADERBOARD
            async renderLeaderboard() {
                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Leaderboard</h2>
                            <p class="text-gray-400">Richest Players</p>
                        </div>
                        
                        <div id="leaderboardContent" class="space-y-4">
                            <div class="text-center py-12">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-400">Loading leaderboard...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                await this.loadLeaderboard();
            }

            async loadLeaderboard() {
                const snapshot = await database.ref('users').once('value');
                const users = [];

                snapshot.forEach(child => {
                    const user = child.val();
                    if (user.username && !user.banned) { // Only include users with usernames and not banned
                        users.push({
                            username: user.username,
                            balance: user.balance || 0,
                            userId: user.userId,
                            rpsWins: user.rpsWins || 0,
                            rpsLosses: user.rpsLosses || 0,
                            rpsTies: user.rpsTies || 0
                        });
                    }
                });

                // Sort by balance
                users.sort((a, b) => b.balance - a.balance);

                // Display leaderboard
                const leaderboardContent = document.getElementById('leaderboardContent');
                leaderboardContent.innerHTML = '';

                // Add header
                const header = document.createElement('div');
                header.className = 'flex items-center gap-3 mb-6';
                header.innerHTML = `
                    <i class="fa-solid fa-crown text-2xl text-yellow-400"></i>
                    <h3 class="text-2xl font-bold text-white">Richest Players</h3>
                `;
                leaderboardContent.appendChild(header);

                // Add top users
                const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                
                users.slice(0, 20).forEach((user, index) => {
                    const medal = medals[index] || `${index + 1}.`;
                    
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    div.style.animationDelay = `${index * 0.1}s`;
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-4 w-full">
                            <div class="text-2xl font-bold w-10">${medal}</div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-lg">${user.username}</div>
                                <div class="text-gray-400 text-sm">
                                    RPS: ${user.rpsWins || 0}W ${user.rpsLosses || 0}L ${user.rpsTies || 0}T
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-green-400">${user.balance.toLocaleString()} coins</div>
                                <div class="text-gray-400 text-xs mt-1">Balance</div>
                            </div>
                        </div>
                    `;
                    
                    // Highlight current user
                    if (user.userId === this.userId) {
                        div.style.borderColor = '#8b5cf6';
                        div.style.background = 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(139, 92, 246, 0.05))';
                        div.innerHTML += '<div class="absolute top-2 right-2 text-xs bg-[#8b5cf6] text-white px-2 py-1 rounded-full">YOU</div>';
                    }
                    
                    leaderboardContent.appendChild(div);
                });

                if (users.length === 0) {
                    leaderboardContent.innerHTML = '<div class="text-center py-12 text-gray-400">No data available</div>';
                }
            }

            // ADMIN PANEL
            async renderAdminPanel() {
                if (!this.isAdmin) {
                    this.mainContent.innerHTML = `
                        <div class="max-w-6xl mx-auto text-center py-12">
                            <i class="fa-solid fa-lock text-6xl text-red-500 mb-6"></i>
                            <h2 class="text-3xl font-bold text-white mb-4">Access Denied</h2>
                            <p class="text-gray-400">You must be an administrator to access this page.</p>
                        </div>
                    `;
                    return;
                }

                this.mainContent.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">Admin Panel</h2>
                            <p class="text-gray-400">Manage users, balances, and site features</p>
                        </div>
                        
                        <!-- Rain System -->
                        <div class="admin-card">
                            <h3><i class="fa-solid fa-cloud-rain"></i> Rain System</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-400 text-sm mb-2">Rain Amount</label>
                                    <input type="number" id="rainAmountInput" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3 text-white focus:outline-none focus:border-blue-500 transition-all duration-300" placeholder="Amount in coins">
                                </div>
                                <div>
                                    <label class="block text-gray-400 text-sm mb-2">Duration (minutes)</label>
                                    <input type="number" id="rainDuration" value="10" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3 text-white focus:outline-none focus:border-blue-500 transition-all duration-300">
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="app.startRain()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-xl font-bold transition-all duration-300">
                                        Start Rain
                                    </button>
                                    <button onclick="app.stopRain()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-3 rounded-xl font-bold transition-all duration-300">
                                        Stop Rain
                                    </button>
                                </div>
                                <div id="rainStatus" class="text-gray-400 text-sm">
                                    No active rain
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Management -->
                        <div class="admin-card">
                            <h3><i class="fa-solid fa-users"></i> User Management</h3>
                            <div class="space-y-4">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <div class="flex-1">
                                        <label class="block text-gray-400 text-sm mb-2">Search User (Username or ID)</label>
                                        <input type="text" id="searchUser" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3 text-white focus:outline-none focus:border-purple-500 transition-all duration-300" placeholder="Enter username or user ID">
                                    </div>
                                    <button onclick="app.searchAdminUser()" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-3 rounded-xl font-bold self-end transition-all duration-300">
                                        Search
                                    </button>
                                </div>
                                <div id="userSearchResults" class="space-y-3"></div>
                            </div>
                        </div>
                        
                        <!-- Balance Management -->
                        <div class="admin-card">
                            <h3><i class="fa-solid fa-money-bill-wave"></i> Balance Management</h3>
                            <div class="space-y-4" id="balanceManagement">
                                <div class="text-gray-400 text-sm">
                                    Search for a user first to manage their balance
                                </div>
                            </div>
                        </div>
                        
                        <!-- Site Stats -->
                        <div class="admin-card">
                            <h3><i class="fa-solid fa-chart-line"></i> Site Statistics</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="siteStats">
                                <div class="stats-card text-center">
                                    <div class="text-3xl font-bold text-white mb-2" id="totalUsers">0</div>
                                    <div class="text-gray-400 text-sm">Total Users</div>
                                </div>
                                <div class="stats-card text-center">
                                    <div class="text-3xl font-bold text-white mb-2" id="totalBalance">0</div>
                                    <div class="text-gray-400 text-sm">Total Balance</div>
                                </div>
                                <div class="stats-card text-center">
                                    <div class="text-3xl font-bold text-white mb-2" id="onlineUsers">0</div>
                                    <div class="text-gray-400 text-sm">Online Now</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                await this.loadAdminStats();
                this.checkRainStatus();
            }

            async loadAdminStats() {
                // Load total users
                const usersSnapshot = await database.ref('users').once('value');
                const totalUsers = usersSnapshot.numChildren();
                document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();

                // Calculate total balance
                let totalBalance = 0;
                usersSnapshot.forEach(child => {
                    const user = child.val();
                    totalBalance += user.balance || 0;
                });
                document.getElementById('totalBalance').textContent = totalBalance.toLocaleString() + ' coins';

                // Load online users
                const onlineSnapshot = await database.ref('online').once('value');
                const onlineUsers = onlineSnapshot.numChildren();
                document.getElementById('onlineUsers').textContent = onlineUsers.toLocaleString();
            }

            async checkRainStatus() {
                const rainSnapshot = await database.ref('rain').once('value');
                const rainData = rainSnapshot.val();
                
                const rainStatus = document.getElementById('rainStatus');
                if (rainStatus) {
                    if (rainData && rainData.active) {
                        const timeLeft = Math.max(0, rainData.endTime - Date.now());
                        const minutes = Math.floor(timeLeft / 60000);
                        const seconds = Math.floor((timeLeft % 60000) / 1000);
                        
                        rainStatus.innerHTML = `
                            <div class="text-green-400 font-bold">Rain Active!</div>
                            <div>Amount: ${rainData.amount.toLocaleString()} coins</div>
                            <div>Time left: ${minutes}:${seconds.toString().padStart(2, '0')}</div>
                            <div>Participants: ${rainData.participants ? Object.keys(rainData.participants).length : 0}</div>
                        `;
                    } else {
                        rainStatus.textContent = 'No active rain';
                    }
                }
            }

            async startRain() {
                const amount = parseFloat(document.getElementById('rainAmountInput').value);
                const duration = parseInt(document.getElementById('rainDuration').value);

                if (!amount || amount <= 0) {
                    this.showToast('Please enter a valid amount', 'error');
                    return;
                }

                if (!duration || duration <= 0) {
                    this.showToast('Please enter a valid duration', 'error');
                    return;
                }

                const rainData = {
                    active: true,
                    amount: amount,
                    startTime: Date.now(),
                    endTime: Date.now() + (duration * 60000),
                    participants: {},
                    createdBy: this.username
                };

                await database.ref('rain').set(rainData);
                
                this.showToast(`Started ${amount.toLocaleString()} coin rain for ${duration} minutes!`, 'success');
                this.playSound('win');
                
                // Add chat announcement
                this.addChatMessage('System', 
                    `ðŸŒ§ï¸ ADMIN RAIN STARTED! ${amount.toLocaleString()} coins up for grabs! Join now! ðŸŒ§ï¸`, 
                    'text-blue-400', true);
                
                // Update status
                this.checkRainStatus();
            }

            async stopRain() {
                const rainSnapshot = await database.ref('rain').once('value');
                const rainData = rainSnapshot.val();
                
                if (!rainData || !rainData.active) {
                    this.showToast('No active rain to stop', 'error');
                    return;
                }

                // Distribute funds to participants
                if (rainData.participants) {
                    const participantIds = Object.keys(rainData.participants);
                    const amountPerUser = rainData.amount / participantIds.length;
                    
                    if (participantIds.length > 0 && amountPerUser > 0) {
                        for (const userId of participantIds) {
                            const userRef = database.ref('users/' + userId);
                            const userSnapshot = await userRef.once('value');
                            const user = userSnapshot.val();
                            
                            if (user) {
                                const newBalance = (user.balance || 0) + amountPerUser;
                                await userRef.update({ balance: newBalance });
                            }
                        }
                        
                        // Add chat announcement
                        this.addChatMessage('System',
                            `ðŸŒ§ï¸ RAIN ENDED! ${participantIds.length} participants received ${amountPerUser.toFixed(2)} coins each! ðŸŒ§ï¸`,
                            'text-blue-400', true);
                    }
                }

                // Stop rain
                await database.ref('rain').remove();
                
                this.showToast('Rain stopped and distributed!', 'success');
                this.checkRainStatus();
            }

            async searchAdminUser() {
                const searchTerm = document.getElementById('searchUser').value.trim();
                if (!searchTerm) {
                    this.showToast('Please enter a search term', 'error');
                    return;
                }

                const usersSnapshot = await database.ref('users').once('value');
                const results = [];

                usersSnapshot.forEach(child => {
                    const user = child.val();
                    if (user.username && user.userId) {
                        if (user.username.toLowerCase().includes(searchTerm.toLowerCase()) || 
                            user.userId.includes(searchTerm)) {
                            results.push({
                                id: child.key,
                                ...user
                            });
                        }
                    }
                });

                const resultsDiv = document.getElementById('userSearchResults');
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="text-gray-400 text-center py-4">No users found</div>';
                    document.getElementById('balanceManagement').innerHTML = `
                        <div class="text-gray-400 text-sm">
                            Search for a user first to manage their balance
                        </div>
                    `;
                    return;
                }

                resultsDiv.innerHTML = results.map(user => `
                    <div class="bg-gradient-to-r from-[#1e293b] to-[#0f172a] border border-[#2a3042] rounded-xl p-4">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <div class="text-white font-bold">${user.username}</div>
                                <div class="text-gray-400 text-sm">ID: ${user.userId}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-green-400 font-bold">${user.balance || 0} coins</div>
                                <div class="text-gray-400 text-sm">${user.banned ? 'BANNED' : 'Active'}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.selectAdminUser('${user.id}', '${user.username}', ${user.balance || 0}, ${user.banned || false})" class="flex-1 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-2 rounded-lg text-sm font-bold transition-all duration-300">
                                Select
                            </button>
                            <button onclick="app.toggleBanUser('${user.id}', ${user.banned || false})" class="flex-1 bg-gradient-to-r ${user.banned ? 'from-green-500 to-green-600 hover:from-green-600 hover:to-green-700' : 'from-red-500 to-red-600 hover:from-red-600 hover:to-red-700'} text-white py-2 rounded-lg text-sm font-bold transition-all duration-300">
                                ${user.banned ? 'Unban' : 'Ban'}
                            </button>
                        </div>
                    </div>
                `).join('');

                // Select first user by default
                if (results.length > 0) {
                    const firstUser = results[0];
                    this.selectAdminUser(firstUser.id, firstUser.username, firstUser.balance || 0, firstUser.banned || false);
                }
            }

            selectAdminUser(userId, username, balance, banned) {
                document.getElementById('balanceManagement').innerHTML = `
                    <div class="mb-4">
                        <div class="text-white font-bold mb-2">Selected User: ${username}</div>
                        <div class="text-gray-400 text-sm">ID: ${userId}</div>
                        <div class="text-gray-400 text-sm">Status: ${banned ? '<span class="text-red-400">BANNED</span>' : '<span class="text-green-400">Active</span>'}</div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-400 text-sm mb-2">Set Balance</label>
                            <input type="number" id="setBalanceInput" value="${balance}" class="w-full bg-gradient-to-r from-[#0b0e14] to-[#1e293b] border border-[#2a3042] rounded-xl px-5 py-3 text-white focus:outline-none focus:border-green-500 transition-all duration-300">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="app.setUserBalance('${userId}', '${username}')" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-3 rounded-xl font-bold transition-all duration-300">
                                Set Balance
                            </button>
                            <button onclick="app.addUserBalance('${userId}', '${username}')" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 rounded-xl font-bold transition-all duration-300">
                                Add Balance
                            </button>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="app.resetUserPassword('${userId}', '${username}')" class="flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white py-3 rounded-xl font-bold transition-all duration-300">
                                Reset Password
                            </button>
                            <button onclick="app.makeAdmin('${userId}', '${username}')" class="flex-1 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white py-3 rounded-xl font-bold transition-all duration-300">
                                Make Admin
                            </button>
                        </div>
                    </div>
                `;
            }

            async setUserBalance(userId, username) {
                const newBalance = parseFloat(document.getElementById('setBalanceInput').value);
                
                if (isNaN(newBalance) || newBalance < 0) {
                    this.showToast('Invalid balance amount', 'error');
                    return;
                }

                await database.ref('users/' + userId + '/balance').set(newBalance);
                
                this.showToast(`Set ${username}'s balance to ${newBalance} coins`, 'success');
                this.playSound('click');
                
                // Update search results
                this.searchAdminUser();
            }

            async addUserBalance(userId, username) {
                const currentBalance = parseFloat(document.getElementById('setBalanceInput').value);
                const addAmount = parseFloat(prompt(`How many coins to add to ${username}?`, "1000"));
                
                if (isNaN(addAmount) || addAmount <= 0) {
                    this.showToast('Invalid amount', 'error');
                    return;
                }

                const newBalance = currentBalance + addAmount;
                await database.ref('users/' + userId + '/balance').set(newBalance);
                
                this.showToast(`Added ${addAmount} coins to ${username}`, 'success');
                this.playSound('click');
                
                // Update input
                document.getElementById('setBalanceInput').value = newBalance;
                this.searchAdminUser();
            }

            async toggleBanUser(userId, currentlyBanned) {
                const confirmAction = confirm(`Are you sure you want to ${currentlyBanned ? 'UNBAN' : 'BAN'} this user?`);
                
                if (!confirmAction) return;

                await database.ref('users/' + userId + '/banned').set(!currentlyBanned);
                
                this.showToast(`User ${currentlyBanned ? 'unbanned' : 'banned'} successfully`, 'success');
                this.playSound('click');
                
                // Update search results
                this.searchAdminUser();
            }

            async resetUserPassword(userId, username) {
                const newPassword = prompt(`Enter new password for ${username}:`, "password123");
                
                if (!newPassword || newPassword.length < 3) {
                    this.showToast('Password must be at least 3 characters', 'error');
                    return;
                }

                await database.ref('users/' + userId + '/password').set(btoa(newPassword));
                
                this.showToast(`Password reset for ${username}`, 'success');
                this.playSound('click');
            }

            async makeAdmin(userId, username) {
                const confirmAction = confirm(`Make ${username} an administrator?`);
                
                if (!confirmAction) return;

                await database.ref('users/' + userId + '/isAdmin').set(true);
                
                this.showToast(`${username} is now an administrator`, 'success');
                this.playSound('win');
                
                this.searchAdminUser();
            }
        }

        // Initialize the app
        const app = new GameApp();
    </script>
</body>
</html>
