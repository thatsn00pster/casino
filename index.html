<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moon Casino - Premium Fun Casino</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        :root {
            --primary: #00e701;
            --secondary: #1475e1;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #0f212e;
            --bg-panel: #1a2c38;
            --border: #2f4553;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #0f212e;
            color: #b1bad3;
            overflow-x: hidden;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- ANIMATIONS --- */
        @keyframes hop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        .chicken-hop { animation: hop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 2px); }
            20%, 40%, 60%, 80% { transform: translate(5px, -2px); }
        }
        .shake-screen { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        /* Crash Car: Comes from TOP to BOTTOM */
        @keyframes crashDriveVertical {
            0% { transform: translate(-50%, -200px); opacity: 1; }
            50% { transform: translate(-50%, 0%); } /* Impact point */
            100% { transform: translate(-50%, 100vh); opacity: 1; }
        }
        .crash-car-anim {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            animation: crashDriveVertical 0.6s cubic-bezier(0.5, 0, 0.5, 1) forwards;
        }

        /* Continuous Traffic in Lanes */
        @keyframes trafficFlow {
            0% { transform: translate(-50%, -150px); }
            100% { transform: translate(-50%, 120vh); }
        }
        .traffic-car {
            position: absolute;
            left: 50%;
            top: 0;
            transform: translate(-50%, -150px); /* Start off screen */
            animation: trafficFlow linear infinite;
            z-index: 5;
            will-change: transform;
        }

        /* --- CSS DRAWN CARS --- */
        .car-model {
            width: 44px;
            height: 80px;
            border-radius: 12px;
            position: relative;
            box-shadow: 4px 8px 12px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        /* Headlights */
        .car-model::before {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 4px;
            width: 8px;
            height: 4px;
            background: #fff;
            box-shadow: 0 0 5px #fff;
            border-radius: 2px;
            z-index: 2;
        }
        .car-model::after {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 8px;
            height: 4px;
            background: #fff;
            box-shadow: 0 0 5px #fff;
            border-radius: 2px;
            z-index: 2;
        }
        
        .car-roof {
            position: absolute;
            top: 18px;
            left: 6px;
            right: 6px;
            bottom: 20px;
            background: rgba(0,0,0,0.25);
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .car-windshield {
            position: absolute;
            bottom: 18px;
            left: 8px;
            right: 8px;
            height: 14px;
            background: linear-gradient(to bottom, #aed6f1, #3498db);
            border-radius: 2px 2px 8px 8px;
            opacity: 0.9;
        }
        .car-rear-window {
            position: absolute;
            top: 18px;
            left: 8px;
            right: 8px;
            height: 10px;
            background: #2c3e50;
            border-radius: 6px 6px 2px 2px;
        }

        /* Car Colors */
        .car-red { background: linear-gradient(to bottom, #c0392b, #e74c3c); }
        .car-blue { background: linear-gradient(to bottom, #2980b9, #3498db); }
        .car-yellow { background: linear-gradient(to bottom, #f39c12, #f1c40f); }
        .car-white { background: linear-gradient(to bottom, #bdc3c7, #ecf0f1); }
        .car-black { background: linear-gradient(to bottom, #2c3e50, #34495e); }
        .car-green { background: linear-gradient(to bottom, #27ae60, #2ecc71); }

        /* --- STYLES --- */
        .lane-card {
            transition: transform 0.2s, filter 0.2s;
            box-shadow: inset 10px 0 20px -10px rgba(0,0,0,0.5), inset -10px 0 20px -10px rgba(0,0,0,0.5);
        }
        .lane-card:hover:not(.disabled) {
            filter: brightness(1.1) contrast(1.1);
            z-index: 10;
        }
        
        .sidewalk-texture {
            background-color: #95a5a6;
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
        }

        /* --- ENVIRONMENT TEXTURES --- */
        .grass-texture {
            background-color: #4caf50;
            background-image: 
                radial-gradient(#66bb6a 15%, transparent 16%),
                radial-gradient(#81c784 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.2);
        }

        .pond {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            border-radius: 50% 70% 50% 40%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2), 0 4px 0 rgba(0,0,0,0.1);
            position: absolute;
            z-index: 1;
            overflow: hidden;
        }
        .pond::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 20%;
            height: 10%;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            transform: rotate(-45deg);
        }

        .road-texture {
            background-color: #2d3436; /* Dark Asphalt */
            background-image: 
                /* Noise */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.5), inset 0 -10px 20px rgba(0,0,0,0.5);
            position: relative;
        }
        /* Top and Bottom White Lines of the Road */
        .road-border-top {
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: #ecf0f1;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 5;
        }
        .road-border-bottom {
            position: absolute;
            bottom: 0; left: 0; right: 0; height: 6px;
            background: #ecf0f1;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 5;
        }

        .lane-separator {
            position: absolute;
            right: 0;
            top: 10%;
            bottom: 10%;
            width: 4px;
            background: repeating-linear-gradient(
                to bottom,
                #ecf0f1,
                #ecf0f1 40px,
                transparent 40px,
                transparent 80px
            );
            z-index: 5;
            opacity: 0.5;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(11, 14, 20, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #00e701, #1475e1);
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00c701, #0f64c1);
        }
        
        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #00e701 0%, #00c701 100%);
            color: #0f212e;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            border: none;
            position: relative;
            overflow: hidden;
            font-family: 'Fredoka', sans-serif;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 231, 1, 0.3);
        }
        
        /* Game Card */
        .game-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #1a2c38, #0f212e);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease-out;
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a2c38;
            border-radius: 16px;
            border: 1px solid #2f4553;
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.8);
            max-width: 100%;
            width: 420px;
            animation: scale-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; backdrop-filter: blur(0); }
            to { opacity: 1; backdrop-filter: blur(10px); }
        }
        
        @keyframes scale-in {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 20px;
            background: #1a2c38;
            border-radius: 12px;
            border: 1px solid #2f4553;
            color: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            transform: translateX(100px) scale(0.8);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: calc(100vw - 40px);
        }
        
        .toast.show {
            transform: translateX(0) scale(1);
            opacity: 1;
        }
        
        .toast.success {
            border-color: #00e701;
            background: linear-gradient(135deg, rgba(0, 231, 1, 0.15), #1a2c38);
        }
        
        .toast.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), #1a2c38);
        }
        
        .toast.warning {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), #1a2c38);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .modal {
                align-items: flex-start;
                padding-top: 40px;
            }
            
            .modal-content {
                margin-top: 0;
                max-height: 85vh;
            }
        }
        
        /* Chicken Road Container */
        .chicken-road-main {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
            background: #0f212e;
            font-family: 'Fredoka', sans-serif;
        }
        
        /* Top Stats Bar */
        .chicken-top-bar {
            height: 64px;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0f212e;
            border-bottom: 1px solid #2f4553;
            z-index: 10;
        }
        
        .chicken-game-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .chicken-stat-box {
            background: #1a2c38;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid #2f4553;
            min-width: 120px;
        }
        
        .chicken-stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #b1bad3;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .chicken-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin-top: 0.25rem;
        }
        
        .chicken-stat-value.multiplier {
            color: #00e701;
        }
        
        /* Main Game Area */
        .chicken-game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }
        
        /* Controls Sidebar */
        .chicken-controls-sidebar {
            width: 320px;
            background: #1a2c38;
            border-right: 1px solid #2f4553;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }
        
        .chicken-controls-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .chicken-controls-header .emoji {
            font-size: 2rem;
        }
        
        .chicken-controls-header h2 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .chicken-control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .chicken-control-label {
            font-size: 0.875rem;
            font-weight: 700;
            color: #b1bad3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .chicken-input-group {
            display: flex;
            background: #2f4553;
            border-radius: 8px;
            border: 1px solid #2f4553;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        
        .chicken-input-group:focus-within {
            border-color: #00e701;
        }
        
        .chicken-input-group input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 0.75rem 1rem;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Fredoka', sans-serif;
            outline: none;
        }
        
        .chicken-input-group .icon {
            padding: 0 1rem;
            display: flex;
            align-items: center;
            background: rgba(15, 33, 46, 0.3);
            color: #f59e0b;
        }
        
        .chicken-quick-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        
        .chicken-quick-button {
            background: #2f4553;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            color: #b1bad3;
            font-size: 0.875rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Fredoka', sans-serif;
        }
        
        .chicken-quick-button:hover {
            background: #3e5666;
            color: white;
        }
        
        .chicken-select {
            width: 100%;
            background: #2f4553;
            border: 1px solid #2f4553;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            font-family: 'Fredoka', sans-serif;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .chicken-select:focus {
            border-color: #00e701;
        }
        
        .chicken-stats-box {
            background: #1a2c38;
            border-radius: 8px;
            border: 1px solid #2f4553;
            padding: 1rem;
        }
        
        .chicken-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .chicken-main-action {
            margin-top: auto;
        }
        
        .chicken-action-button {
            width: 100%;
            background: linear-gradient(135deg, #00e701 0%, #00c701 100%);
            color: #0f212e;
            border: none;
            border-radius: 8px;
            padding: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Fredoka', sans-serif;
            box-shadow: 0 4px 0 #00b500;
        }
        
        .chicken-action-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #00b500;
        }
        
        .chicken-action-button:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #00b500;
        }
        
        .chicken-action-button:disabled {
            background: #2f4553;
            color: #b1bad3;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .chicken-game-info {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
            margin-top: 1rem;
        }
        
        /* Road Container */
        .chicken-road-container {
            flex: 1;
            position: relative;
            background: #1a2c38;
            overflow: hidden;
        }
        
        .chicken-road-inner {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Result Overlay */
        .chicken-result-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .chicken-result-overlay.active {
            display: flex;
            opacity: 1;
        }
        
        .chicken-result-content {
            background: linear-gradient(135deg, #1a2c38, #0f212e);
            border-radius: 20px;
            border: 1px solid #2f4553;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .chicken-result-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .chicken-result-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .chicken-result-title.win {
            color: #00e701;
            text-shadow: 0 0 10px rgba(0, 231, 1, 0.5);
        }
        
        .chicken-result-title.loss {
            color: #ef4444;
        }
        
        .chicken-result-subtitle {
            font-size: 1.25rem;
            color: #b1bad3;
            margin-bottom: 1.5rem;
        }
        
        .chicken-result-amount {
            font-size: 2rem;
            font-weight: 700;
            color: #00e701;
            margin-bottom: 2rem;
        }
        
        .glass-panel {
            background: rgba(15, 33, 46, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glow-text { text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        
        @media (max-width: 1024px) {
            .chicken-game-area {
                flex-direction: column;
            }
            
            .chicken-controls-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #2f4553;
            }
        }
        
        @media (max-width: 640px) {
            .chicken-top-bar {
                flex-direction: column;
                height: auto;
                padding: 1rem;
                gap: 1rem;
            }
            
            .chicken-game-stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .chicken-stat-box {
                min-width: auto;
                flex: 1;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Sound Toggle -->
    <div class="sound-toggle" id="soundToggle" onclick="app.toggleSound()">
        <i class="fa-solid fa-volume-high"></i>
    </div>

    <!-- Navbar -->
    <nav class="h-16 bg-[#1a2c38]/95 backdrop-blur-xl flex items-center justify-between px-4 md:px-6 shadow-2xl border-b border-[#2f4553] sticky top-0 z-40">
        <div class="flex items-center gap-3">
            <button class="text-gray-400 hover:text-white md:hidden transition-all duration-300 hover:scale-110 touch-button" onclick="app.toggleSidebar()">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div class="flex items-center gap-2 cursor-pointer group" onclick="app.loadGame('home')">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-[#00e701] to-[#00b500] flex items-center justify-center shadow-lg relative overflow-hidden">
                    <i class="fa-solid fa-moon text-white text-sm md:text-lg relative z-10"></i>
                    <div class="absolute inset-0 bg-white/10"></div>
                </div>
                <div class="text-xl md:text-2xl font-bold text-white tracking-tight truncate max-w-[150px] md:max-w-none">
                    Moon<span class="text-[#00e701]">Casino</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="hidden md:flex bg-gradient-to-r from-[#0f212e] to-[#1a2c38] rounded-full px-1 py-1 items-center gap-2 border border-[#2f4553] shadow-lg">
                <div class="bg-gradient-to-r from-[#1a2c38] to-[#0f212e] rounded-full px-3 py-2 flex items-center gap-2 min-w-[140px] justify-between cursor-pointer hover:from-[#2f4553] hover:to-[#1a2c38] transition-all duration-300 group" onclick="app.openDepositModal()">
                    <span class="text-[#00e701] text-xs font-bold tracking-wider">COINS</span>
                    <span class="text-white font-mono font-bold text-base tracking-wider truncate max-w-[80px]" id="balanceDisplay">500</span>
                    <i class="fa-solid fa-coins text-yellow-400 opacity-0 group-hover:opacity-100 transition-all duration-300 text-sm"></i>
                </div>
                <button onclick="app.openDepositModal()" class="bg-gradient-to-r from-[#00e701] to-[#00c701] hover:from-[#00c701] hover:to-[#00b500] text-[#0f212e] px-4 py-2 rounded-full text-xs font-bold shadow-lg shadow-green-900/30 transition-all duration-300 hover:scale-105">
                    <i class="fa-solid fa-wallet mr-1"></i> Wallet
                </button>
            </div>
            <button class="md:hidden text-white bg-gradient-to-r from-[#1a2c38] to-[#0f212e] p-2 rounded-lg border border-[#2f4553] shadow-lg hover:scale-110 transition-all duration-300 touch-button" onclick="app.openDepositModal()">
                <i class="fa-solid fa-wallet text-[#00e701] text-base"></i>
            </button>
            <button class="text-gray-400 hover:text-white ml-1 transition-all duration-300 hover:scale-110 touch-button" onclick="app.toggleChat()">
                <i class="fa-solid fa-message text-lg"></i>
            </button>
            <div class="w-8 h-8 md:w-9 md:h-9 rounded-full bg-gradient-to-r from-[#00e701] to-[#1475e1] flex items-center justify-center text-white font-bold text-sm border-2 border-[#1a2c38] shadow-lg hover:scale-110 transition-all duration-300 cursor-pointer touch-button" id="userAvatar">
                U
            </div>
            <button onclick="app.logout()" class="text-gray-400 hover:text-white ml-1 transition-all duration-300 hover:scale-110 touch-button">
                <i class="fa-solid fa-right-from-bracket text-sm md:text-base"></i>
            </button>
        </div>
    </nav>
    
    <!-- Layout -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="absolute md:relative inset-y-0 left-0 z-30 w-64 bg-[#1a2c38]/95 backdrop-blur-xl border-r border-[#2f4553] transform -translate-x-full md:translate-x-0 flex flex-col transition-transform duration-500 ease-out shadow-2xl md:shadow-none">
            <div class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
                <div class="text-xs font-bold text-[#00e701] mb-4 px-3 tracking-wider uppercase">Premium Games</div>
                <button onclick="app.loadGame('home')" id="nav-home" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gradient-to-r hover:from-[#2f4553] hover:to-[#1a2c38] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group touch-button">
                    <i class="fa-solid fa-house w-4 text-center group-hover:text-[#00e701] transition-all duration-300"></i> 
                    <span class="text-sm">Home</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <div class="h-px bg-gradient-to-r from-transparent via-[#2f4553] to-transparent my-2 mx-3"></div>
                <button onclick="app.loadGame('mines')" id="nav-mines" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gradient-to-r hover:from-[#2f4553] hover:to-[#1a2c38] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group touch-button">
                    <i class="fa-solid fa-bomb text-[#f59e0b] w-4 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span class="text-sm">Mines</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <button onclick="app.loadGame('blackjack')" id="nav-blackjack" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gradient-to-r hover:from-[#2f4553] hover:to-[#1a2c38] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group touch-button">
                    <i class="fa-solid fa-diamond text-[#00e701] w-4 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span class="text-sm">Blackjack</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <button onclick="app.loadGame('chicken')" id="nav-chicken" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gradient-to-r hover:from-[#2f4553] hover:to-[#1a2c38] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group touch-button">
                    <i class="fa-solid fa-egg text-[#f59e0b] w-4 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span class="text-sm">Chicken Road</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
                <button onclick="app.loadGame('leaderboard')" id="nav-leaderboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-gradient-to-r hover:from-[#2f4553] hover:to-[#1a2c38] text-[#b1bad3] hover:text-white font-medium transition-all duration-300 group touch-button">
                    <i class="fa-solid fa-trophy text-[#f59e0b] w-4 text-center group-hover:scale-110 transition-all duration-300"></i> 
                    <span class="text-sm">Leaderboard</span>
                    <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-all duration-300 ml-auto"></i>
                </button>
            </div>
            <div class="p-4 bg-gradient-to-t from-[#0f212e] to-transparent border-t border-[#2f4553]">
                <div class="flex justify-between text-xs text-[#6b7280] mb-2">
                    <span>Logged in as</span>
                    <span id="loggedUsername" class="text-[#00e701] font-bold truncate max-w-[120px]">Guest</span>
                </div>
                <div class="text-[10px] text-center text-[#555d70] font-mono bg-gradient-to-r from-[#0f212e] to-[#1a2c38] p-2 rounded border border-[#2f4553] truncate shadow-inner">
                    <span id="userIdDisplay">Not logged in</span>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main id="mainContent" class="flex-1 overflow-y-auto"></main>
        
        <!-- Chat -->
        <aside id="chatSidebar" class="hidden md:flex flex-col w-72 bg-[#1a2c38]/95 backdrop-blur-xl border-l border-[#2f4553] shadow-2xl">
            <div class="p-4 border-b border-[#2f4553] flex justify-between items-center bg-gradient-to-r from-[#0f212e] to-transparent">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-[#00e701] rounded-full animate-pulse"></div>
                    <span class="text-white font-bold text-sm tracking-wider">Global Chat</span>
                </div>
                <div class="text-xs text-[#6b7280] bg-[#0f212e] px-2 py-1 rounded-full border border-[#2f4553]" id="onlineCount">0 Online</div>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm bg-gradient-to-b from-[#0f212e]/50 to-transparent"></div>
            <div class="p-3 bg-gradient-to-t from-[#1a2c38] to-transparent border-t border-[#2f4553]">
                <form onsubmit="app.sendChatMessage(event)" class="relative">
                    <input type="text" id="chatInput" placeholder="Type a message..." class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] text-white pl-4 pr-10 py-3 rounded-xl border border-[#2f4553] text-sm focus:outline-none focus:border-[#00e701] transition-all duration-300">
                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 text-[#00e701] hover:text-white p-1.5 transition-all duration-300 hover:scale-110 touch-button">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </form>
            </div>
        </aside>
    </div>
    
    <!-- Auth Modal -->
    <div id="authModal" class="modal active">
        <div class="modal-content p-6">
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-[#00e701] to-[#00b500] flex items-center justify-center mx-auto mb-4 relative overflow-hidden">
                    <i class="fa-solid fa-moon text-white text-2xl relative z-10"></i>
                    <div class="absolute inset-0 bg-white/20"></div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Moon Casino</h2>
                <p class="text-[#6b7280] text-sm">Please login or sign up to play</p>
            </div>
            
            <div id="loginForm" class="space-y-4">
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-1 block tracking-wider">Email</label>
                    <input type="email" id="loginEmail" class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] border border-[#2f4553] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-[#00e701] transition-all duration-300 text-sm" placeholder="Enter your email">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-1 block tracking-wider">Password</label>
                    <input type="password" id="loginPassword" class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] border border-[#2f4553] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-[#00e701] transition-all duration-300 text-sm" placeholder="Enter your password">
                </div>
                <button onclick="app.login()" class="w-full btn-primary py-3 rounded-xl font-bold text-base tracking-wider touch-button">Login</button>
                <p class="text-center text-[#6b7280] text-xs">
                    Don't have an account? 
                    <button onclick="app.showSignup()" class="text-[#00e701] hover:text-[#00c701] transition-all duration-300 font-bold">Sign up</button>
                </p>
            </div>
            
            <div id="signupForm" class="space-y-4 hidden">
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-1 block tracking-wider">Username</label>
                    <input type="text" id="signupUsername" class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] border border-[#2f4553] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-[#00e701] transition-all duration-300 text-sm" placeholder="Choose a username">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-1 block tracking-wider">Email</label>
                    <input type="email" id="signupEmail" class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] border border-[#2f4553] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-[#00e701] transition-all duration-300 text-sm" placeholder="Enter your email">
                </div>
                <div>
                    <label class="text-xs text-[#6b7280] font-bold mb-1 block tracking-wider">Password</label>
                    <input type="password" id="signupPassword" class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] border border-[#2f4553] rounded-xl px-4 py-3 text-white focus:outline-none focus:border-[#00e701] transition-all duration-300 text-sm" placeholder="Create a password">
                </div>
                <button onclick="app.signup()" class="w-full btn-primary py-3 rounded-xl font-bold text-base tracking-wider touch-button">Sign Up</button>
                <p class="text-center text-[#6b7280] text-xs">
                    Already have an account? 
                    <button onclick="app.showLogin()" class="text-[#00e701] hover:text-[#00c701] transition-all duration-300 font-bold">Login</button>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Wallet Modal -->
    <div id="depositModal" class="modal">
        <div class="modal-content p-5">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">Wallet</h2>
                <button onclick="app.closeDepositModal()" class="text-[#6b7280] hover:text-white transition-all duration-300 hover:scale-110 touch-button">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            
            <div class="space-y-5">
                <!-- Balance Display -->
                <div class="bg-gradient-to-r from-[#1a2c38] to-[#0f212e] rounded-xl p-4 border border-[#2f4553] relative overflow-hidden wallet-section">
                    <div class="absolute top-0 right-0 w-24 h-24 bg-[#00e701] rounded-full -mr-12 -mt-12 opacity-10"></div>
                    <div class="relative z-10">
                        <div class="text-center">
                            <div class="text-gray-400 text-xs mb-1 tracking-wider">Your Balance</div>
                            <div class="text-white font-bold text-2xl mb-3" id="modalBalance">500</div>
                            <div class="text-gray-500 text-xs">Play games to earn more coins!</div>
                        </div>
                    </div>
                </div>
                
                <!-- Free Coins Section -->
                <div class="text-center wallet-section">
                    <i class="fa-solid fa-gift text-[#00e701] text-3xl mb-2"></i>
                    <h3 class="text-white font-bold text-base mb-1">Free Coins</h3>
                    <p class="text-[#6b7280] text-xs mb-4">Claim 500 free coins whenever your balance is under 100</p>
                    <div class="bg-gradient-to-r from-[#0f212e] to-[#1a2c38] rounded-xl p-4 border border-[#2f4553]">
                        <div class="text-white font-bold text-xl mb-3" id="freeCoinsTimer">Ready to Claim</div>
                        <button id="claimCoinsBtn" onclick="app.claimFreeCoins()" class="w-full btn-primary py-3 rounded-xl font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 touch-button">
                            Claim 500 Coins
                        </button>
                    </div>
                </div>
                
                <!-- Send Money Section -->
                <div class="border-t border-[#2f4553] pt-5 wallet-section">
                    <h3 class="text-white font-bold text-base mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-money-bill-transfer text-[#00e701] text-sm"></i>
                        Send Money
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-[#6b7280] font-bold mb-1 block tracking-wider">Recipient Username</label>
                            <input type="text" id="sendToUsername" placeholder="Enter username" class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] border border-[#2f4553] rounded-xl px-3 py-2.5 text-white focus:outline-none focus:border-[#00e701] transition-all duration-300 text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-[#6b7280] font-bold mb-1 block tracking-wider">Amount to Send</label>
                            <input type="number" id="sendAmount" placeholder="0" class="w-full bg-gradient-to-r from-[#0f212e] to-[#1a2c38] border border-[#2f4553] rounded-xl px-3 py-2.5 text-white focus:outline-none focus:border-[#00e701] transition-all duration-300 text-sm">
                        </div>
                        <button onclick="app.sendMoney()" class="w-full bg-gradient-to-r from-[#00e701] to-[#00c701] hover:from-[#00c701] hover:to-[#00b500] text-[#0f212e] py-3 rounded-xl font-bold text-sm tracking-wider transition-all duration-300 hover:scale-[1.02] touch-button">
                            <i class="fa-solid fa-paper-plane mr-1 text-xs"></i> Send Money
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Sound Effects
        const sounds = {
            win: new Audio('sounds/win.wav'),
            lose: new Audio('sounds/lose.wav'),
            click: new Audio('sounds/click.wav'),
            hop: new Audio('sounds/click.wav')
        };

        // Set volume for all sounds
        Object.values(sounds).forEach(sound => {
            sound.volume = 0.5;
            sound.preload = 'auto';
        });

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLmhwz-ocTNaZwWchcpWl3N0hJMlsskts",
            authDomain: "nebula-48dbd.firebaseapp.com",
            databaseURL: "https://nebula-48dbd-default-rtdb.firebaseio.com",
            projectId: "nebula-48dbd",
            storageBucket: "nebula-48dbd.firebasestorage.app",
            messagingSenderId: "259199297883",
            appId: "1:259199297883:web:f84fe6b2fc2ca70015d27e",
            measurementId: "G-38CB3Y2T56"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Chicken Road Game Configuration
        const CHICKEN_MULTIPLIERS = {
            easy: [],
            medium: [],
            hard: [],
            expert: []
        };

        // Populate multipliers for Chicken Road (same as before)
        for(let i=0; i<30; i++) CHICKEN_MULTIPLIERS.easy.push(1.02 * Math.pow(1.06, i+1));
        for(let i=0; i<30; i++) CHICKEN_MULTIPLIERS.medium.push(1.10 * Math.pow(1.17, i+1));
        for(let i=0; i<30; i++) CHICKEN_MULTIPLIERS.hard.push(1.20 * Math.pow(1.30, i+1));
        for(let i=0; i<30; i++) {
            let val = Math.pow(30000, (i+1)/30);
            if (val < 1.5 && i===0) val = 1.98;
            CHICKEN_MULTIPLIERS.expert.push(val);
        }

        const CHICKEN_HOUSE_EDGE = 0.02;

        class GameApp {
            constructor() {
                this.user = null;
                this.balance = 500; // Default, will be loaded from database
                this.username = '';
                this.userId = '';
                this.activeGame = null;
                this.mainContent = document.getElementById('mainContent');
                this.balanceDisplay = document.getElementById('balanceDisplay');
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOpen = false;
                this.chatSidebar = document.getElementById('chatSidebar');
                this.soundEnabled = true;
                this.lastFreeCoinsClaim = 0;
                this.bigWinThreshold = 1000;
                this.chatLoadedAt = null;
                this.liveWinsInterval = null;
                
                // Chicken Road state
                this.chickenState = {
                    isPlaying: false,
                    currentStep: -1,
                    difficulty: 'easy',
                    bet: 10,
                    currentMultiplier: 1.00,
                    gameActive: false,
                    // Real-time balance update
                    balanceUpdateListener: null
                };
                
                // Initialize app
                this.init();
            }

            init() {
                this.checkAuth();
                this.initChat();
                this.updateFreeCoinsButton();
                this.listenForBigWins();
                
                // Set default home page
                this.loadGame('home');
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 768 && this.sidebarOpen && 
                        !this.sidebar.contains(e.target) && 
                        !e.target.closest('[onclick*="toggleSidebar"]')) {
                        this.toggleSidebar();
                    }
                });
                
                // Prevent zoom on iOS
                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // Handle window resize
                window.addEventListener('resize', this.handleResize.bind(this));
                this.handleResize();
            }
            
            handleResize() {
                // Ensure proper scaling on mobile
                const viewport = document.querySelector('meta[name="viewport"]');
                if (window.innerWidth <= 768) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                } else {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
                }
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                const toggleBtn = document.getElementById('soundToggle');
                const icon = toggleBtn.querySelector('i');
                
                if (this.soundEnabled) {
                    toggleBtn.classList.remove('muted');
                    icon.className = 'fa-solid fa-volume-high';
                    this.showToast('Sound enabled', 'success');
                } else {
                    toggleBtn.classList.add('muted');
                    icon.className = 'fa-solid fa-volume-xmark';
                    this.showToast('Sound muted', 'warning');
                }
            }

            playSound(soundName) {
                if (!this.soundEnabled || !sounds[soundName]) return;
                
                try {
                    const soundClone = sounds[soundName].cloneNode();
                    soundClone.volume = sounds[soundName].volume;
                    soundClone.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Sound error:', e);
                }
            }

            toggleSidebar() {
                this.sidebarOpen = !this.sidebarOpen;
                if (window.innerWidth < 768) {
                    if (this.sidebarOpen) {
                        this.sidebar.classList.remove('-translate-x-full');
                        this.sidebar.classList.add('mobile-open');
                    } else {
                        this.sidebar.classList.add('-translate-x-full');
                        this.sidebar.classList.remove('mobile-open');
                    }
                }
            }

            toggleChat() {
                this.chatSidebar.classList.toggle('hidden');
                this.playSound('click');
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'} text-lg"></i>
                        <span class="font-medium text-sm">${message}</span>
                    </div>
                `;
                
                document.getElementById('toastContainer').appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            updateBalance() {
                if (this.balanceDisplay) {
                    this.balanceDisplay.textContent = this.balance.toLocaleString();
                    
                    // Update modal balance display
                    const modalBalance = document.getElementById('modalBalance');
                    if (modalBalance) {
                        modalBalance.textContent = this.balance.toLocaleString();
                    }
                    
                    // Animation effect
                    this.balanceDisplay.classList.add('text-[#00e701]', 'scale-110');
                    setTimeout(() => {
                        this.balanceDisplay.classList.remove('text-[#00e701]', 'scale-110');
                    }, 500);
                }
                
                // Save to database only
                if (this.userId && this.username) {
                    database.ref('users/' + this.userId + '/balance').set(this.balance);
                }
                
                // Update free coins button
                this.updateFreeCoinsButton();
            }

            // Setup real-time balance updates
            setupRealTimeBalance() {
                if (this.chickenState.balanceUpdateListener) {
                    // Remove existing listener
                    this.chickenState.balanceUpdateListener();
                }
                
                if (this.userId) {
                    // Listen for balance changes in real-time
                    const balanceRef = database.ref('users/' + this.userId + '/balance');
                    this.chickenState.balanceUpdateListener = balanceRef.on('value', (snapshot) => {
                        const newBalance = snapshot.val();
                        if (newBalance !== null && newBalance !== this.balance) {
                            this.balance = parseInt(newBalance);
                            this.updateBalance();
                            
                            // Update chicken UI if game is active
                            if (this.activeGame === 'chicken') {
                                this.updateChickenUI();
                            }
                        }
                    });
                }
            }

            // Auth Functions
            async checkAuth() {
                const savedUser = localStorage.getItem('moonCasinoUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        
                        // Check if user still exists in database
                        const userSnapshot = await database.ref('users/' + user.userId).once('value');
                        if (!userSnapshot.exists()) {
                            // Account was deleted or doesn't exist, log out
                            this.logout();
                            this.showToast('Account no longer exists', 'error');
                            return;
                        }
                        
                        const userData = userSnapshot.val();
                        this.userId = user.userId;
                        this.username = userData.username;
                        this.balance = parseInt(userData.balance) || 500;
                        this.lastFreeCoinsClaim = userData.lastFreeCoins || 0;
                        
                        this.updateUI();
                        this.hideAuthModal();
                        this.updateOnlineStatus();
                        this.setupRealTimeBalance();
                        
                    } catch (e) {
                        console.error('Auth error:', e);
                        this.showAuthModal();
                    }
                } else {
                    this.showAuthModal();
                }
            }

            showAuthModal() {
                document.getElementById('authModal').classList.add('active');
            }

            hideAuthModal() {
                document.getElementById('authModal').classList.remove('active');
            }

            showSignup() {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
                this.playSound('click');
            }

            showLogin() {
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                this.playSound('click');
            }

            async signup() {
                const username = document.getElementById('signupUsername').value.trim();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;

                if (!username || !email || !password) {
                    this.showToast('Please fill all fields', 'error');
                    return;
                }

                if (username.length < 3) {
                    this.showToast('Username must be at least 3 characters', 'error');
                    return;
                }

                // Check if username already exists
                const usernameSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
                if (usernameSnapshot.exists()) {
                    this.showToast('Username already taken', 'error');
                    return;
                }

                // Check if email already exists
                const emailSnapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
                if (emailSnapshot.exists()) {
                    this.showToast('Email already registered', 'error');
                    return;
                }

                // Create user
                const userId = 'user_' + Date.now();
                const userData = {
                    userId,
                    username,
                    email,
                    password: btoa(password),
                    balance: 500,
                    createdAt: Date.now(),
                    lastFreeCoins: 0,
                    totalWins: 0,
                    totalLosses: 0,
                    biggestWin: 0,
                    wageredToday: 0,
                    wageredWeek: 0,
                    wageredLifetime: 0,
                    wonToday: 0,
                    lastWagered: Date.now()
                };

                await database.ref('users/' + userId).set(userData);

                // Save locally (only for auto-login, balance comes from database)
                localStorage.setItem('moonCasinoUser', JSON.stringify({ userId, username }));

                this.userId = userId;
                this.username = username;
                this.balance = 500;
                this.lastFreeCoinsClaim = 0;

                this.updateUI();
                this.hideAuthModal();
                this.showToast('Welcome to Moon Casino! You received 500 starting coins!', 'success');
                this.playSound('win');
                this.updateOnlineStatus();
                this.setupRealTimeBalance();
                
                // Confetti for new user
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            async login() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                // Find user by email
                const snapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');

                if (!snapshot.exists()) {
                    this.showToast('User not found', 'error');
                    return;
                }

                let userFound = null;
                snapshot.forEach(child => {
                    const user = child.val();
                    if (atob(user.password) === password) {
                        userFound = user;
                    }
                });

                if (!userFound) {
                    this.showToast('Invalid password', 'error');
                    return;
                }

                // Save locally (only for auto-login, balance comes from database)
                localStorage.setItem('moonCasinoUser', JSON.stringify({
                    userId: userFound.userId,
                    username: userFound.username
                }));

                this.userId = userFound.userId;
                this.username = userFound.username;
                this.balance = userFound.balance || 500;
                this.lastFreeCoinsClaim = userFound.lastFreeCoins || 0;

                this.updateUI();
                this.hideAuthModal();
                this.showToast(`Welcome back ${this.username}!`, 'success');
                this.playSound('win');
                this.updateOnlineStatus();
                this.setupRealTimeBalance();
            }

            logout() {
                localStorage.removeItem('moonCasinoUser');
                this.userId = '';
                this.username = '';
                this.balance = 500;
                this.showAuthModal();
                this.updateUI();
                
                // Remove from online users
                if (this.userId) {
                    database.ref('online/' + this.userId).remove();
                }
                
                // Remove balance listener
                if (this.chickenState.balanceUpdateListener) {
                    this.chickenState.balanceUpdateListener();
                    this.chickenState.balanceUpdateListener = null;
                }
                
                this.showToast('Logged out successfully', 'warning');
            }

            updateUI() {
                document.getElementById('loggedUsername').textContent = this.username || 'Guest';
                document.getElementById('userIdDisplay').textContent = this.userId || 'Not logged in';
                document.getElementById('userAvatar').textContent = this.username ? this.username.charAt(0).toUpperCase() : 'U';
                this.updateBalance();
            }

            async updateOnlineStatus() {
                if (!this.userId) return;

                // Set user as online
                await database.ref('online/' + this.userId).set({
                    username: this.username,
                    lastSeen: Date.now()
                });

                // Remove after 2 minutes of inactivity
                setTimeout(() => {
                    database.ref('online/' + this.userId).remove();
                }, 120000);

                // Listen for online users
                database.ref('online').on('value', (snapshot) => {
                    const onlineCount = snapshot.numChildren();
                    document.getElementById('onlineCount').textContent = onlineCount + ' Online';
                });
            }

            // Wallet Functions
            openDepositModal() {
                if (!this.userId) {
                    this.showToast('Please login first', 'error');
                    return;
                }
                document.getElementById('depositModal').classList.add('active');
                this.updateFreeCoinsButton();
                
                // Update modal balance display
                document.getElementById('modalBalance').textContent = this.balance.toLocaleString();
                this.playSound('click');
            }

            closeDepositModal() {
                document.getElementById('depositModal').classList.remove('active');
                this.playSound('click');
            }

            updateFreeCoinsButton() {
                const claimButton = document.getElementById('claimCoinsBtn');
                const timerElement = document.getElementById('freeCoinsTimer');

                if (claimButton && timerElement) {
                    const canClaim = this.balance < 100;
                    
                    if (canClaim) {
                        timerElement.textContent = 'Ready to Claim';
                        claimButton.disabled = false;
                        claimButton.textContent = 'Claim 500 Coins';
                        claimButton.className = 'w-full btn-primary py-3 rounded-xl font-bold text-sm transition-all duration-300 hover:scale-[1.02] touch-button';
                    } else {
                        timerElement.textContent = 'Balance too high';
                        claimButton.disabled = true;
                        claimButton.textContent = 'Balance must be under 100';
                        claimButton.className = 'w-full bg-gray-700 text-gray-400 py-3 rounded-xl font-bold text-sm cursor-not-allowed touch-button';
                    }
                }
            }

            async claimFreeCoins() {
                if (!this.userId) return;

                // Check if balance is under 100
                if (this.balance >= 100) {
                    this.showToast('You must have less than 100 coins to claim', 'error');
                    return;
                }

                this.balance += 500;
                this.lastFreeCoinsClaim = Date.now();

                // Update in database
                if (this.username) {
                    await database.ref('users/' + this.userId).update({
                        balance: this.balance,
                        lastFreeCoins: this.lastFreeCoinsClaim
                    });
                }

                this.updateBalance();
                this.updateFreeCoinsButton();
                this.showToast('500 free coins claimed!', 'success');
                this.playSound('win');

                // Confetti effect
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }

            async sendMoney() {
                if (!this.userId) return;

                const recipientUsername = document.getElementById('sendToUsername').value.trim();
                const amount = parseFloat(document.getElementById('sendAmount').value);

                if (!recipientUsername || !amount) {
                    this.showToast('Please fill all fields', 'error');
                    return;
                }

                if (amount <= 0) {
                    this.showToast('Amount must be positive', 'error');
                    return;
                }

                if (amount > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                if (recipientUsername === this.username) {
                    this.showToast('Cannot send money to yourself', 'error');
                    return;
                }

                // Find recipient
                const snapshot = await database.ref('users').orderByChild('username').equalTo(recipientUsername).once('value');

                if (!snapshot.exists()) {
                    this.showToast('User not found', 'error');
                    return;
                }

                let recipientId = null;
                let recipient = null;
                snapshot.forEach(child => {
                    recipientId = child.key;
                    recipient = child.val();
                });

                if (!recipientId) {
                    this.showToast('User not found', 'error');
                    return;
                }

                // Update balances
                this.balance -= amount;
                const newRecipientBalance = (recipient.balance || 0) + amount;

                // Update in database
                await database.ref('users/' + this.userId + '/balance').set(this.balance);
                await database.ref('users/' + recipientId + '/balance').set(newRecipientBalance);

                this.updateBalance();
                this.showToast(`Sent ${amount} coins to ${recipientUsername}`, 'success');
                this.playSound('click');

                // Clear form
                document.getElementById('sendToUsername').value = '';
                document.getElementById('sendAmount').value = '';

                // Add transaction record
                const transaction = {
                    from: this.username,
                    to: recipientUsername,
                    amount: amount,
                    timestamp: Date.now(),
                    type: 'transfer'
                };

                await database.ref('transactions').push(transaction);

                // Add chat message
                this.addChatMessage('System', `${this.username} sent ${amount} coins to ${recipientUsername}!`, 'text-[#00e701]');
            }

            // Chat Functions
            initChat() {
                this.chatLoadedAt = Date.now();
                
                // Only listen for NEW messages from now on
                database.ref('chat').orderByChild('timestamp').startAt(this.chatLoadedAt).on('child_added', (snapshot) => {
                    const msg = snapshot.val();
                    if (msg.userId !== this.userId) { // Don't show own messages again
                        this.addChatMessage(msg.username, msg.message, 'text-white', false);
                    }
                });
                
                // Clear existing messages on init
                const messages = document.getElementById('chatMessages');
                if (messages) {
                    messages.innerHTML = '';
                }
            }

            addChatMessage(user, msg, color = 'text-white', saveToDB = true) {
                const messages = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = `flex gap-2 ${color} text-sm`;
                div.innerHTML = `
                    <span class="font-bold min-w-[70px] truncate">${user}:</span> 
                    <span class="flex-1">${msg}</span>
                `;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;

                if (saveToDB && this.userId) {
                    database.ref('chat').push({
                        username: user,
                        message: msg,
                        userId: this.userId,
                        timestamp: Date.now()
                    });
                }
            }

            sendChatMessage(e) {
                e.preventDefault();
                if (!this.userId) {
                    this.showToast('Please login to chat', 'error');
                    return;
                }

                const input = document.getElementById('chatInput');
                if (input && input.value.trim()) {
                    const msg = input.value.trim();
                    this.addChatMessage(this.username, msg, 'text-[#00e701]');
                    input.value = '';
                    this.playSound('click');
                }
            }

            // Record Wager for Leaderboard
            async recordWager(amount) {
                if (!this.userId || amount <= 0) return;

                const now = Date.now();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const weekAgo = now - (7 * 24 * 60 * 60 * 1000);

                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                let wageredToday = user.wageredToday || 0;
                let wageredWeek = user.wageredWeek || 0;
                
                // Reset today's wager if it's a new day
                if (user.lastWagered && user.lastWagered < today.getTime()) {
                    wageredToday = 0;
                }

                const updates = {
                    wageredToday: wageredToday + amount,
                    wageredWeek: wageredWeek + amount,
                    wageredLifetime: (user.wageredLifetime || 0) + amount,
                    lastWagered: now
                };

                await userRef.update(updates);
            }

            // Record Win/Loss
            async recordWin(amount, game) {
                if (!this.userId || amount <= 0) return;

                // Update user stats
                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let wonToday = user.wonToday || 0;
                
                // Reset today's win if it's a new day
                if (user.lastWin && user.lastWin < today.getTime()) {
                    wonToday = 0;
                }

                const updates = {
                    totalWins: (user.totalWins || 0) + 1,
                    biggestWin: Math.max(user.biggestWin || 0, amount),
                    wonToday: wonToday + amount,
                    lastWin: Date.now()
                };

                await userRef.update(updates);

                // Record transaction
                const transaction = {
                    userId: this.userId,
                    username: this.username,
                    amount: amount,
                    type: 'win',
                    game: game,
                    timestamp: Date.now()
                };

                await database.ref('transactions').push(transaction);

                // Announce big win in chat
                if (amount >= this.bigWinThreshold) {
                    this.addBigWinNotification(this.username, amount, game);
                    
                    // Also save as system message
                    this.addChatMessage('System', 
                        ` ${this.username} just won ${amount.toLocaleString()} coins in ${game}! `, 
                        'text-yellow-400', true);
                }
            }

            async recordLoss(amount, game) {
                if (!this.userId || amount <= 0) return;

                // Update user stats
                const userRef = database.ref('users/' + this.userId);
                const snapshot = await userRef.once('value');
                const user = snapshot.val();

                const updates = {
                    totalLosses: (user.totalLosses || 0) + 1
                };

                await userRef.update(updates);

                // Record transaction
                const transaction = {
                    userId: this.userId,
                    username: this.username,
                    amount: amount,
                    type: 'loss',
                    game: game,
                    timestamp: Date.now()
                };

                await database.ref('transactions').push(transaction);
            }

            addBigWinNotification(username, amount, game) {
                const messages = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = 'big-win-notification';
                div.innerHTML = `
                    <div class="flex items-center justify-center gap-2 mb-2">
                        <i class="fa-solid fa-trophy text-yellow-400 text-sm"></i>
                        <div class="username">${username}</div>
                        <i class="fa-solid fa-trophy text-yellow-400 text-sm"></i>
                    </div>
                    <div class="amount">${amount.toLocaleString()} coins</div>
                    <div class="text-gray-300 text-xs mt-1">won in ${game}!</div>
                `;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }

            listenForBigWins() {
                // Listen for big wins from other users
                database.ref('transactions').orderByChild('timestamp').startAt(Date.now()).on('child_added', (snapshot) => {
                    const transaction = snapshot.val();
                    
                    // Check if it's a big win from another user
                    if (transaction.type === 'win' && 
                        transaction.amount >= this.bigWinThreshold && 
                        transaction.userId !== this.userId) {
                        
                        // Add to chat with slight delay
                        setTimeout(() => {
                            this.addBigWinNotification(transaction.username, transaction.amount, transaction.game);
                        }, 1000);
                    }
                });
            }

            // Game Loading
            loadGame(gameName) {
                if (window.innerWidth < 768 && this.sidebarOpen) {
                    this.toggleSidebar();
                }

                // Update active nav
                document.querySelectorAll('#sidebar button').forEach(b => {
                    b.classList.remove('bg-gradient-to-r', 'from-[#2f4553]', 'to-[#1a2c38]', 'text-white');
                });
                const navBtn = document.getElementById(`nav-${gameName}`);
                if (navBtn) {
                    navBtn.classList.add('bg-gradient-to-r', 'from-[#2f4553]', 'to-[#1a2c38]', 'text-white');
                }

                this.activeGame = gameName;
                this.mainContent.innerHTML = '';
                this.mainContent.scrollTop = 0;

                switch (gameName) {
                    case 'home':
                        this.renderHome();
                        break;
                    case 'mines':
                        this.renderMines();
                        break;
                    case 'blackjack':
                        this.renderBlackjack();
                        break;
                    case 'chicken':
                        this.renderChickenRoad();
                        break;
                    case 'leaderboard':
                        this.renderLeaderboard();
                        break;
                    default:
                        this.renderHome();
                }
                
                this.playSound('click');
            }

            // HOME, MINES, BLACKJACK, and LEADERBOARD functions remain the same...
            // ... (keeping all your existing code for other games)

            // CHICKEN ROAD GAME - UPDATED TO MATCH STAKE STYLE
            renderChickenRoad() {
                this.chickenState.isPlaying = false;
                this.chickenState.currentStep = -1;
                this.chickenState.currentMultiplier = 1.00;

                this.mainContent.innerHTML = `
                    <div class="chicken-road-main">
                        <!-- Top Stats Bar -->
                        <div class="chicken-top-bar">
                            <div class="chicken-game-stats" id="chickenGameStats">
                                <div class="chicken-stat-box">
                                    <div class="chicken-stat-label">Current Multiplier</div>
                                    <div class="chicken-stat-value multiplier" id="chickenCurrentMult">1.00x</div>
                                </div>
                                <div class="chicken-stat-box">
                                    <div class="chicken-stat-label">Current Payout</div>
                                    <div class="chicken-stat-value" id="chickenCurrentPayout">0</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3 bg-[#1a2c38] px-4 py-2 rounded shadow-inner">
                                <span class="text-[#b1bad3] font-bold text-sm">Balance</span>
                                <span class="text-white font-bold text-lg tracking-wide" id="chickenBalanceDisplay">${this.balance.toLocaleString()}</span>
                                <button class="bg-[#1475e1] text-white text-xs px-3 py-1 rounded font-bold hover:bg-[#0f64c1]" onclick="app.openDepositModal()">Wallet</button>
                            </div>
                        </div>

                        <!-- Main Game Area -->
                        <div class="chicken-game-area">
                            <!-- Controls Sidebar -->
                            <div class="chicken-controls-sidebar">
                                <div class="chicken-controls-header">
                                    <div class="emoji"></div>
                                    <h2>CHICKEN ROAD</h2>
                                </div>

                                <!-- Bet Amount -->
                                <div class="chicken-control-group">
                                    <div class="flex justify-between">
                                        <label class="chicken-control-label">Bet Amount</label>
                                        <span class="text-xs text-[#b1bad3]">Max: ${this.balance.toLocaleString()}</span>
                                    </div>
                                    <div class="chicken-input-group">
                                        <input type="number" id="chickenBetInput" value="10" min="1" max="${this.balance}" class="chicken-bet-input">
                                        <div class="icon"></div>
                                    </div>
                                    <div class="chicken-quick-buttons">
                                        <button class="chicken-quick-button" onclick="app.adjustChickenBet(0.5)">1/2</button>
                                        <button class="chicken-quick-button" onclick="app.adjustChickenBet(2)">2x</button>
                                    </div>
                                </div>

                                <!-- Difficulty -->
                                <div class="chicken-control-group">
                                    <label class="chicken-control-label">Difficulty</label>
                                    <select id="chickenDifficulty" class="chicken-select" onchange="app.updateChickenDifficulty()">
                                        <option value="easy">Easy (Low Risk)</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                        <option value="expert">Expert (High Risk)</option>
                                    </select>
                                </div>

                                <!-- Stats Display -->
                                <div class="chicken-stats-box">
                                    <div class="chicken-stats-grid">
                                        <div>
                                            <div class="chicken-stat-label">Next Multiplier</div>
                                            <div class="chicken-stat-value multiplier" id="chickenNextMult">1.02x</div>
                                        </div>
                                        <div>
                                            <div class="chicken-stat-label">Steps Remaining</div>
                                            <div class="chicken-stat-value" id="chickenStepsRemaining">30</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Main Action Button -->
                                <div class="chicken-main-action">
                                    <button id="chickenActionBtn" onclick="app.handleChickenAction()" class="chicken-action-button">
                                        <i class="fa-solid fa-play mr-1"></i> Start Game
                                    </button>
                                    <div class="chicken-game-info">
                                        <p>Cross the road to win! Click on lanes to hop.</p>
                                        <p class="mt-1">House Edge: 2% | RTP: 98%</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Road Container -->
                            <div class="chicken-road-container">
                                <!-- Moving Camera Container -->
                                <div id="chickenRoadCamera" class="absolute inset-y-0 left-0 h-full flex items-center transition-transform duration-500 ease-out will-change-transform">
                                    <!-- Full World Container -->
                                    <div class="relative flex flex-col h-full w-max" id="chickenWorldContainer">
                                        <!-- TOP GRASS ENVIRONMENT -->
                                        <div class="h-24 min-h-[6rem] bg-green-600 grass-texture relative flex items-end overflow-hidden border-b-4 border-[#27ae60]" id="chickenEnvTop"></div>

                                        <!-- THE ROAD STRIP -->
                                        <div class="flex-1 relative flex items-stretch road-texture z-10 shadow-2xl">
                                            <div class="road-border-top"></div>
                                            
                                            <!-- Start Sidewalk (Left) -->
                                            <div class="w-48 bg-[#95a5a6] border-r-4 border-gray-500 sidewalk-texture flex flex-col items-center justify-center gap-12 z-20 shadow-[10px_0_20px_rgba(0,0,0,0.5)]" id="chickenSidewalkStart">
                                                <div class="text-5xl"></div>
                                                <div class="text-white font-black text-2xl text-center drop-shadow-md">START</div>
                                            </div>

                                            <!-- Lanes Container -->
                                            <div class="relative flex h-full z-10" id="chickenRoadContainer"></div>

                                            <!-- End Sidewalk (Right) -->
                                            <div class="w-64 bg-[#95a5a6] border-l-4 border-gray-500 sidewalk-texture flex flex-col items-center justify-center gap-8 z-20 shadow-[-10px_0_20px_rgba(0,0,0,0.5)]" id="chickenSidewalkEnd">
                                                <div class="text-6xl drop-shadow-xl"></div>
                                                <div class="text-white font-black text-3xl text-center drop-shadow-md">GOAL</div>
                                            </div>
                                            
                                            <div class="road-border-bottom"></div>
                                        </div>

                                        <!-- BOTTOM GRASS ENVIRONMENT -->
                                        <div class="h-24 min-h-[6rem] bg-green-600 grass-texture relative flex items-start overflow-hidden border-t-4 border-[#27ae60]" id="chickenEnvBottom"></div>
                                    </div>
                                </div>

                                <!-- Result Overlay -->
                                <div id="chickenResultOverlay" class="chicken-result-overlay">
                                    <div class="chicken-result-content">
                                        <div class="chicken-result-emoji" id="chickenResultEmoji"></div>
                                        <div class="chicken-result-title" id="chickenResultTitle">CRASHED!</div>
                                        <div class="chicken-result-subtitle" id="chickenResultSubtitle">Better luck next time</div>
                                        <div class="chicken-result-amount" id="chickenResultAmount">0 coins</div>
                                        <button onclick="app.closeChickenResult()" class="chicken-action-button">
                                            Play Again
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Initialize game
                this.updateChickenUI();
                this.updateChickenDifficulty();
                this.renderChickenEnvironment();
                this.renderChickenRoadLanes();
            }

            renderChickenEnvironment() {
                // Generate environment props
                this.generateEnvironment('chickenEnvTop', 40, 'top');
                this.generateEnvironment('chickenEnvBottom', 40, 'bottom');
                this.generateSidewalkProps('chickenSidewalkStart');
                this.generateSidewalkProps('chickenSidewalkEnd');
            }

            generateEnvironment(containerId, count, align = 'bottom') {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const trees = ['', '', '', ''];
                const rocks = ['', ''];
                const flowers = ['', '', '', ''];
                
                container.innerHTML = '';
                
                // Generate Ponds
                const pondCount = Math.floor(Math.random() * 5) + 3;
                
                for(let i=0; i<pondCount; i++) {
                    const pond = document.createElement('div');
                    pond.className = 'pond';
                    const size = Math.random() * 60 + 40;
                    pond.style.width = `${size}px`;
                    pond.style.height = `${size * 0.6}px`;
                    pond.style.left = `${Math.random() * 100}%`;
                    if(align === 'bottom') pond.style.top = `${Math.random() * 20}px`;
                    else pond.style.bottom = `${Math.random() * 20}px`;
                    container.appendChild(pond);
                }

                // Generate Props
                for(let i=0; i<count; i++) {
                    const el = document.createElement('div');
                    const type = Math.random();
                    if(type < 0.6) el.textContent = trees[Math.floor(Math.random() * trees.length)];
                    else if (type < 0.8) el.textContent = rocks[Math.floor(Math.random() * rocks.length)];
                    else el.textContent = flowers[Math.floor(Math.random() * flowers.length)];

                    el.style.position = 'absolute';
                    el.style.fontSize = (1.5 + Math.random()) + 'rem';
                    el.style.filter = 'drop-shadow(2px 4px 6px rgba(0,0,0,0.4))';
                    el.style.left = `${Math.random() * 100}%`;
                    
                    if (align === 'bottom') {
                        el.style.top = `${Math.random() * 10}px`;
                    } else {
                        el.style.bottom = `${Math.random() * 10}px`;
                        el.style.zIndex = '5';
                    }
                    
                    container.appendChild(el);
                }
            }
            
            generateSidewalkProps(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const props = ['', '', '', '', '', ''];
                const propsContainer = container.querySelector('.flex') || container;
                
                // Clear existing props
                const existingProps = propsContainer.querySelectorAll('div');
                existingProps.forEach(p => {
                    if (!p.classList.contains('text-5xl') && !p.classList.contains('text-6xl')) {
                        p.remove();
                    }
                });
                
                for(let i=0; i<5; i++) {
                    const el = document.createElement('div');
                    el.textContent = props[Math.floor(Math.random() * props.length)];
                    el.style.fontSize = '2rem';
                    el.style.marginBottom = '1rem';
                    propsContainer.appendChild(el);
                }
            }

            adjustChickenBet(factor) {
                if (this.chickenState.isPlaying) return;
                const betInput = document.getElementById('chickenBetInput');
                let val = parseFloat(betInput.value) * factor;
                if (val < 1) val = 1;
                if (val > this.balance) val = this.balance;
                betInput.value = Math.round(val);
                this.playSound('click');
            }

            updateChickenDifficulty() {
                if (this.chickenState.isPlaying) return;
                const difficulty = document.getElementById('chickenDifficulty').value;
                this.chickenState.difficulty = difficulty;
                this.updateChickenUI();
                this.renderChickenRoadLanes();
                this.playSound('click');
            }

            updateChickenUI() {
                const multipliers = CHICKEN_MULTIPLIERS[this.chickenState.difficulty];
                const nextMultiplier = multipliers[0] || 1.02;
                
                document.getElementById('chickenNextMult').textContent = nextMultiplier.toFixed(2) + 'x';
                document.getElementById('chickenCurrentMult').textContent = this.chickenState.currentMultiplier.toFixed(2) + 'x';
                
                const bet = parseFloat(document.getElementById('chickenBetInput')?.value) || 10;
                const potentialWin = (bet * this.chickenState.currentMultiplier).toFixed(0);
                document.getElementById('chickenCurrentPayout').textContent = potentialWin;
                
                const stepsRemaining = 30 - (this.chickenState.currentStep + 1);
                document.getElementById('chickenStepsRemaining').textContent = stepsRemaining;
                
                // Update action button
                const actionBtn = document.getElementById('chickenActionBtn');
                const balanceDisplay = document.getElementById('chickenBalanceDisplay');
                
                if (balanceDisplay) {
                    balanceDisplay.textContent = this.balance.toLocaleString();
                }
                
                if (this.chickenState.isPlaying) {
                    if (this.chickenState.currentStep === -1) {
                        actionBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> Game Starting...';
                        actionBtn.disabled = true;
                    } else {
                        const currentWin = (bet * this.chickenState.currentMultiplier).toFixed(0);
                        actionBtn.innerHTML = `<i class="fa-solid fa-money-bill-wave mr-1"></i> Cash Out ${currentWin}`;
                        actionBtn.disabled = false;
                    }
                    actionBtn.classList.remove('bg-gradient-to-r', 'from-[#00e701]', 'to-[#00c701]');
                    actionBtn.classList.add('bg-gradient-to-r', 'from-[#2f4553]', 'to-[#1a2c38]', 'text-[#b1bad3]');
                } else {
                    actionBtn.innerHTML = '<i class="fa-solid fa-play mr-1"></i> Start Game';
                    actionBtn.disabled = false;
                    actionBtn.classList.remove('bg-gradient-to-r', 'from-[#2f4553]', 'to-[#1a2c38]', 'text-[#b1bad3]');
                    actionBtn.classList.add('bg-gradient-to-r', 'from-[#00e701]', 'to-[#00c701]', 'text-[#0f212e]');
                }
                
                // Update bet input max value
                const betInput = document.getElementById('chickenBetInput');
                if (betInput) {
                    betInput.max = this.balance;
                    betInput.disabled = this.chickenState.isPlaying;
                }
                
                // Update difficulty select
                const difficultySelect = document.getElementById('chickenDifficulty');
                if (difficultySelect) {
                    difficultySelect.disabled = this.chickenState.isPlaying;
                }
            }

            handleChickenAction() {
                if (this.chickenState.isPlaying) {
                    this.chickenCashOut();
                } else {
                    this.startChickenGame();
                }
            }

            startChickenGame() {
                if (!this.userId) {
                    this.showToast('Please login to play', 'error');
                    return;
                }

                const betInput = document.getElementById('chickenBetInput');
                const bet = parseInt(betInput.value);

                if (isNaN(bet) || bet <= 0) {
                    this.showToast('Invalid bet amount', 'error');
                    return;
                }

                if (bet > this.balance) {
                    this.showToast('Insufficient funds', 'error');
                    return;
                }

                // Deduct bet
                this.balance -= bet;
                this.updateBalance();
                this.recordWager(bet);

                // Set game state
                this.chickenState.isPlaying = true;
                this.chickenState.bet = bet;
                this.chickenState.currentStep = -1;
                this.chickenState.currentMultiplier = 1.00;

                // Update UI
                this.updateChickenUI();
                this.renderChickenRoadLanes();

                this.showToast('Game started! Click lanes to cross the road.', 'success');
                this.playSound('click');
            }

            renderChickenRoadLanes() {
                const container = document.getElementById('chickenRoadContainer');
                if (!container) return;
                
                const multipliers = CHICKEN_MULTIPLIERS[this.chickenState.difficulty];
                
                container.innerHTML = '';
                
                // Set width for world container
                const worldContainer = document.getElementById('chickenWorldContainer');
                if (worldContainer) {
                    const totalWidth = (30 * 160) + 200 + 300;
                    worldContainer.style.width = `${totalWidth}px`;
                }

                // START TILE
                const startTile = document.createElement('div');
                startTile.className = `relative w-32 h-full flex flex-col items-center justify-center transition-all shrink-0 z-10 shadow-[10px_0_20px_rgba(0,0,0,0.2)]`;
                
                startTile.innerHTML = `
                    <div class="absolute right-0 top-0 bottom-0 w-2 bg-white/80 shadow-[0_0_10px_white]"></div>
                `;
                
                if (this.chickenState.currentStep === -1 && this.chickenState.isPlaying) {
                    startTile.innerHTML += `
                        <div class="absolute inset-0 bg-green-500/10 animate-pulse"></div>
                        <div class="text-6xl chicken-hop drop-shadow-2xl z-20 filter contrast-125"></div>
                        <div class="mt-4 text-xs font-bold text-white uppercase tracking-widest bg-black/50 px-2 py-1 rounded">Start</div>
                    `;
                } else if (this.chickenState.currentStep === -1 && !this.chickenState.isPlaying) {
                     startTile.innerHTML += `<div class="text-5xl opacity-50 grayscale filter contrast-75"></div>`;
                } else {
                     startTile.innerHTML += `<div class="text-4xl opacity-30"></div>`;
                }
                container.appendChild(startTile);

                // Generate 30 Vertical Lanes
                multipliers.forEach((mult, index) => {
                    const isPassed = index <= this.chickenState.currentStep;
                    const isNext = index === this.chickenState.currentStep + 1;
                    const isFuture = index > this.chickenState.currentStep + 1;

                    const tile = document.createElement('div');
                    let tileClass = `relative w-40 h-full flex flex-col items-center justify-center transition-all duration-300 lane-card shrink-0 overflow-hidden group `;
                    let content = '';

                    // Lane Number
                    content += `<div class="absolute top-2 left-2 text-[10px] text-white/20 font-bold tracking-widest px-1 rounded">LANE ${index+1}</div>`;

                    // TRAFFIC GENERATION FOR FUTURE & NEXT LANES
                    if ((isNext || isFuture) && this.chickenState.isPlaying) {
                        const carCount = 4;
                        const trafficContainer = document.createElement('div');
                        trafficContainer.className = "absolute inset-0 pointer-events-none z-0 overflow-hidden";
                        
                        const carColors = ['car-red', 'car-blue', 'car-yellow', 'car-white', 'car-black', 'car-green'];

                        for(let c=0; c<carCount; c++) {
                            const colorClass = carColors[Math.floor(Math.random() * carColors.length)];
                            const car = document.createElement('div');
                            car.className = "traffic-car";
                            car.innerHTML = `
                                <div class="car-model ${colorClass}">
                                    <div class="car-rear-window"></div>
                                    <div class="car-roof"></div>
                                    <div class="car-windshield"></div>
                                </div>
                            `;
                            
                            const minDuration = 1.2;
                            const maxDuration = 2.5;
                            const duration = minDuration + Math.random() * (maxDuration - minDuration);
                            const baseDelay = (c / carCount) * duration; 
                            const randomOffset = (Math.random() - 0.5) * 0.5;
                            const delay = Math.max(0, baseDelay + randomOffset);
                            
                            car.style.animationDuration = `${duration}s`;
                            car.style.animationDelay = `-${delay}s`;
                            
                            const wiggle = (Math.random() * 80) - 40; 
                            car.style.marginLeft = `${wiggle}px`;

                            trafficContainer.appendChild(car);
                        }
                        content += trafficContainer.outerHTML;
                    }

                    if (isPassed) {
                        // PASSED TILE
                        const isCurrent = index === this.chickenState.currentStep;
                        if (isCurrent && this.chickenState.isPlaying) {
                            tileClass += `z-20 shadow-[inset_0_0_80px_rgba(0,231,1,0.2)]`;
                            content += `
                                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-[#00e701]/10 to-transparent animate-pulse"></div>
                                <div class="text-6xl chicken-hop drop-shadow-2xl z-30 filter contrast-125"></div>
                                <div class="mt-6 text-[#00e701] font-black text-2xl drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)] bg-[#0f212e]/90 px-3 py-1 rounded border border-[#00e701] z-30">${mult.toFixed(2)}x</div>
                            `;
                        } else {
                            tileClass += `bg-black/10 opacity-60 grayscale-[0.3]`;
                            content += `<div class="text-[#00e701] font-bold text-xl opacity-60 drop-shadow-md"> ${mult.toFixed(2)}x</div>`;
                        }
                    } else if (isNext && this.chickenState.isPlaying) {
                        // NEXT ACTIVE TILE
                        tileClass += `hover:bg-white/5 cursor-pointer`;
                        const potentialWin = (this.chickenState.bet * mult).toFixed(0);
                        
                        content += `
                            <div class="relative z-20 flex flex-col items-center transition-transform duration-200 group-hover:scale-110">
                                <div class="text-white/90 font-black text-3xl drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] bg-black/40 rounded-lg px-3 py-1 mb-2 backdrop-blur-sm">${mult.toFixed(2)}x</div>
                                <div class="text-[#00e701] font-bold text-sm bg-black/80 px-3 py-1 rounded-full border border-[#00e701]/50 shadow-lg shadow-[#00e701]/20">Win ${potentialWin}</div>
                            </div>
                            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                            <div class="absolute bottom-4 text-[10px] text-white/50 uppercase font-bold tracking-widest animate-bounce">Tap to Hop</div>
                        `;
                        
                        tile.onclick = () => this.attemptChickenHop(index);
                    } else {
                        // FUTURE LOCKED
                        tileClass += `opacity-50 saturate-50 cursor-not-allowed`;
                        content += `
                            <div class="text-[#b1bad3] font-bold text-xl z-20 drop-shadow-md">${mult.toFixed(2)}x</div>
                        `;
                    }
                    
                    // Add the dashed separator
                    content += `<div class="lane-separator"></div>`;

                    tile.className = tileClass;
                    tile.innerHTML = content;
                    container.appendChild(tile);
                });
                
                // Update camera position
                this.updateChickenCamera();
            }
            
            updateChickenCamera() {
                const step = this.chickenState.currentStep;
                const laneWidth = 160;
                const startWidth = 128;
                const screenWidth = document.getElementById('chickenRoadContainer')?.parentElement?.clientWidth || window.innerWidth;
                
                let targetX = 0;
                
                if (step === -1) {
                    targetX = startWidth / 2;
                } else {
                    targetX = startWidth + (step * laneWidth) + (laneWidth / 2);
                }
                
                let translateX = (screenWidth / 2) - targetX;
                
                if (this.chickenState.isPlaying && step !== -1) {
                    translateX -= laneWidth * 0.3;
                }

                const camera = document.getElementById('chickenRoadCamera');
                if (camera) {
                    camera.style.transform = `translateX(${translateX}px)`;
                }
            }

            attemptChickenHop(targetStep) {
                if (!this.chickenState.isPlaying) return;
                if (targetStep !== this.chickenState.currentStep + 1) return;

                const multipliers = CHICKEN_MULTIPLIERS[this.chickenState.difficulty];
                const targetMultiplier = multipliers[targetStep];
                
                // Calculate probability of success
                const prevMult = targetStep === 0 ? 1.0 : multipliers[targetStep - 1];
                const probability = (prevMult / targetMultiplier) * (1 - CHICKEN_HOUSE_EDGE);
                const roll = Math.random();

                if (roll <= probability) {
                    this.successChickenHop(targetStep, targetMultiplier);
                } else {
                    this.crashChickenGame(targetStep);
                }
            }

            successChickenHop(step, multiplier) {
                this.chickenState.currentStep = step;
                this.chickenState.currentMultiplier = multiplier;
                
                // Play sound
                this.playSound('hop');
                
                // Update UI
                this.updateChickenUI();
                this.renderChickenRoadLanes();
                
                // Check if reached the end
                if (step === 29) {
                    setTimeout(() => {
                        this.chickenCashOut(true);
                    }, 500);
                }
            }

            crashChickenGame(failedStep) {
                this.chickenState.isPlaying = false;
                
                // Screen shake effect
                document.body.classList.add('shake-screen');
                setTimeout(() => document.body.classList.remove('shake-screen'), 500);
                
                // Record loss
                this.recordLoss(this.chickenState.bet, 'Chicken Road');
                
                // Show result
                setTimeout(() => {
                    this.showChickenResult(false, 0);
                }, 800);
                
                this.updateChickenUI();
                this.playSound('lose');
            }

            chickenCashOut(reachedEnd = false) {
                if (!this.chickenState.isPlaying) return;

                const winnings = this.chickenState.bet * this.chickenState.currentMultiplier;
                this.balance += winnings;
                this.chickenState.isPlaying = false;

                // Update balance and record win
                this.updateBalance();
                const profit = winnings - this.chickenState.bet;
                if (profit > 0) {
                    this.recordWin(profit, 'Chicken Road');
                }

                // Show result
                this.showChickenResult(true, winnings);
                this.updateChickenUI();
                
                // Play win sound and confetti for big wins
                if (profit >= 100) {
                    this.playSound('win');
                    if (profit >= this.bigWinThreshold) {
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                }
            }

            showChickenResult(win, amount) {
                const overlay = document.getElementById('chickenResultOverlay');
                const emoji = document.getElementById('chickenResultEmoji');
                const title = document.getElementById('chickenResultTitle');
                const subtitle = document.getElementById('chickenResultSubtitle');
                const amountEl = document.getElementById('chickenResultAmount');

                if (win) {
                    emoji.textContent = '';
                    title.textContent = 'YOU WON!';
                    title.className = 'chicken-result-title win';
                    subtitle.textContent = 'Successfully crossed the road!';
                    amountEl.textContent = `${amount.toFixed(0)} coins`;
                    amountEl.className = 'chicken-result-amount';
                    this.playSound('win');
                } else {
                    emoji.textContent = '';
                    title.textContent = 'CRASHED!';
                    title.className = 'chicken-result-title loss';
                    subtitle.textContent = 'The chicken didn\'t make it...';
                    amountEl.textContent = `Lost ${this.chickenState.bet} coins`;
                    amountEl.className = 'chicken-result-amount';
                    this.playSound('lose');
                }

                overlay.classList.add('active');
            }

            closeChickenResult() {
                const overlay = document.getElementById('chickenResultOverlay');
                overlay.classList.remove('active');
                
                // Reset game
                this.chickenState.isPlaying = false;
                this.chickenState.currentStep = -1;
                this.chickenState.currentMultiplier = 1.00;
                this.updateChickenUI();
                this.renderChickenRoadLanes();
                this.playSound('click');
            }

            // The rest of your existing code for other games...
            // ... (renderHome, renderMines, renderBlackjack, renderLeaderboard, etc.)

        }

        // Initialize the app
        const app = new GameApp();
    </script>
</body>
</html>
